# Milestone v1.0: P2P Multiplayer

**Status:** ✅ SHIPPED 2026-01-19
**Phases:** 1-6
**Total Plans:** 11

## Overview

This roadmap transformed the existing pseudo-P2P multiplayer system into true peer-to-peer with WebRTC DataChannels. The existing GGPO rollback netcode remained largely intact; the primary work was adding a P2P transport layer and integrating it with the existing input synchronization logic. The phases followed a foundation-first approach: establish WebRTC connections, build the message protocol, integrate with GGPO, add TURN fallback for NAT traversal, then validate and clean up legacy code.

## Phases

### Phase 1: WebRTC Foundation

**Goal**: Two browser clients can establish a direct WebRTC DataChannel connection via server-mediated signaling.
**Depends on**: Nothing (first phase)
**Requirements**: WEBRTC-01, WEBRTC-02
**Plans**: 2 plans

**Success Criteria:**
1. User A and User B can establish a WebRTC peer connection after server-mediated SDP exchange
2. A DataChannel opens between peers with unreliable/unordered configuration (ordered: false, maxRetransmits: 0)
3. Both peers can send and receive test messages over the DataChannel
4. ICE candidate exchange completes via SocketIO signaling

Plans:
- [x] 01-01-PLAN.md -- Server-side signaling handler + WebRTCManager class
- [x] 01-02-PLAN.md -- Integration into multiplayer game flow + verification

**Details:**
- Created WebRTCManager JavaScript class (387 lines)
- Added webrtc_signal SocketIO event handler
- Verified P2P connection in browser DevTools

---

### Phase 2: P2P Transport Layer

**Goal**: Game inputs flow directly between peers over the DataChannel with proper serialization and loss handling.
**Depends on**: Phase 1
**Requirements**: GGPO-02, GGPO-03
**Plans**: 3 plans

**Success Criteria:**
1. Input messages are serialized and sent over DataChannel with frame number and player ID
2. Each input packet includes the last N (3-5) inputs for redundancy against packet loss
3. Peers receive and correctly deserialize input messages from their counterpart
4. Keepalive/ping messages maintain connection awareness and measure RTT
5. Connection health is monitored (packet loss rate, latency)

Plans:
- [x] 02-01-PLAN.md -- Binary message encoding/decoding (input packets, ping/pong)
- [x] 02-02-PLAN.md -- P2P message receiving (RTTTracker, ConnectionHealthMonitor, handlers)
- [x] 02-03-PLAN.md -- P2P input sending with redundancy and ping interval

**Details:**
- 9-byte header + 5 bytes/input binary format
- RTTTracker with 10-sample sliding window
- P2PInputSender with redundancy count of 3

---

### Phase 3: GGPO P2P Integration

**Goal**: The existing GGPO rollback system uses P2P transport instead of server relay for input exchange.
**Depends on**: Phase 2
**Requirements**: GGPO-01, NPLAY-01
**Plans**: 1 plan

**Success Criteria:**
1. Two players can complete a full game session with inputs exchanged exclusively via P2P DataChannel
2. Neither peer acts as "host" -- both run symmetric simulations with identical input processing
3. Rollback and replay work correctly when remote inputs arrive late
4. State hash verification detects desyncs (if any occur)
5. SocketIO fallback activates if P2P connection fails during gameplay

Plans:
- [x] 03-01-PLAN.md -- Symmetric state sync, P2P metrics, fallback monitoring

**Details:**
- Both peers broadcast state hash for mutual verification
- P2P metrics tracking (inputsReceivedViaP2P, inputsReceivedViaSocketIO)
- Fallback triggered at 300ms latency or critical health status

---

### Phase 4: TURN and Resilience

**Goal**: Connections succeed even when direct P2P fails due to NAT configurations, with proper detection and logging.
**Depends on**: Phase 3
**Requirements**: WEBRTC-03, WEBRTC-04
**Plans**: 2 plans

**Success Criteria:**
1. TURN server credentials are configured and used when ICE direct connection fails
2. Connection type (direct vs relay) is detected via RTCPeerConnection.getStats()
3. Connection type is logged in session data for research analytics
4. Gameplay works correctly over TURN relay with acceptable latency
5. Connection quality degradation triggers appropriate warnings/fallbacks

Plans:
- [x] 04-01-PLAN.md -- TURN configuration, connection type detection, quality monitoring, ICE recovery
- [x] 04-02-PLAN.md -- Wire TURN credentials from server config to WebRTCManager (gap closure)

**Details:**
- Open Relay Project for TURN (free 20GB/month)
- Quality thresholds: 150ms/300ms (higher than Phase 2 to account for TURN)
- Max 3 ICE restart attempts

---

### Phase 5: Validation and Cleanup

**Goal**: Legacy host-based sync code is removed and the system is validated for research use.
**Depends on**: Phase 4
**Requirements**: CLEAN-01
**Plans**: 3 plans

**Success Criteria:**
1. Legacy "host client" election code is removed from P2P mode
2. Legacy server-relay input sync path is disabled when P2P is active
3. Research data collection captures connection type, rollback events, and sync status
4. Multiple game sessions can complete without silent desyncs
5. Documentation updated to reflect P2P architecture

Plans:
- [x] 05-01-PLAN.md -- Remove legacy host code (server + client)
- [x] 05-02-PLAN.md -- P2P-first input sending + research metrics
- [x] 05-03-PLAN.md -- Documentation update + validation checkpoint

**Details:**
- Renamed event to pyodide_player_assigned (symmetric)
- P2P-first input routing (SocketIO is fallback only)
- exportSessionMetrics() API for research data

---

### Phase 6: GGPO Input Queue Fix

**Goal**: Fix rollback divergence by implementing GGPO-style synchronous input processing - queue inputs during network reception, process all queued inputs at frame start before rollback.
**Depends on**: Phase 5
**Requirements**: GGPO-04
**Plans**: 1 plan

**Success Criteria:**
1. Incoming P2P inputs are queued rather than processed immediately
2. All queued inputs are processed synchronously at the start of each frame
3. Rollback executes as a tight synchronous loop without yielding to event loop
4. Games remain visually synchronized after rollbacks with artificial delay testing
5. No inputs are lost or missed during rollback replay

Plans:
- [x] 06-01-PLAN.md -- GGPO-style input queuing and synchronous rollback

**Details:**
Based on [GGPO Developer Guide](https://github.com/pond3r/ggpo/blob/master/doc/DeveloperGuide.md) best practices:
- `ggpo_idle()` processes network packets BEFORE frame step
- `ggpo_synchronize_inputs()` handles rollback synchronously
- Rollback must complete without yielding to event loop to prevent input race conditions

---

## Milestone Summary

**Key Decisions:**
- Native WebRTC API (no wrapper libraries) — full control, no dependencies
- Deterministic initiator (lower player ID) — prevents race conditions
- DataChannel unreliable/unordered — GGPO handles packet loss
- Binary protocol with redundancy — compact, handles 2 consecutive losses
- Symmetric state sync — mutual verification, no authority
- P2P-first with SocketIO fallback — minimizes server bandwidth
- GGPO-style input queuing — prevents replay race conditions
- Open Relay Project for TURN — free tier sufficient for research

**Issues Resolved:**
- WebRTC connection closed prematurely on episode reset
- Rollback divergence from async input processing during replay
- Episode start sync timeout (mitigated with retry mechanism)

**Technical Debt Incurred:**
- Rollback visual corrections cause brief teleporting (smoothing not implemented)
- N-player support deferred (2-player only)

---

*For current project status, see .planning/PROJECT.md*
