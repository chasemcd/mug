# v1.2 Participant Exclusion - Integration Check

**Date:** 2026-01-21
**Phases in Scope:** 15, 16, 17, 18
**Status:** PASS (All integrations verified)

---

## Wiring Summary

| Category | Count | Status |
|----------|-------|--------|
| Connected Exports | 12 | All properly wired |
| Orphaned Exports | 0 | None found |
| Missing Connections | 0 | None found |

## API Coverage

| Category | Count | Status |
|----------|-------|--------|
| Socket Events Consumed | 8 | All have consumers |
| Orphaned Routes | 0 | None |

## E2E Flows

| Flow | Status | Notes |
|------|--------|-------|
| Entry Screening | COMPLETE | Config -> client check -> pass/exclude |
| Mid-Game Exclusion | COMPLETE | Monitor -> warn -> exclude -> partner notify -> export |
| Custom Callbacks | COMPLETE | Both entry and continuous integrate with built-in rules |

---

## Phase Integration Details

### Phase 15 -> 16 Integration (Entry -> Continuous)

**Status:** CONNECTED

**Configuration Flow:**
```
GymScene (Python)
  |-- entry_screening() sets: device_exclusion, browser_requirements, max_ping, exclusion_messages
  |-- continuous_monitoring() sets: continuous_max_ping, continuous_ping_violation_window, etc.
  |-- get_complete_scene_metadata() serializes all attributes
  v
scene_metadata (JSON via Socket.IO)
  v
Client (JavaScript)
  |-- index.js: runEntryScreening(sceneMetadata) - uses entry screening config
  |-- pyodide_multiplayer_game.js: new ContinuousMonitor(data.scene_metadata) - uses continuous config
```

**Verified in Code:**
- `gym_scene.py` line 182-183: `continuous_monitoring_enabled: bool = False`
- `gym_scene.py` line 912-916: `get_complete_scene_metadata()` includes `has_entry_callback`, `has_continuous_callback`
- `pyodide_multiplayer_game.js` line 742-744: `if (data.scene_metadata?.continuous_monitoring_enabled) { this.continuousMonitor = new ContinuousMonitor(data.scene_metadata); }`

**No breaks detected.**

---

### Phase 16 -> 17 Integration (Continuous Monitor -> Multiplayer Exclusion)

**Status:** CONNECTED

**Event Flow:**
```
ContinuousMonitor (JS)
  |-- check() detects sustained_ping or tab_hidden
  v
_handleMidGameExclusion() (pyodide_multiplayer_game.js line 2816)
  |-- Emits 'mid_game_exclusion' socket event (line 2832)
  v
app.py @socketio.on('mid_game_exclusion') (line 1299)
  |-- Calls PYODIDE_COORDINATOR.handle_player_exclusion()
  v
handle_player_exclusion() (pyodide_game_coordinator.py line 554)
  |-- Emits 'partner_excluded' to partner
  |-- Emits 'trigger_data_export' to partner
  |-- eventlet.sleep(0.1) for delivery
  |-- Cleans up game
```

**Verified Socket Events:**
1. Client emits `mid_game_exclusion` (pyodide_multiplayer_game.js:2832)
2. Server handles `mid_game_exclusion` (app.py:1299-1337)
3. Server emits `partner_excluded` (pyodide_game_coordinator.py:592-600)
4. Client handles `partner_excluded` (pyodide_multiplayer_game.js:1056-1075)
5. Server emits `trigger_data_export` (pyodide_game_coordinator.py:605-612)
6. Client handles `trigger_data_export` (pyodide_multiplayer_game.js:1079-1096)

**No breaks detected.**

---

### Phase 17 -> Export Integration (Partial Session Marking)

**Status:** CONNECTED

**Data Flow:**
```
Mid-game exclusion occurs
  |
  v
sessionPartialInfo set (pyodide_multiplayer_game.js)
  |-- isPartial: true
  |-- terminationReason: 'sustained_ping' | 'tab_hidden' | 'partner_exclusion' | 'custom_callback'
  |-- terminationFrame: this.frameNumber
  v
emitMultiplayerMetrics() (pyodide_multiplayer_game.js:4877)
  |-- Includes sessionStatus object in metrics
  v
Server @socketio.on('emit_multiplayer_metrics') (app.py:838)
  |-- Saves to data/{scene_id}/{subject_id}_multiplayer_metrics.json
  |-- Creates aggregated metrics when both players submit
```

**Verified in Code:**
- `pyodide_multiplayer_game.js` line 693: `this.sessionPartialInfo = null;` (initialized)
- `pyodide_multiplayer_game.js` line 1081-1085: Partner sets sessionPartialInfo on `trigger_data_export`
- `pyodide_multiplayer_game.js` line 2846-2850: Excluded player sets sessionPartialInfo
- `pyodide_multiplayer_game.js` line 4864-4868: `sessionStatus` included in exported metrics

**No breaks detected.**

---

### Phase 18 Integration (Custom Callbacks)

**Status:** CONNECTED

#### Entry Callback Flow:
```
GymScene.exclusion_callbacks(entry_callback=fn)
  |-- Sets self.entry_exclusion_callback
  |-- Metadata: has_entry_callback = True
  v
startGymScene() (index.js)
  |-- await runEntryScreening(sceneMetadata)
  |-- Checks sceneMetadata.has_entry_callback
  |-- If true, calls executeEntryCallback()
  v
executeEntryCallback() (index.js:163-200)
  |-- Emits 'execute_entry_callback' socket event
  |-- Waits for 'entry_callback_result' response
  v
Server @socketio.on('execute_entry_callback') (app.py:1340-1401)
  |-- Gets scene from stager
  |-- Executes scene.entry_exclusion_callback(context)
  |-- Emits 'entry_callback_result'
```

**Verified:**
- `gym_scene.py` line 192: `self.entry_exclusion_callback: Callable | None = None`
- `gym_scene.py` line 914: `metadata["has_entry_callback"] = self.entry_exclusion_callback is not None`
- `index.js` line 140-150: Checks `sceneMetadata.has_entry_callback` and calls executeEntryCallback
- `app.py` line 1340-1401: Server handler executes callback

#### Continuous Callback Flow:
```
ContinuousMonitor (JS)
  |-- shouldExecuteCallback() returns true every N frames
  v
_executeContinuousCallback() (pyodide_multiplayer_game.js:2869)
  |-- Emits 'execute_continuous_callback' socket event
  v
Server @socketio.on('execute_continuous_callback') (app.py:1404-1466)
  |-- Executes scene.continuous_exclusion_callback(context)
  |-- Emits 'continuous_callback_result'
  v
Client socket.on('continuous_callback_result') (pyodide_multiplayer_game.js:1100)
  |-- continuousMonitor.setCallbackResult(data)
  v
Next ContinuousMonitor.check() processes result
```

**Verified:**
- `continuous_monitor.js` line 72-74: `this.hasCallback`, `callbackIntervalFrames`, `callbackPending`
- `continuous_monitor.js` line 191-203: `shouldExecuteCallback()` method
- `pyodide_multiplayer_game.js` line 1752-1754: Calls `shouldExecuteCallback()` and `_executeContinuousCallback()`
- `pyodide_multiplayer_game.js` line 1100-1105: `continuous_callback_result` listener
- `app.py` line 1404-1466: Server handler

**No breaks detected.**

---

## Export/Import Verification

### ContinuousMonitor Module

| From | Export | Imported By | Used |
|------|--------|-------------|------|
| continuous_monitor.js | ContinuousMonitor class | pyodide_multiplayer_game.js (line 17) | Yes (line 743) |

### GymScene Methods (Python)

| Method | Config Serialized | Client Usage |
|--------|-------------------|--------------|
| entry_screening() | device_exclusion, browser_requirements, browser_blocklist, max_ping, min_ping_measurements, exclusion_messages | index.js runEntryScreening() |
| continuous_monitoring() | continuous_max_ping, continuous_ping_violation_window, continuous_ping_required_violations, continuous_tab_warning_ms, continuous_tab_exclude_ms, continuous_monitoring_enabled, continuous_exclusion_messages | pyodide_multiplayer_game.js ContinuousMonitor constructor |
| exclusion_callbacks() | has_entry_callback, has_continuous_callback, continuous_callback_interval_frames | index.js (entry), continuous_monitor.js (continuous) |

---

## Socket Event Coverage

| Event | Emitter | Handler | Purpose |
|-------|---------|---------|---------|
| mid_game_exclusion | Client (JS) | Server (app.py:1299) | Player excluded by continuous monitor |
| partner_excluded | Server (coordinator) | Client (JS:1056) | Notify partner of exclusion |
| trigger_data_export | Server (coordinator) | Client (JS:1079) | Request partner data export |
| execute_entry_callback | Client (JS) | Server (app.py:1340) | Run researcher entry callback |
| entry_callback_result | Server (app.py) | Client (JS:179) | Return entry callback decision |
| execute_continuous_callback | Client (JS) | Server (app.py:1404) | Run researcher continuous callback |
| continuous_callback_result | Server (app.py) | Client (JS:1100) | Return continuous callback decision |
| emit_multiplayer_metrics | Client (JS) | Server (app.py:838) | Export session metrics |

**All events have both emitters and handlers. No orphaned events.**

---

## E2E Flow Traces

### Flow 1: Entry Screening (Pass)

```
1. [Python] GymScene.entry_screening(device_exclusion="mobile", browser_requirements=["Chrome"])
2. [Python] get_complete_scene_metadata() includes all config
3. [Socket] activate_scene emits scene_metadata to client
4. [JS] startGymScene(data) receives metadata
5. [JS] runEntryScreening(sceneMetadata) runs:
   a. ua-parser-js detects device/browser
   b. Checks device_exclusion -> PASS
   c. Checks browser_blocklist -> PASS
   d. Checks browser_requirements -> PASS
   e. Checks has_entry_callback -> if true, executeEntryCallback()
6. [JS] Returns { passed: true }
7. [JS] Game initialization continues
```

**VERIFIED COMPLETE**

### Flow 2: Entry Screening (Fail - Custom Callback)

```
1. [Python] GymScene.exclusion_callbacks(entry_callback=reject_prior_participants)
2. [JS] runEntryScreening() built-in checks pass
3. [JS] executeEntryCallback() emits 'execute_entry_callback'
4. [Server] handle_execute_entry_callback runs reject_prior_participants(context)
5. [Server] Returns {"exclude": True, "message": "Already participated"}
6. [Socket] entry_callback_result sent to client
7. [JS] Returns { passed: false, failedRule: 'custom_callback', message: "..." }
8. [JS] showExclusionMessage() displays message
```

**VERIFIED COMPLETE**

### Flow 3: Mid-Game Exclusion (Ping)

```
1. [JS] Game loop running at 30fps
2. [JS] continuousMonitor.recordPing(window.currentPing) called each frame
3. [JS] Every 30 frames, continuousMonitor.check() runs
4. [JS] _checkPing() detects 3 consecutive violations > threshold
5. [JS] Returns { exclude: true, reason: 'sustained_ping', message: "..." }
6. [JS] _handleMidGameExclusion('sustained_ping', message) called
7. [JS] this.state = "done", game loop stops
8. [JS] _showMidGameExclusionUI(message) shows overlay
9. [JS] socket.emit('mid_game_exclusion', {...})
10. [Server] handle_mid_game_exclusion() receives event
11. [Server] PYODIDE_COORDINATOR.handle_player_exclusion() called
12. [Server] Emits 'partner_excluded' to partner
13. [Server] Emits 'trigger_data_export' to partner
14. [Partner JS] socket.on('partner_excluded') -> stops game, shows UI
15. [Partner JS] socket.on('trigger_data_export') -> sets sessionPartialInfo, calls emitMultiplayerMetrics()
16. [Excluded JS] Sets own sessionPartialInfo, calls emitMultiplayerMetrics()
17. [Server] eventlet.sleep(0.1), then cleans up game
18. [Server] Saves metrics with sessionStatus.isPartial = true
```

**VERIFIED COMPLETE**

### Flow 4: Continuous Custom Callback

```
1. [Python] GymScene.exclusion_callbacks(continuous_callback=attention_check, continuous_callback_interval_frames=60)
2. [JS] ContinuousMonitor initialized with hasCallback=true, callbackIntervalFrames=60
3. [JS] Game loop at 30fps, every frame:
   a. recordPing(ping)
   b. If frame % 30 == 0: check()
   c. If frame % 60 == 0: shouldExecuteCallback() returns true
4. [JS] _executeContinuousCallback() emits 'execute_continuous_callback' with context
5. [Server] handle_execute_continuous_callback() runs attention_check(context)
6. [Server] Returns {"warn": true, "message": "Please stay focused"}
7. [Socket] continuous_callback_result sent to client
8. [JS] continuousMonitor.setCallbackResult(data)
9. [JS] Next check() reads callbackResult, returns { warn: true, message: "..." }
10. [JS] _showMonitorWarning(message) displays banner
```

**VERIFIED COMPLETE**

---

## Detailed Findings

### Orphaned Exports

**None found.** All exports from Phases 15-18 are imported and used.

### Missing Connections

**None found.** All expected inter-phase connections are present.

### Broken Flows

**None found.** All E2E flows verified to be complete.

### Unprotected Routes

**N/A** - Phases 15-18 are client-side screening, not route protection.

---

## Conclusion

**All v1.2 Participant Exclusion integrations verified.**

The four phases (15-18) form a cohesive system:
1. Entry screening (15) properly passes config to client
2. Continuous monitoring (16) properly triggers multiplayer exclusion handling (17)
3. Multiplayer exclusion (17) properly notifies partners and triggers data export
4. Custom callbacks (18) properly integrate with both entry (15) and continuous (16) flows

No integration issues or broken wiring detected.
