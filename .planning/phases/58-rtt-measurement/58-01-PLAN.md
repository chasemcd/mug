---
phase: 58-rtt-measurement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/probe_connection.js
  - interactive_gym/server/static/js/index.js
autonomous: true

must_haves:
  truths:
    - "Probe sends configurable number of pings (default 5)"
    - "RTT calculated from ping-pong round trips over DataChannel"
    - "Measurement handles packet loss with timeout + retry per ping"
    - "Measurement result (median RTT) returned to matchmaker via on_complete"
  artifacts:
    - path: "interactive_gym/server/static/js/probe_connection.js"
      provides: "measureRTT() method with ping-pong protocol"
      contains: "measureRTT"
    - path: "interactive_gym/server/static/js/index.js"
      provides: "ProbeManager calls measureRTT instead of getRTT"
      contains: "measureRTT"
  key_links:
    - from: "ProbeManager._onProbeConnected"
      to: "ProbeConnection.measureRTT"
      via: "async method call"
      pattern: "measureRTT\\("
    - from: "ProbeConnection.measureRTT"
      to: "DataChannel"
      via: "ping-pong messages"
      pattern: "dataChannel\\.send"
---

# 58-01: RTT Ping-Pong Protocol

Implement reliable RTT measurement between matched candidates using application-level ping-pong messages over the WebRTC DataChannel.

## Objective

Replace the single `getStats()` measurement with a proper ping-pong protocol that:
- Sends N configurable pings over DataChannel
- Measures round-trip time for each ping/pong
- Handles packet loss with per-ping timeout and retry
- Returns median RTT for stable measurement

## Context

**Current Problem (Phase 57):**
The existing `getRTT()` uses WebRTC's `getStats()` API which provides `currentRoundTripTime` from the selected ICE candidate pair. This is:
1. A single measurement (not multiple pings)
2. Based on STUN keepalives, not application-level data
3. May not be accurate immediately after connection

**Solution:**
Application-level ping-pong protocol over DataChannel:
- Send timestamped "ping" messages
- Peer echoes back "pong" with same timestamp
- Calculate RTT from delta
- Repeat N times, return median

**Key Files from Phase 57:**
- `probe_connection.js`: ProbeConnection class wraps WebRTCManager
- `index.js`: ProbeManager handles probe lifecycle (prepare -> start -> result)
- Current flow: connect -> wait 500ms -> call getRTT() -> report result

## Tasks

<task id="1">
<title>Add DataChannel message handlers to ProbeConnection</title>
<what>
Add onmessage handler to ProbeConnection that processes ping/pong messages over the DataChannel.

Message format (JSON for simplicity, small enough that binary is overkill):
- Ping: `{"type": "ping", "seq": N, "ts": timestamp_ms}`
- Pong: `{"type": "pong", "seq": N, "ts": original_timestamp_ms}`

Implementation:
1. In `_setupCallbacks()`, add DataChannel message handler
2. On "ping" message received: immediately send back "pong" with same seq and ts
3. On "pong" message received: calculate RTT, resolve pending measurement Promise
4. Store pending measurements in a Map keyed by seq number
</what>
<why>
DataChannel message handling is the foundation for ping-pong protocol. Both sides need to respond to pings and process pongs.
</why>
<files>interactive_gym/server/static/js/probe_connection.js</files>
<acceptance>
- ProbeConnection has onMessage handler for DataChannel
- Receiving ping sends pong with same seq/ts
- Receiving pong resolves pending measurement
</acceptance>
</task>

<task id="2">
<title>Implement measureRTT method with configurable pings</title>
<what>
Add `measureRTT(options)` method to ProbeConnection that performs multiple ping measurements and returns median RTT.

Parameters:
- `numPings`: Number of pings to send (default 5)
- `pingTimeout`: Timeout per ping in ms (default 2000)
- `pingInterval`: Delay between pings in ms (default 100)

Implementation:
1. Create `measureRTT({ numPings = 5, pingTimeout = 2000, pingInterval = 100 })` async method
2. For each ping (up to numPings):
   a. Send ping message with seq and timestamp
   b. Wait for pong OR timeout
   c. If timeout, log warning but continue to next ping
   d. If pong received, record RTT
3. After all pings, calculate median of successful measurements
4. Return median RTT (or null if all pings failed)

Helper method `_sendPing(seq)`:
- Returns Promise that resolves with RTT or rejects on timeout
- Sends ping JSON over DataChannel
- Stores resolver in pendingPings Map
- Sets timeout to reject after pingTimeout ms
</what>
<why>
Multiple measurements with median provide stable RTT estimate. Per-ping timeout handles packet loss gracefully. Configurable parameters allow tuning for different network conditions.
</why>
<files>interactive_gym/server/static/js/probe_connection.js</files>
<acceptance>
- measureRTT() sends numPings ping messages
- Each ping has per-ping timeout
- Packet loss (timeout) doesn't fail entire measurement
- Returns median of successful RTTs
- Returns null if all pings fail
</acceptance>
</task>

<task id="3">
<title>Update ProbeManager to use measureRTT</title>
<what>
Replace the single `getRTT()` call in ProbeManager._onProbeConnected with `measureRTT()`.

Changes to `_onProbeConnected`:
1. Remove 500ms stabilization delay (not needed with proper ping-pong)
2. Call `this.activeProbe.measureRTT()` instead of `getRTT()`
3. Log measurement details (numPings attempted, successful, median RTT)

The probe_result event already sends rtt_ms and success - no changes needed there.
</what>
<why>
measureRTT() provides reliable application-level RTT measurement. The stabilization delay was a workaround for getStats() - proper ping-pong doesn't need it.
</why>
<files>interactive_gym/server/static/js/index.js</files>
<acceptance>
- ProbeManager calls measureRTT() after connection
- No hardcoded 500ms delay before measurement
- RTT result logged with measurement details
- probe_result event sent with median RTT
</acceptance>
</task>

## Verification

1. **Unit verification** - Console logs show ping-pong protocol working:
   ```
   [Probe probe_xxx] Sending ping seq=0
   [Probe probe_xxx] Received pong seq=0, RTT=45ms
   [Probe probe_xxx] Sending ping seq=1
   ...
   [Probe probe_xxx] Measurement complete: 5/5 pings, median RTT=47ms
   ```

2. **Integration verification** - Start two browser tabs, trigger probe:
   - Both tabs connect and create ProbeConnection
   - Ping-pong messages exchanged over DataChannel
   - probe_result event received by server with median RTT

3. **Packet loss handling** - Simulate by adding artificial delay:
   - If a ping times out, measurement continues with remaining pings
   - Final result uses median of successful pings only

## Success Criteria

- [ ] ProbeConnection has DataChannel message handler for ping/pong
- [ ] measureRTT() sends configurable number of pings (default 5)
- [ ] Each ping has independent timeout (default 2000ms)
- [ ] Packet loss (timeout) doesn't fail entire measurement
- [ ] Median RTT returned to matchmaker via on_complete callback
- [ ] Console logs show ping-pong protocol execution

## Output

After completion, create `.planning/phases/58-rtt-measurement/58-01-SUMMARY.md`
