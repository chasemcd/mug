---
phase: 14-validation-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "JSON export available after game ends"
    - "Export contains only confirmed-frame hashes (no predictions)"
    - "Export includes all desync events with full context"
    - "Export includes verified action sequences per player"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "exportValidationData() method"
      exports: ["exportValidationData"]
  key_links:
    - from: "exportValidationData()"
      to: "confirmedHashHistory"
      via: "reads confirmed hash Map"
      pattern: "confirmedHashHistory"
    - from: "exportValidationData()"
      to: "desyncEvents"
      via: "reads desync array"
      pattern: "desyncEvents"
    - from: "exportValidationData()"
      to: "inputBuffer"
      via: "reads confirmed inputs"
      pattern: "inputBuffer"
---

<objective>
Create post-game JSON export with frame-by-frame validation data including confirmed hashes, verified actions, and desync events.

Purpose: Enable researchers to analyze sync validation results offline, identify determinism issues, and verify that both peers executed identical action sequences.

Output: `exportValidationData()` method that returns comprehensive JSON suitable for research analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-mismatch-detection/13-01-SUMMARY.md
@interactive_gym/server/static/js/pyodide_multiplayer_game.js (lines 4155-4260 for existing export methods)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exportValidationData method</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add `exportValidationData()` method to MultiplayerPyodideGame class (near existing export methods ~line 4195).

The method should return a structured JSON object containing:

```javascript
exportValidationData() {
    return {
        // Session identification
        gameId: this.gameId,
        playerId: this.myPlayerId,
        exportTimestamp: Date.now(),

        // Sync summary
        summary: {
            totalFrames: this.frameNumber,
            verifiedFrame: this.verifiedFrame,
            desyncCount: this.desyncEvents.length,
            hashesComputed: this.confirmedHashHistory.size
        },

        // Frame-by-frame confirmed hashes (EXPORT-01, EXPORT-02)
        confirmedHashes: this._exportConfirmedHashes(),

        // Verified action sequences per player (EXPORT-04)
        verifiedActions: this._exportVerifiedActions(),

        // All desync events with full context (EXPORT-03)
        desyncEvents: this.desyncEvents.map(evt => ({
            frame: evt.frame,
            ourHash: evt.ourHash,
            peerHash: evt.peerHash,
            timestamp: evt.timestamp,
            verifiedFrameAtDesync: evt.verifiedFrameAtDesync,
            // Include state dump only if present and not too large
            hasStateDump: !!evt.stateDump
        }))
    };
}
```

Key requirements:
- Export ONLY confirmed-frame data (from confirmedHashHistory, not stateHashHistory)
- Include desync events with all context (frame, hashes, timestamp)
- Export verified actions (actions for frames up to verifiedFrame)
- Return plain JS object (caller can JSON.stringify)
  </action>
  <verify>
Method exists: Search for "exportValidationData" in file
Method returns object with required keys: summary, confirmedHashes, verifiedActions, desyncEvents
  </verify>
  <done>exportValidationData() method returns structured validation data object</done>
</task>

<task type="auto">
  <name>Task 2: Add helper methods for export data extraction</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add two private helper methods near exportValidationData():

1. `_exportConfirmedHashes()` - Extract hash data from confirmedHashHistory:

```javascript
_exportConfirmedHashes() {
    // Convert Map to sorted array of {frame, hash} objects
    const hashes = [];
    for (const [frame, hash] of this.confirmedHashHistory.entries()) {
        hashes.push({ frame, hash });
    }
    // Sort by frame number for consistent output
    return hashes.sort((a, b) => a.frame - b.frame);
}
```

2. `_exportVerifiedActions()` - Extract confirmed actions per player up to verifiedFrame:

```javascript
_exportVerifiedActions() {
    // Build per-player action sequences from inputBuffer
    // Only include frames up to verifiedFrame (mutually confirmed)
    const result = {};
    const humanPlayerIds = this._getHumanPlayerIds();

    for (const playerId of humanPlayerIds) {
        result[playerId] = [];
    }

    // Get frames in sorted order
    const frames = Array.from(this.inputBuffer.keys())
        .filter(f => f <= this.verifiedFrame)
        .sort((a, b) => a - b);

    for (const frame of frames) {
        const frameInputs = this.inputBuffer.get(frame);
        if (frameInputs) {
            for (const playerId of humanPlayerIds) {
                const action = frameInputs.get(playerId);
                if (action !== undefined) {
                    result[playerId].push({ frame, action });
                }
            }
        }
    }

    return result;
}
```

Requirements:
- _exportConfirmedHashes: Sort by frame number, return array of {frame, hash}
- _exportVerifiedActions: Only frames <= verifiedFrame, organized by player ID
- Both methods should handle empty data gracefully (return empty array/object)
  </action>
  <verify>
Search for "_exportConfirmedHashes" and "_exportVerifiedActions" in file
Both methods referenced from exportValidationData()
  </verify>
  <done>Helper methods extract confirmed hashes and verified actions from internal data structures</done>
</task>

<task type="auto">
  <name>Task 3: Add validation export to episode end flow</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Update `_handleEpisodeEnd()` method to include validation export in debug logging.

Find the existing code around line 2606-2611 that exports session metrics:
```javascript
// Full session metrics only in debug mode
if (getLogLevel() >= LOG_LEVELS.debug) {
    const sessionMetrics = this.exportSessionMetrics();
    p2pLog.debug('Session metrics:', JSON.stringify(sessionMetrics, null, 2));
}
```

Add validation export immediately after:
```javascript
// Validation data export for sync analysis
if (getLogLevel() >= LOG_LEVELS.debug) {
    const validationData = this.exportValidationData();
    p2pLog.debug('Validation export:', JSON.stringify(validationData, null, 2));

    // Log summary at info level always
    p2pLog.info(
        `Sync validation: ${validationData.summary.verifiedFrame}/${validationData.summary.totalFrames} frames verified, ` +
        `${validationData.summary.desyncCount} desyncs, ${validationData.summary.hashesComputed} hashes`
    );
}
```

Also expose via window for manual export:
In constructor or init, after `window.game = this;` (if exists), the game is already exposed.
The exportValidationData() method is automatically accessible via `window.game.exportValidationData()`.

Add a JSDoc comment to exportValidationData() documenting this:
```javascript
/**
 * Export validation data for sync analysis.
 * Call at episode end or from browser console: window.game.exportValidationData()
 * Returns JSON-serializable object with confirmed hashes, verified actions, and desyncs.
 * @returns {Object} Validation data for research analysis
 */
```
  </action>
  <verify>
`npm run build` succeeds (if build exists) or file has no syntax errors
Search for "exportValidationData" in _handleEpisodeEnd
Validation summary logged at episode end
  </verify>
  <done>Validation export logged at episode end, accessible via window.game.exportValidationData()</done>
</task>

</tasks>

<verification>
1. Syntax check: File has no JavaScript syntax errors
2. Method exists: `exportValidationData` method present in class
3. Helper methods: `_exportConfirmedHashes` and `_exportVerifiedActions` present
4. Episode integration: Validation export called in `_handleEpisodeEnd`
5. Requirements coverage:
   - EXPORT-01: confirmedHashes array contains frame-by-frame hashes
   - EXPORT-02: Only confirmed data (from confirmedHashHistory, not stateHashHistory)
   - EXPORT-03: desyncEvents array with full context
   - EXPORT-04: verifiedActions object with per-player sequences
</verification>

<success_criteria>
- exportValidationData() returns object with: summary, confirmedHashes, verifiedActions, desyncEvents
- confirmedHashes contains only confirmed-frame hashes (not predicted)
- verifiedActions contains only actions up to verifiedFrame
- desyncEvents includes all mismatch events from Phase 13
- Validation summary logged at info level on episode end
- Method accessible via window.game.exportValidationData() for manual export
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-export/14-01-SUMMARY.md`
</output>
