---
phase: 97-python-surface-core
plan: 02
type: execute
wave: 2
depends_on: ["97-01"]
files_modified:
  - mug/rendering/surface.py
  - mug/rendering/__init__.py
autonomous: true
requirements:
  - SURF-01
  - SURF-02
  - SURF-03
  - SURF-04
  - SURF-05
  - SURF-06
  - SURF-07
  - SURF-08
  - SURF-09
  - SURF-10
  - COORD-01
  - COORD-02
  - IDENT-01
  - IDENT-03
  - DELTA-01
  - DELTA-02
  - DELTA-03
  - DELTA-04

must_haves:
  truths:
    - "User can call surface.rect(), surface.circle(), surface.line(), surface.polygon(), surface.text(), surface.image(), surface.arc(), and surface.ellipse() to add draw commands to a frame"
    - "surface.commit() returns a RenderPacket with game_state_objects list and removed list"
    - "Draw methods accept any color format (tuple, hex, named) via normalize_color integration"
    - "Pixel coordinates are converted to relative (0-1) in wire format; relative=True passes through as-is"
    - "persistent=True requires id= parameter (raises ValueError if missing)"
    - "Persistent objects are only retransmitted when changed; unchanged persistent objects produce empty delta"
    - "surface.remove(id='name') marks a persistent object for removal in the next commit"
    - "surface.reset() clears all internal state so persistent objects are retransmitted in the next episode"
    - "Ephemeral objects are cleared after commit(); next commit without new draws returns empty objects list"
    - "Optional id= and tween_duration= parameters work on all draw methods"
    - "border_radius= parameter works on rect() for rounded rectangles"
    - "stroke_color= and stroke_width= parameters work on rect, circle, and polygon for outlines"
  artifacts:
    - path: "mug/rendering/surface.py"
      provides: "Surface class with all draw methods and delta engine"
      exports: ["Surface"]
      min_lines: 200
    - path: "mug/rendering/__init__.py"
      provides: "Updated exports including Surface"
      contains: "from .surface import Surface"
  key_links:
    - from: "mug/rendering/surface.py"
      to: "mug/rendering/color.py"
      via: "normalize_color called in every draw method"
      pattern: "normalize_color"
    - from: "mug/rendering/surface.py"
      to: "mug/rendering/types.py"
      via: "DrawCommand created per draw call, RenderPacket returned from commit"
      pattern: "DrawCommand|RenderPacket"
    - from: "mug/rendering/__init__.py"
      to: "mug/rendering/surface.py"
      via: "re-export of Surface"
      pattern: "from .surface import Surface"
---

<objective>
Implement the Surface class with all draw methods, coordinate handling, persistence model, delta computation, commit(), reset(), and remove().

Purpose: This is the core user-facing API. Researchers interact exclusively with Surface to build render frames. The draw methods, coordinate conversion, and delta engine must all work correctly for the API to be useful.
Output: `mug/rendering/surface.py` with complete Surface class; updated `__init__.py` with Surface export
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/97-python-surface-core/97-RESEARCH.md
@.planning/phases/97-python-surface-core/97-CONTEXT.md
@.planning/phases/97-python-surface-core/97-01-SUMMARY.md
@mug/configurations/object_contexts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Surface class with all draw methods and coordinate handling</name>
  <files>mug/rendering/surface.py</files>
  <action>
Create `mug/rendering/surface.py` with the `Surface` class.

**Constructor:**
```python
class Surface:
    def __init__(self, width: int, height: int):
        self.width = width
        self.height = height
        self._ephemeral_buffer: list[DrawCommand] = []
        self._persistent_current: dict[str, DrawCommand] = {}
        self._committed_persistent: dict[str, dict] = {}
        self._pending_removals: set[str] = set()
```

**Internal helpers:**
- `_build_command(object_type, *, id=None, persistent=False, relative=False, depth=0, tween_duration=None, **params) -> DrawCommand`:
  - If `persistent=True` and `id` is None: raise `ValueError("persistent=True requires an id= parameter")`
  - If `id` is None: auto-generate with `uuid.uuid4().hex[:8]`
  - Store `relative`, `depth`, `tween_duration` in params dict
  - Return `DrawCommand(object_type=object_type, id=id, params=params, persistent=persistent)`
- `_add_command(cmd: DrawCommand)`:
  - If `cmd.persistent`: store in `self._persistent_current[cmd.id]`
  - Else: append to `self._ephemeral_buffer`
- `_to_wire(cmd: DrawCommand) -> dict`:
  - Convert DrawCommand to wire-format dict with keys: `uuid`, `object_type`, `depth`, `tween`, `tween_duration`, `permanent`, plus all type-specific params
  - `uuid` = `cmd.id`, `permanent` = `cmd.persistent`, `tween` = `True if tween_duration is not None else False`
  - Convert coordinates to relative (0-1) using `self.width` and `self.height`:
    - For pixel coords (relative=False): divide x by width, y by height
    - For relative coords (relative=True): pass through
    - Handle per-type coordinate fields:
      - rect: x, y, w, h (divide w by width, h by height)
      - circle: x, y, radius (divide radius by max(width, height) to preserve aspect)
      - line/polygon: convert each point in points list
      - text: x, y
      - image/sprite: x, y, w, h
      - arc: x, y, radius
      - ellipse: x, y, rx, ry (divide rx by width, ry by height)
  - Include `stroke_color` and `stroke_width` in wire dict if present in params
  - Include `border_radius` in wire dict if present in params (for rect)

**Draw methods (all keyword-only after self):**

Each method: normalize color(s) via `normalize_color()`, build command, add command. All accept optional `id=None`, `persistent=False`, `relative=False`, `depth=0`, `tween_duration=None`.

1. `rect(*, x, y, w, h, color='white', border_radius=None, stroke_color=None, stroke_width=None, **common)`:
   - Normalize `color`. If `stroke_color` is not None, normalize it too.
   - SURF-01, SURF-07, SURF-10

2. `circle(*, x, y, radius, color='white', stroke_color=None, stroke_width=None, **common)`:
   - Center-origin (x, y is center). SURF-02, SURF-07

3. `line(*, points, color='white', width=1, **common)`:
   - `points` is list of (x, y) tuples. SURF-03

4. `polygon(*, points, color='white', stroke_color=None, stroke_width=None, **common)`:
   - `points` is list of (x, y) tuples. SURF-04, SURF-07

5. `text(*, text, x, y, size=16, color='black', font='Arial', **common)`:
   - SURF-05

6. `image(*, image_name, x, y, w, h, frame=None, angle=None, **common)`:
   - Top-left origin. Maps to object_type "sprite" in wire format. SURF-06

7. `arc(*, x, y, radius, start_angle, end_angle, color='white', **common)`:
   - SURF-08

8. `ellipse(*, x, y, rx, ry, color='white', **common)`:
   - SURF-09

The `**common` kwargs are unpacked and passed to `_build_command` as `id=`, `persistent=`, `relative=`, `depth=`, `tween_duration=`.
  </action>
  <verify>
Run:
```bash
python -c "
from mug.rendering.surface import Surface
s = Surface(800, 600)
s.rect(x=100, y=200, w=50, h=30, color='red')
s.circle(x=400, y=300, radius=25, color=(0, 255, 0))
s.line(points=[(0,0),(100,100)], color='#00f')
s.polygon(points=[(0,0),(50,0),(25,50)], color='blue')
s.text(text='Hello', x=10, y=10, size=24, color='white')
s.image(image_name='player', x=0, y=0, w=64, h=64)
s.arc(x=100, y=100, radius=50, start_angle=0, end_angle=3.14, color='yellow')
s.ellipse(x=200, y=200, rx=30, ry=20, color='cyan')
print('all draw methods OK')
"
```
Must print "all draw methods OK" without errors.
  </verify>
  <done>
All 8 draw methods (rect, circle, line, polygon, text, image, arc, ellipse) accept keyword arguments, normalize colors, and store DrawCommands. Optional id=, persistent=, relative=, depth=, tween_duration= work on all methods. border_radius works on rect. stroke_color/stroke_width work on rect, circle, polygon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement commit(), reset(), remove(), and update __init__.py</name>
  <files>
    mug/rendering/surface.py
    mug/rendering/__init__.py
  </files>
  <action>
Add the following methods to the Surface class in `mug/rendering/surface.py`:

**`commit() -> RenderPacket`:**
1. Initialize `objects = []` and `removed = list(self._pending_removals)`
2. All ephemeral objects always included: iterate `self._ephemeral_buffer`, call `self._to_wire(cmd)` for each, append to objects
3. Persistent objects — only include if new or changed:
   - For each `(obj_id, cmd)` in `self._persistent_current.items()`:
     - `wire = self._to_wire(cmd)`
     - `prev = self._committed_persistent.get(obj_id)`
     - If `prev is None or prev != wire`: append wire to objects, update `self._committed_persistent[obj_id] = wire`
4. Process removals: for each id in `self._pending_removals`, `self._committed_persistent.pop(obj_id, None)` and `self._persistent_current.pop(obj_id, None)`
5. Clear frame state: `self._ephemeral_buffer.clear()`, `self._pending_removals.clear()`
6. Return `RenderPacket(objects=objects, removed=removed)`

Note: Do NOT clear `_persistent_current` — persistent objects remain drawn until explicitly removed. Only the ephemeral buffer is cleared.

**`remove(id: str)`:**
- Add `id` to `self._pending_removals` set
- This will cause the id to appear in the `removed` list of the next `commit()` and be cleared from `_committed_persistent` and `_persistent_current`

**`reset()`:**
- Clear ALL internal state: `self._ephemeral_buffer.clear()`, `self._persistent_current.clear()`, `self._committed_persistent.clear()`, `self._pending_removals.clear()`
- After reset, persistent objects will be retransmitted because `_committed_persistent` is empty

**Update `mug/rendering/__init__.py`:**
- Uncomment or add `from .surface import Surface`
- Ensure the public API is: `Surface, RenderPacket, normalize_color, NAMED_COLORS`
  </action>
  <verify>
Run:
```bash
python -c "
from mug.rendering import Surface, RenderPacket

# Test basic commit
s = Surface(800, 600)
s.rect(x=100, y=200, w=50, h=30, color='red')
pkt = s.commit()
assert isinstance(pkt, RenderPacket)
assert len(pkt.objects) == 1
assert pkt.objects[0]['object_type'] == 'rect'
assert pkt.objects[0]['uuid'] is not None
assert pkt.removed == []
print('basic commit OK')

# Test ephemeral cleared after commit
pkt2 = s.commit()
assert len(pkt2.objects) == 0, f'Expected 0 objects after empty commit, got {len(pkt2.objects)}'
print('ephemeral clear OK')

# Test persistent stays
s.rect(x=0, y=0, w=100, h=100, color='green', id='bg', persistent=True)
pkt3 = s.commit()
assert len(pkt3.objects) == 1
pkt4 = s.commit()
assert len(pkt4.objects) == 0, 'Unchanged persistent should not retransmit'
print('persistent delta OK')

# Test persistent change detection
s.rect(x=10, y=0, w=100, h=100, color='green', id='bg', persistent=True)
pkt5 = s.commit()
assert len(pkt5.objects) == 1, 'Changed persistent should retransmit'
print('persistent change OK')

# Test remove
s.remove(id='bg')
pkt6 = s.commit()
assert 'bg' in pkt6.removed
print('remove OK')

# Test reset
s.rect(x=0, y=0, w=100, h=100, color='blue', id='floor', persistent=True)
s.commit()
s.reset()
s.rect(x=0, y=0, w=100, h=100, color='blue', id='floor', persistent=True)
pkt7 = s.commit()
assert len(pkt7.objects) == 1, 'After reset, persistent should retransmit'
print('reset OK')

# Test persistent requires id
try:
    s.rect(x=0, y=0, w=10, h=10, color='red', persistent=True)
    assert False, 'Should have raised ValueError'
except ValueError:
    print('persistent validation OK')

print('ALL TESTS PASSED')
"
```
Must print "ALL TESTS PASSED".
  </verify>
  <done>
- `commit()` returns RenderPacket with wire-format objects and removed IDs
- Ephemeral objects cleared after commit; second commit without new draws returns empty objects
- Persistent objects only retransmitted when changed (delta computation works)
- `remove()` adds id to removed list in next commit
- `reset()` clears all state; persistent objects retransmitted after reset
- `persistent=True` without `id=` raises ValueError
- `from mug.rendering import Surface, RenderPacket` works
  </done>
</task>

</tasks>

<verification>
1. All 8 draw methods callable with keyword args
2. Color normalization works in draw methods (tuple, hex, named)
3. `commit()` returns RenderPacket with `to_dict()` producing `game_state_objects` key
4. Wire format uses relative (0-1) coordinates even when pixel coords passed
5. Persistent objects: sent once, not resent when unchanged, resent when changed
6. `remove()` produces correct `removed` list
7. `reset()` causes full retransmission
8. `persistent=True` without `id=` raises ValueError
9. `from mug.rendering import Surface` works
</verification>

<success_criteria>
- Surface class is fully functional with all 8 draw methods
- Delta computation correctly identifies new, changed, unchanged, and removed persistent objects
- Wire format is backward-compatible (uses `uuid`, `object_type`, `permanent` keys matching existing JS renderer)
- Coordinate conversion from pixel to relative works correctly
- All verify commands pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/97-python-surface-core/97-02-SUMMARY.md`
</output>
