---
phase: 97-python-surface-core
plan: 03
type: tdd
wave: 3
depends_on: ["97-02"]
files_modified:
  - tests/unit/test_rendering_color.py
  - tests/unit/test_rendering_surface.py
autonomous: true
requirements:
  - SURF-01
  - SURF-02
  - SURF-03
  - SURF-04
  - SURF-05
  - SURF-06
  - SURF-07
  - SURF-08
  - SURF-09
  - SURF-10
  - COLOR-01
  - COLOR-02
  - COLOR-03
  - COLOR-04
  - COORD-01
  - COORD-02
  - IDENT-01
  - IDENT-03
  - DELTA-01
  - DELTA-02
  - DELTA-03
  - DELTA-04

must_haves:
  truths:
    - "Color normalization handles RGB tuples, hex strings, shorthand hex, and 20 named colors"
    - "Color normalization rejects invalid input with clear error messages"
    - "All 8 draw methods produce correct wire-format objects via commit()"
    - "Pixel coordinates are converted to relative (0-1) in wire format"
    - "relative=True passes coordinates through unchanged"
    - "Persistent objects are sent once and not resent when unchanged"
    - "Changed persistent objects are resent"
    - "surface.remove() produces correct removed list"
    - "surface.reset() causes full retransmission across 3+ sequential episodes"
    - "persistent=True without id= raises ValueError"
    - "border_radius, stroke_color, stroke_width appear in wire format when provided"
    - "tween_duration produces tween=True in wire format"
  artifacts:
    - path: "tests/unit/test_rendering_color.py"
      provides: "Comprehensive color normalization tests"
      min_lines: 60
    - path: "tests/unit/test_rendering_surface.py"
      provides: "Comprehensive Surface class tests"
      min_lines: 150
  key_links:
    - from: "tests/unit/test_rendering_color.py"
      to: "mug/rendering/color.py"
      via: "imports and tests normalize_color"
      pattern: "from mug.rendering.color import normalize_color"
    - from: "tests/unit/test_rendering_surface.py"
      to: "mug/rendering/surface.py"
      via: "imports and tests Surface"
      pattern: "from mug.rendering import Surface"
---

<objective>
Write comprehensive unit tests for the color normalization utility and the Surface class, following TDD RED-GREEN-REFACTOR cycle.

Purpose: Validate every requirement in Phase 97 through automated tests. These tests serve as the definitive proof that the Surface API works correctly and will catch regressions during Phase 98/99 development.
Output: Two test files covering all 22 phase requirements
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/97-python-surface-core/97-RESEARCH.md
@.planning/phases/97-python-surface-core/97-CONTEXT.md
@.planning/phases/97-python-surface-core/97-02-SUMMARY.md
@mug/rendering/surface.py
@mug/rendering/color.py
@mug/rendering/types.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD color normalization tests</name>
  <files>tests/unit/test_rendering_color.py</files>
  <action>
Create `tests/unit/test_rendering_color.py` with pytest tests for `normalize_color()`.

**Test cases (RED phase — write all tests first, then verify they pass against Plan 01/02 implementation):**

Since Plan 01 and 02 will have already been executed, write the tests and immediately verify GREEN.

```python
import pytest
from mug.rendering.color import normalize_color, NAMED_COLORS
```

**COLOR-01: RGB tuples**
- `normalize_color((255, 0, 0))` == `'#ff0000'`
- `normalize_color((0, 255, 0))` == `'#00ff00'`
- `normalize_color((0, 0, 255))` == `'#0000ff'`
- `normalize_color((0, 0, 0))` == `'#000000'`
- `normalize_color((255, 255, 255))` == `'#ffffff'`
- `normalize_color((128, 128, 128))` == `'#808080'`

**COLOR-01 error cases:**
- `normalize_color((256, 0, 0))` raises ValueError (out of range)
- `normalize_color((-1, 0, 0))` raises ValueError (negative)
- `normalize_color((255, 0))` raises ValueError (too few elements)
- `normalize_color((255, 0, 0, 128))` raises ValueError (too many — RGBA not supported)
- `normalize_color((1.0, 0, 0))` raises ValueError (floats not allowed)

**COLOR-02: Hex strings**
- `normalize_color('#FF0000')` == `'#ff0000'` (uppercase normalized to lowercase)
- `normalize_color('#ff0000')` == `'#ff0000'` (already lowercase)
- `normalize_color('#abc')` == `'#aabbcc'` (shorthand expansion)
- `normalize_color('#ABC')` == `'#aabbcc'` (shorthand uppercase)
- `normalize_color('#000')` == `'#000000'`

**COLOR-02 error cases:**
- `normalize_color('#xyz')` raises ValueError
- `normalize_color('#12345')` raises ValueError (5 chars)
- `normalize_color('FF0000')` raises ValueError (missing #)
- `normalize_color('')` raises ValueError

**COLOR-03: Named colors**
- Test all 20 NAMED_COLORS entries: `normalize_color(name) == NAMED_COLORS[name]`
- `normalize_color('RED')` == `normalize_color('red')` (case insensitive)
- `normalize_color(' red ')` == `'#ff0000'` (whitespace trimmed)

**COLOR-03 error cases:**
- `normalize_color('notacolor')` raises ValueError

**COLOR-04: Type errors**
- `normalize_color(255)` raises TypeError (int, not tuple)
- `normalize_color([255, 0, 0])` raises TypeError (list, not tuple)
- `normalize_color(None)` raises TypeError

**NAMED_COLORS dict:**
- Assert len(NAMED_COLORS) >= 20
- Assert all values match `#[0-9a-f]{6}` pattern
  </action>
  <verify>
Run `python -m pytest tests/unit/test_rendering_color.py -v` — all tests must pass.
  </verify>
  <done>
All color normalization tests pass. Coverage includes RGB tuples, hex strings (full and shorthand), named colors, error cases for bad input, and type error cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD Surface class tests</name>
  <files>tests/unit/test_rendering_surface.py</files>
  <action>
Create `tests/unit/test_rendering_surface.py` with pytest tests for the Surface class.

```python
import pytest
from mug.rendering import Surface, RenderPacket
```

**SURF-01 through SURF-10: Draw methods produce correct wire format**

For each draw method, test that:
- Calling the method and then `commit()` returns a RenderPacket with 1 object
- The object has the correct `object_type` in wire format
- The object has the expected params in wire format

Specific tests:
- `test_rect_basic`: rect(x=100, y=200, w=50, h=30, color='red') -> object_type='rect', color='#ff0000', coordinates are relative
- `test_circle_basic`: circle(x=400, y=300, radius=25, color=(0,255,0)) -> object_type='circle', color='#00ff00'
- `test_line_basic`: line(points=[(0,0),(800,600)], color='#fff') -> object_type='line', points converted to relative
- `test_polygon_basic`: polygon(points=[(0,0),(100,0),(50,100)], color='blue') -> object_type='polygon'
- `test_text_basic`: text(text='Hello', x=10, y=10, size=24, color='white') -> object_type='text'
- `test_image_basic`: image(image_name='player', x=0, y=0, w=64, h=64) -> object_type='sprite' (image maps to sprite wire format)
- `test_arc_basic`: arc(x=100, y=100, radius=50, start_angle=0, end_angle=3.14) -> object_type='arc'
- `test_ellipse_basic`: ellipse(x=200, y=200, rx=30, ry=20) -> object_type='ellipse'
- `test_rect_border_radius`: rect with border_radius=10 -> wire dict contains border_radius=10
- `test_rect_stroke`: rect with stroke_color='black', stroke_width=2 -> wire dict contains both
- `test_circle_stroke`: circle with stroke_color='red', stroke_width=1 -> wire dict contains both
- `test_polygon_stroke`: polygon with stroke_color='blue', stroke_width=3 -> wire dict contains both

**COORD-01 and COORD-02: Coordinate handling**
- `test_pixel_coords_converted`: Surface(800,600), rect(x=400, y=300) -> wire x=0.5, y=0.5
- `test_relative_coords_passthrough`: rect(x=0.5, y=0.5, w=0.1, h=0.1, relative=True) -> wire x=0.5, y=0.5
- `test_mixed_coords_in_one_frame`: one rect with pixel, one with relative=True, both correct in wire format
- `test_line_points_converted`: line points converted from pixel to relative
- `test_polygon_points_converted`: polygon points converted from pixel to relative

**IDENT-01: Optional id parameter**
- `test_auto_id`: draw without id= -> wire dict has a uuid (auto-generated, non-empty string)
- `test_explicit_id`: draw with id='myobj' -> wire dict uuid='myobj'
- `test_unique_auto_ids`: two draws without id= -> different uuids

**IDENT-03: Tween duration**
- `test_tween_duration_sets_tween_true`: draw with tween_duration=100 -> wire dict has tween=True, tween_duration=100
- `test_no_tween_by_default`: draw without tween_duration -> wire dict has tween=False

**DELTA-01: Persistence**
- `test_persistent_object_stays`: draw persistent, commit, commit again -> second commit has 0 objects (already sent)
- `test_ephemeral_object_gone`: draw ephemeral, commit -> second commit has 0 objects
- `test_persistent_requires_id`: persistent=True without id= raises ValueError

**DELTA-02: Delta computation**
- `test_unchanged_persistent_empty_delta`: draw persistent, commit, redraw identical persistent, commit -> second commit has 0 objects
- `test_changed_persistent_retransmits`: draw persistent, commit, redraw with different color, commit -> second commit has 1 object
- `test_mixed_ephemeral_persistent`: draw both, commit -> both in objects; draw only ephemeral, commit -> only ephemeral in objects

**DELTA-03: Tracking**
- `test_committed_state_tracks`: draw persistent, commit -> _committed_persistent has the object
- (Implementation detail test, but important for correctness)

**DELTA-04: Reset**
- `test_reset_clears_everything`: draw persistent, commit, reset -> internal state empty
- `test_reset_causes_retransmission`: draw persistent, commit, reset, redraw same persistent, commit -> object in commit (because tracking cleared)
- `test_reset_across_3_episodes`: Simulate 3 episodes:
  1. Draw persistent bg + ephemeral ball, commit (both sent)
  2. reset(), draw same persistent bg + new ephemeral ball, commit (bg retransmitted because tracking cleared)
  3. reset(), draw same persistent bg + new ephemeral ball, commit (bg retransmitted again)
  Assert each commit has the persistent object (because reset cleared tracking each time).

**Remove:**
- `test_remove_in_next_commit`: draw persistent 'obj', commit, remove('obj'), commit -> second commit.removed contains 'obj'
- `test_remove_nonexistent_no_error`: remove('doesnotexist'), commit -> removed list contains 'doesnotexist', no error

**RenderPacket serialization:**
- `test_to_dict_format`: commit result's to_dict() has 'game_state_objects' and 'removed' keys

**Multiple objects:**
- `test_multiple_objects_in_frame`: draw 5 different objects, commit -> 5 objects in RenderPacket
- `test_depth_in_wire`: draw with depth=5 -> wire dict contains depth=5
  </action>
  <verify>
Run `python -m pytest tests/unit/test_rendering_surface.py -v` — all tests must pass.
Run `python -m pytest tests/unit/test_rendering_color.py tests/unit/test_rendering_surface.py -v` — full suite passes.
  </verify>
  <done>
All Surface class tests pass. Coverage spans all 22 phase requirements: 8 draw methods, color integration, coordinate conversion, identity, tween duration, persistence, delta computation, remove, reset (including 3-episode validation), and RenderPacket serialization.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/unit/test_rendering_color.py -v` — all pass
2. `python -m pytest tests/unit/test_rendering_surface.py -v` — all pass
3. Combined run: `python -m pytest tests/unit/test_rendering_color.py tests/unit/test_rendering_surface.py -v` — all pass
4. No test touches files outside `tests/unit/`
</verification>

<success_criteria>
- Color tests cover all 4 COLOR requirements (RGB tuples, hex, named, interchangeable)
- Surface tests cover all SURF, COORD, IDENT, DELTA requirements
- 3-episode reset test validates DELTA-04 thoroughly
- All tests pass with zero failures
- Test count is 30+ covering every requirement ID
</success_criteria>

<output>
After completion, create `.planning/phases/97-python-surface-core/97-03-SUMMARY.md`
</output>
