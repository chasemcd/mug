---
phase: 76-test-and-roadmap-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/conftest.py
  - tests/e2e/test_network_disruption.py
  - tests/e2e/test_latency_injection.py
  - tests/e2e/test_data_comparison.py
  - tests/fixtures/game_helpers.py
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - "flask_server_multi_episode fixture does not exist in conftest.py"
    - "test_network_disruption.py has no unused imports"
    - "run_full_episode_flow exists in exactly one location (game_helpers.py)"
    - "All consumers of run_full_episode_flow import from game_helpers"
    - "ROADMAP.md shows v1.14 Phases 65-66 plan checkboxes as complete"
    - "All E2E tests still pass (no regressions from cleanup)"
  artifacts:
    - path: "tests/conftest.py"
      provides: "Shared pytest fixtures without orphaned flask_server_multi_episode"
      contains: "flask_server_multi_episode_fresh"
    - path: "tests/fixtures/game_helpers.py"
      provides: "Single source of truth for run_full_episode_flow"
      exports: ["run_full_episode_flow", "run_full_episode_flow_until_gameplay"]
    - path: ".planning/ROADMAP.md"
      provides: "Accurate completion status for all phases"
      contains: "[x] 65-01-PLAN.md"
  key_links:
    - from: "tests/e2e/test_latency_injection.py"
      to: "tests/fixtures/game_helpers.py"
      via: "import run_full_episode_flow"
      pattern: "from tests.fixtures.game_helpers import.*run_full_episode_flow"
    - from: "tests/e2e/test_data_comparison.py"
      to: "tests/fixtures/game_helpers.py"
      via: "import run_full_episode_flow"
      pattern: "from tests.fixtures.game_helpers import.*run_full_episode_flow"
---

<objective>
Remove dead test code, consolidate duplicate helpers, and update the roadmap to reflect actual completion state.

Purpose: Close out accumulated tech debt from rapid milestone delivery (CLEAN-01 through CLEAN-04).
Output: Clean test infrastructure with no orphaned fixtures or duplicated helpers, and an accurate roadmap.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/conftest.py
@tests/fixtures/game_helpers.py
@tests/e2e/test_network_disruption.py
@tests/e2e/test_latency_injection.py
@tests/e2e/test_data_comparison.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove orphaned fixture and consolidate run_full_episode_flow</name>
  <files>
    tests/conftest.py
    tests/fixtures/game_helpers.py
    tests/e2e/test_latency_injection.py
    tests/e2e/test_data_comparison.py
    tests/e2e/test_network_disruption.py
  </files>
  <action>
**CLEAN-01: Remove flask_server_multi_episode from conftest.py**

Delete the entire `flask_server_multi_episode` fixture (lines 369-455 in `tests/conftest.py`). This is the module-scoped fixture on port 5703 that is NOT used by any test. Keep `flask_server_multi_episode_fresh` (function-scoped, port 5706) which IS used by `test_lifecycle_stress.py`.

To verify it's truly unused before deleting: `grep -rn "flask_server_multi_episode[^_]" tests/` should only show the definition in conftest.py.

**CLEAN-03: Move run_full_episode_flow to game_helpers.py**

The function `run_full_episode_flow` is defined identically in both `tests/e2e/test_latency_injection.py` (line 87) and `tests/e2e/test_data_comparison.py` (line 56). Both versions:
- Accept `page1, page2, base_url, episode_timeout=180000, setup_timeout=120000`
- Navigate, connect sockets, click advance, click start, wait for canvas/game, set visibility, verify same game, wait for episode, return final states

Move this function to `tests/fixtures/game_helpers.py` at the end of the file (after `run_full_episode_flow_until_gameplay`). The function needs these imports which are already present in game_helpers.py: `wait_for_socket_connected`, `wait_for_game_canvas`, `wait_for_game_object`, `wait_for_episode_complete`, `get_game_state`, `click_advance_button`, `click_start_button`, `set_tab_visibility`. All are already imported or defined in game_helpers.py.

Use the version from `test_latency_injection.py` as the canonical one (it has a slightly more descriptive docstring mentioning "latency tests").

After adding to game_helpers.py:
- In `tests/e2e/test_latency_injection.py`: Delete the local `run_full_episode_flow` definition (lines 87-151). Add `run_full_episode_flow` to the existing `from tests.fixtures.game_helpers import (...)` block.
- In `tests/e2e/test_data_comparison.py`: Delete the local `run_full_episode_flow` definition (lines 56-120). Add `run_full_episode_flow` to the existing `from tests.fixtures.game_helpers import (...)` block.

**CLEAN-02: Remove unused import from test_network_disruption.py**

Delete line 47: `from tests.e2e.test_latency_injection import run_full_episode_flow`. This import is never used in the file (confirmed by grep -- only `run_full_episode_flow_until_gameplay` is called at lines 79 and 310).
  </action>
  <verify>
1. `grep -rn "flask_server_multi_episode[^_]" tests/` returns no matches
2. `grep -rn "def run_full_episode_flow[^_]" tests/` returns exactly ONE match in `tests/fixtures/game_helpers.py`
3. `grep -rn "from tests.e2e.test_latency_injection import" tests/` returns no matches (cross-test-file import removed)
4. `python -c "from tests.fixtures.game_helpers import run_full_episode_flow; print('OK')"` succeeds
5. `python -c "from tests.e2e.test_latency_injection import run_full_episode_flow; print('OK')"` succeeds (re-exported via game_helpers)
  </verify>
  <done>
    - flask_server_multi_episode fixture removed from conftest.py (CLEAN-01)
    - run_full_episode_flow exists only in game_helpers.py (CLEAN-03)
    - Unused import removed from test_network_disruption.py (CLEAN-02)
    - All test files import run_full_episode_flow from game_helpers.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ROADMAP.md completion status and verify no regressions</name>
  <files>
    .planning/ROADMAP.md
  </files>
  <action>
**CLEAN-04: Mark v1.14 Phases 65-66 as complete in ROADMAP.md**

In `.planning/ROADMAP.md`, find the Phase 65 and Phase 66 sections under "Phase Details" and update plan checkboxes:

Phase 65 (around line 317-318): Change:
```
- [ ] 65-01-PLAN.md -- Create test server configs (multi-episode + focus-timeout) and pytest fixtures
- [ ] 65-02-PLAN.md -- Create lifecycle stress tests (STRESS-02 through STRESS-07)
```
to:
```
- [x] 65-01-PLAN.md -- Create test server configs (multi-episode + focus-timeout) and pytest fixtures
- [x] 65-02-PLAN.md -- Create lifecycle stress tests (STRESS-02 through STRESS-07)
```

Phase 66 (around line 331-333): Change:
```
**Plans**: TBD

Plans:
- [ ] 66-01: TBD
```
to:
```
**Plans:** 1 plan

Plans:
- [x] 66-01-PLAN.md -- Server recovery validation after chaos scenarios
```

Also update Phase 75 plan checkboxes to `[x]` (both 75-01 and 75-02 are complete per STATE.md):

Phase 75 (around line 471-473): Change:
```
- [x] 75-01-PLAN.md ...
- [x] 75-02-PLAN.md ...
```
(These are already marked [x], verify and leave as-is.)

Also update Phase 76 section (around line 485-488): Change:
```
**Plans:** TBD

Plans:
- [ ] 76-01: TBD
```
to:
```
**Plans:** 1 plan

Plans:
- [ ] 76-01-PLAN.md -- Remove orphaned fixtures, consolidate helpers, update roadmap
```

**Regression verification**: Run a quick syntax check on the modified test files:
- `python -m py_compile tests/conftest.py`
- `python -m py_compile tests/e2e/test_network_disruption.py`
- `python -m py_compile tests/e2e/test_latency_injection.py`
- `python -m py_compile tests/e2e/test_data_comparison.py`
- `python -m py_compile tests/fixtures/game_helpers.py`

All must succeed with no errors.
  </action>
  <verify>
1. `grep "\- \[ \] 65-0" .planning/ROADMAP.md` returns no matches (both 65-01 and 65-02 are [x])
2. `grep "\- \[ \] 66-01" .planning/ROADMAP.md` returns no matches (66-01 is [x])
3. `grep "Plans.*TBD" .planning/ROADMAP.md` returns no matches for Phase 65/66/76
4. `python -m py_compile tests/conftest.py` succeeds
5. `python -m py_compile tests/e2e/test_latency_injection.py` succeeds
6. `python -m py_compile tests/e2e/test_data_comparison.py` succeeds
7. `python -m py_compile tests/e2e/test_network_disruption.py` succeeds
  </verify>
  <done>
    - Phase 65 plan checkboxes marked [x] (CLEAN-04)
    - Phase 66 plan checkbox marked [x] and Plans count updated (CLEAN-04)
    - Phase 76 Plans section updated with actual plan name
    - All modified Python files compile without errors
  </done>
</task>

</tasks>

<verification>
All four CLEAN requirements satisfied:
- CLEAN-01: `grep -rn "def flask_server_multi_episode[^_]" tests/` returns 0 matches
- CLEAN-02: `grep -n "from tests.e2e.test_latency_injection import" tests/e2e/test_network_disruption.py` returns 0 matches
- CLEAN-03: `grep -rn "def run_full_episode_flow[^_]" tests/` returns exactly 1 match (in game_helpers.py)
- CLEAN-04: Phase 65-66 checkboxes in ROADMAP.md all show [x]

Regression check: All 5 modified Python files pass `python -m py_compile`.
</verification>

<success_criteria>
1. flask_server_multi_episode fixture no longer exists in conftest.py
2. test_network_disruption.py has no unused imports (no cross-test-file imports)
3. run_full_episode_flow exists in exactly one location (tests/fixtures/game_helpers.py)
4. test_latency_injection.py and test_data_comparison.py import run_full_episode_flow from game_helpers
5. ROADMAP.md shows v1.14 Phases 65-66 as complete (all plan checkboxes [x])
6. All modified files compile successfully
</success_criteria>

<output>
After completion, create `.planning/phases/76-test-and-roadmap-cleanup/76-01-SUMMARY.md`
</output>
