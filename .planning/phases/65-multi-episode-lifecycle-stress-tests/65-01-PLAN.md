---
phase: 65-multi-episode-lifecycle-stress-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_multi_episode_test.py
  - interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_focus_timeout_test.py
  - tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "Multi-episode test server runs 2 episodes per game"
    - "Focus timeout test server ends game after 10 seconds of focus loss"
    - "Test fixtures can start either server variant on different ports"
  artifacts:
    - path: "interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_multi_episode_test.py"
      provides: "Server config with num_episodes=2"
      contains: "num_episodes=2"
    - path: "interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_focus_timeout_test.py"
      provides: "Server config with focus_loss_config(timeout_ms=10000)"
      contains: "timeout_ms=10000"
    - path: "tests/conftest.py"
      provides: "flask_server_multi_episode and flask_server_focus_timeout fixtures"
      contains: "flask_server_multi_episode"
  key_links:
    - from: "tests/conftest.py"
      to: "overcooked_human_human_multiplayer_multi_episode_test.py"
      via: "subprocess.Popen module path"
      pattern: "overcooked_human_human_multiplayer_multi_episode_test"
---

<objective>
Create test server configurations and fixtures for multi-episode and focus timeout stress tests.

Purpose: Phase 65 tests require server behaviors that differ from the standard test config. Multi-episode tests need `num_episodes=2`. Focus loss timeout tests need `timeout_ms=10000` (not 0). These configs enable STRESS-02 and STRESS-05 scenarios.

Output: Two new test server configs and corresponding pytest fixtures on separate ports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-multi-episode-lifecycle-stress-tests/65-RESEARCH.md

# Existing test server config (template)
@interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_test.py

# Existing fixtures (extend these)
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-episode test server config</name>
  <files>interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_multi_episode_test.py</files>
  <action>
Create a new test server config based on `overcooked_human_human_multiplayer_test.py` with these changes:

1. Copy the existing test config as a starting point
2. Change `gameplay(num_episodes=1, ...)` to `gameplay(num_episodes=2, max_steps=450)` - two episodes, same step count
3. Keep all other settings identical (no RTT limit, no focus timeout, 2000ms input confirmation)
4. Update docstring to explain this is for multi-episode stress testing (STRESS-02)
5. Default port: 5703 (different from standard test port 5702)
6. Experiment ID: `overcooked_multiplayer_hh_multi_episode_test`

The file should be runnable standalone:
```python
python -m interactive_gym.examples.cogrid.overcooked_human_human_multiplayer_multi_episode_test
```
  </action>
  <verify>
```bash
# Verify file exists and has correct config
grep -q "num_episodes=2" interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_multi_episode_test.py
grep -q "5703" interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_multi_episode_test.py
```
  </verify>
  <done>Multi-episode test server config exists with num_episodes=2 and default port 5703</done>
</task>

<task type="auto">
  <name>Task 2: Create focus timeout test server config</name>
  <files>interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_focus_timeout_test.py</files>
  <action>
Create a new test server config based on `overcooked_human_human_multiplayer_test.py` with these changes:

1. Copy the existing test config as a starting point
2. Change `focus_loss_config(timeout_ms=0, ...)` to `focus_loss_config(timeout_ms=10000, pause_on_partner_background=False)` - 10 second timeout
3. Keep all other settings identical (no RTT limit, 1 episode, 2000ms input confirmation)
4. Update docstring to explain this is for focus loss timeout testing (STRESS-05)
5. Default port: 5704 (different from other test ports)
6. Experiment ID: `overcooked_multiplayer_hh_focus_timeout_test`

The 10 second timeout is short enough for tests to complete quickly but long enough to be realistic.
  </action>
  <verify>
```bash
# Verify file exists and has correct config
grep -q "timeout_ms=10000" interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_focus_timeout_test.py
grep -q "5704" interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_focus_timeout_test.py
```
  </verify>
  <done>Focus timeout test server config exists with timeout_ms=10000 and default port 5704</done>
</task>

<task type="auto">
  <name>Task 3: Add pytest fixtures for new server configs</name>
  <files>tests/conftest.py</files>
  <action>
Add two new module-scoped fixtures to conftest.py:

1. `flask_server_multi_episode`:
   - Port 5703
   - Uses `overcooked_human_human_multiplayer_multi_episode_test` module
   - Same startup/shutdown pattern as existing `flask_server` fixture
   - Yields dict with `url`, `process`, `num_episodes=2`

2. `flask_server_focus_timeout`:
   - Port 5704
   - Uses `overcooked_human_human_multiplayer_focus_timeout_test` module
   - Same startup/shutdown pattern as existing `flask_server` fixture
   - Yields dict with `url`, `process`, `focus_timeout_ms=10000`

Pattern to follow from existing `flask_server` fixture:
- subprocess.Popen with module path and --port argument
- Poll health endpoint until ready (max 30 retries)
- Check for process crash during startup
- Terminate on teardown with 5s timeout, then kill if needed
  </action>
  <verify>
```bash
# Verify fixtures are defined
grep -q "def flask_server_multi_episode" tests/conftest.py
grep -q "def flask_server_focus_timeout" tests/conftest.py
grep -q "5703" tests/conftest.py
grep -q "5704" tests/conftest.py
```
  </verify>
  <done>Both new fixtures are defined in conftest.py and use the correct ports and module paths</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Multi-episode server starts correctly:
```bash
timeout 10 python -m interactive_gym.examples.cogrid.overcooked_human_human_multiplayer_multi_episode_test --port 5703 &
sleep 5
curl -s http://localhost:5703/ | grep -q "html" && echo "Multi-episode server OK"
pkill -f "overcooked_human_human_multiplayer_multi_episode_test"
```

2. Focus timeout server starts correctly:
```bash
timeout 10 python -m interactive_gym.examples.cogrid.overcooked_human_human_multiplayer_focus_timeout_test --port 5704 &
sleep 5
curl -s http://localhost:5704/ | grep -q "html" && echo "Focus timeout server OK"
pkill -f "overcooked_human_human_multiplayer_focus_timeout_test"
```

3. Fixtures are valid pytest fixtures (no syntax errors):
```bash
python -c "import tests.conftest; print('Fixtures OK')"
```
</verification>

<success_criteria>
1. `overcooked_human_human_multiplayer_multi_episode_test.py` exists with `num_episodes=2`
2. `overcooked_human_human_multiplayer_focus_timeout_test.py` exists with `timeout_ms=10000`
3. `flask_server_multi_episode` fixture defined on port 5703
4. `flask_server_focus_timeout` fixture defined on port 5704
5. Both server configs start without errors
</success_criteria>

<output>
After completion, create `.planning/phases/65-multi-episode-lifecycle-stress-tests/65-01-SUMMARY.md`
</output>
