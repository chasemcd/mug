---
phase: 23-partner-disconnect-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/scenes/gym_scene.py
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
  - interactive_gym/server/app.py
  - interactive_gym/server/pyodide_game_coordinator.py
autonomous: true

must_haves:
  truths:
    - "Participant stays on same page when partner disconnects (no redirect)"
    - "Game container and HUD are hidden when overlay appears"
    - "Custom message displayed when configured, default message otherwise"
    - "Page remains indefinitely (no Continue button, no auto-redirect)"
    - "All gameplay data exported before overlay appears"
    - "Session marked as partial with disconnectedPlayerId in metadata"
  artifacts:
    - path: "interactive_gym/scenes/gym_scene.py"
      provides: "partner_disconnect_message() config method"
      contains: "def partner_disconnect_message"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "In-page overlay instead of redirect"
      contains: "_showPartnerDisconnectedOverlay"
  key_links:
    - from: "pyodide_multiplayer_game.js:_handleReconnectionGameEnd"
      to: "emitMultiplayerMetrics()"
      via: "function call before overlay"
      pattern: "emitMultiplayerMetrics.*_showPartnerDisconnectedOverlay|_showPartnerDisconnectedOverlay.*emitMultiplayerMetrics"
    - from: "pyodide_multiplayer_game.js:sessionPartialInfo"
      to: "exportMultiplayerMetrics"
      via: "sessionStatus.disconnectedPlayerId field"
      pattern: "disconnectedPlayerId"
    - from: "gym_scene.py:partner_disconnect_message"
      to: "scene_metadata in pyodide_game_ready"
      via: "config serialization"
      pattern: "partner_disconnect_message"
---

<objective>
Implement in-page partner disconnection handling that keeps participants on the same page with a configurable message overlay, exports all data with disconnection metadata, and marks the session as partial.

Purpose: Improve the partner disconnection experience by avoiding redirects, preserving data integrity, and giving researchers configurable messaging control.
Output: Modified config API, in-page overlay UI, data export with disconnectedPlayerId
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-multiplayer-exclusion/17-01-SUMMARY.md
@.planning/phases/20-mid-game-reconnection/20-01-SUMMARY.md
@interactive_gym/scenes/gym_scene.py
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
@interactive_gym/server/app.py
@interactive_gym/server/pyodide_game_coordinator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GymScene config method and serialize to client</name>
  <files>
    interactive_gym/scenes/gym_scene.py
    interactive_gym/server/app.py
  </files>
  <action>
**In `gym_scene.py`:**

1. Add a new attribute after `reconnection_timeout_ms` (around line 186):
```python
# Partner disconnection message (Phase 23)
self.partner_disconnect_message: str | None = None  # Custom message, None uses default
```

2. Add a new config method after `reconnection_config()`:
```python
def partner_disconnect_message_config(
    self,
    message: str = NotProvided,
):
    """Configure the message shown when partner disconnects mid-game.

    If not configured, a default message is shown:
    "Your partner has disconnected. The game has ended."

    :param message: Custom message to display when partner disconnects
    :type message: str
    :return: This scene object
    :rtype: GymScene

    Example:
        scene.partner_disconnect_message_config(
            message="Your partner left the experiment. Thank you for participating."
        )
    """
    if message is not NotProvided:
        self.partner_disconnect_message = message

    return self
```

**In `app.py`:**

3. Find the `get_scene_metadata()` function (search for `def get_scene_metadata`).

4. Add `partner_disconnect_message` to the returned metadata dict (after `reconnection_timeout_ms` if present):
```python
# Partner disconnection message (Phase 23)
"partner_disconnect_message": scene.partner_disconnect_message,
```

This ensures the custom message is passed to the client via `scene_metadata` in the `pyodide_game_ready` event.
  </action>
  <verify>
    grep -n "partner_disconnect_message" interactive_gym/scenes/gym_scene.py
    grep -n "partner_disconnect_message" interactive_gym/server/app.py
  </verify>
  <done>
    - `partner_disconnect_message_config()` method exists in GymScene
    - `partner_disconnect_message` attribute initialized with default None
    - `partner_disconnect_message` included in scene_metadata returned by get_scene_metadata()
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify client to show in-page overlay with data export</name>
  <files>
    interactive_gym/server/static/js/pyodide_multiplayer_game.js
  </files>
  <action>
**1. Update `_handleReconnectionGameEnd(data)` method (around line 4541):**

Change it to:
```javascript
/**
 * Handle game end due to reconnection failure (Phase 20 - RECON-06, Phase 23).
 * Shows in-page partner disconnected overlay instead of redirect.
 * Exports all data before showing overlay.
 * @param {Object} data - Game end data from server
 * @param {string} data.game_id - Game identifier
 * @param {string} data.reason - Reason for game end
 * @param {string|number} data.disconnected_player_id - ID of player who disconnected
 */
_handleReconnectionGameEnd(data) {
    p2pLog.warn('Game ended due to partner disconnection', data);

    this._clearReconnectionTimeout();
    this.reconnectionState.state = 'terminated';

    // Stop game state
    this.state = "done";
    this.episodeComplete = true;

    // Pause continuous monitoring if active
    if (this.continuousMonitor) {
        this.continuousMonitor.pause();
    }

    // Mark session as partial with disconnection metadata (Phase 23 - DATA-02, DATA-03, DATA-04)
    this.sessionPartialInfo = {
        isPartial: true,
        terminationReason: 'partner_disconnected',
        terminationFrame: this.frameNumber,
        disconnectedPlayerId: data.disconnected_player_id || this.p2pPeerId,
        reconnectionData: this.getReconnectionData()
    };

    // Export all metrics BEFORE showing overlay (Phase 23 - DATA-01)
    if (this.gameId && this.sceneId) {
        this.emitMultiplayerMetrics(this.sceneId);
    }

    // Get custom message from config, or use default
    const customMessage = this.config?.partner_disconnect_message;
    const message = customMessage || "Your partner has disconnected. The game has ended.";

    // Show in-page overlay (Phase 23 - UI-01, UI-02, UI-03, UI-04)
    this._showPartnerDisconnectedOverlay(message);

    // Close P2P connection
    if (this.webrtcManager) {
        this.webrtcManager.close();
    }
}
```

**2. Replace `_showPartnerDisconnectedOverlay()` method (around line 4563):**

Change from redirect to in-page overlay:
```javascript
/**
 * Show partner disconnected overlay (Phase 23 - UI-01 through UI-04).
 * Hides game container and HUD, shows in-page overlay with message.
 * Page stays displayed indefinitely (no redirect, no Continue button).
 * @param {string} message - Message to display
 */
_showPartnerDisconnectedOverlay(message) {
    // Remove reconnecting overlay if present
    this._hideReconnectingOverlay();

    // Hide game container and HUD (Phase 23 - UI-02)
    const gameContainer = document.getElementById('gameContainer');
    if (gameContainer) {
        gameContainer.style.display = 'none';
    }

    const hudText = document.getElementById('hudText');
    if (hudText) {
        hudText.style.display = 'none';
    }

    // Create overlay (reuse styling from _showPartnerExcludedUI)
    let overlay = document.getElementById('partnerDisconnectedOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'partnerDisconnectedOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        document.body.appendChild(overlay);
    }

    // Use neutral styling (same as partner excluded UI)
    overlay.innerHTML = `
        <div style="
            background: white;
            padding: 40px;
            border-radius: 8px;
            max-width: 500px;
            text-align: center;
        ">
            <h2 style="color: #333; margin-bottom: 20px;">Game Ended</h2>
            <p style="font-size: 16px; margin-bottom: 20px;">${message}</p>
            <p style="color: #666; font-size: 14px;">Your game data has been saved. Thank you for participating.</p>
        </div>
    `;
    overlay.style.display = 'flex';
}
```

**3. Update `exportMultiplayerMetrics()` sessionStatus section (around line 5596):**

Add `disconnectedPlayerId` to the sessionStatus object:
```javascript
// Session status (Phase 17: partial session marking, Phase 23: disconnectedPlayerId)
sessionStatus: {
    isPartial: this.sessionPartialInfo?.isPartial || false,
    terminationReason: this.sessionPartialInfo?.terminationReason || 'normal',
    terminationFrame: this.sessionPartialInfo?.terminationFrame || this.frameNumber,
    completedEpisodes: this.cumulativeValidation?.episodes?.length || 0,
    disconnectedPlayerId: this.sessionPartialInfo?.disconnectedPlayerId || null
},
```

**4. Store config for later access:**

In the `socket.on('pyodide_game_ready', ...)` handler (around line 813), add:
```javascript
// Store partner disconnect message config (Phase 23 - CFG-01, CFG-02)
if (data.scene_metadata?.partner_disconnect_message !== undefined) {
    this.config.partner_disconnect_message = data.scene_metadata.partner_disconnect_message;
}
```
  </action>
  <verify>
    grep -n "emitMultiplayerMetrics" interactive_gym/server/static/js/pyodide_multiplayer_game.js | grep -i "handleReconnectionGameEnd\|_showPartnerDisconnected"
    grep -n "disconnectedPlayerId" interactive_gym/server/static/js/pyodide_multiplayer_game.js
    grep -n "partner_disconnect_message" interactive_gym/server/static/js/pyodide_multiplayer_game.js
    grep -n "gameContainer.*display.*none\|hudText.*display.*none" interactive_gym/server/static/js/pyodide_multiplayer_game.js
  </verify>
  <done>
    - `_handleReconnectionGameEnd()` calls `emitMultiplayerMetrics()` before `_showPartnerDisconnectedOverlay()`
    - `sessionPartialInfo` includes `isPartial: true`, `terminationReason: 'partner_disconnected'`, `disconnectedPlayerId`
    - `_showPartnerDisconnectedOverlay()` hides gameContainer and hudText
    - `_showPartnerDisconnectedOverlay()` creates in-page overlay (no redirect)
    - Overlay has no Continue button and no auto-redirect timer
    - `exportMultiplayerMetrics()` includes `disconnectedPlayerId` in sessionStatus
    - Config partner_disconnect_message stored from scene_metadata
  </done>
</task>

<task type="auto">
  <name>Task 3: Update server to include disconnected player ID</name>
  <files>
    interactive_gym/server/app.py
    interactive_gym/server/pyodide_game_coordinator.py
  </files>
  <action>
**In `app.py`:**

1. Find the `handle_p2p_reconnection_timeout` function (around line 1570).

2. Update the `p2p_game_ended` emit to include `disconnected_player_id`:

Before:
```python
socketio.emit(
    "p2p_game_ended",
    {
        "game_id": game_id,
        "reason": "reconnection_timeout",
        "reconnection_data": reconnection_data
    },
    room=game_id
)
```

After:
```python
# Get the disconnected player ID from the coordinator
disconnected_player_id = PYODIDE_COORDINATOR.get_disconnected_player_id(game_id)

socketio.emit(
    "p2p_game_ended",
    {
        "game_id": game_id,
        "reason": "reconnection_timeout",
        "reconnection_data": reconnection_data,
        "disconnected_player_id": disconnected_player_id  # Phase 23 - DATA-04
    },
    room=game_id
)
```

**In `pyodide_game_coordinator.py`:**

3. Find the `PyodideGameState` class and add a field to track disconnected player (add after existing fields):
```python
@dataclass
class PyodideGameState:
    ...
    disconnected_player_id: str | int | None = None  # Track who disconnected (Phase 23)
```

4. Add a method to get the disconnected player ID (after `handle_reconnection_timeout` method):
```python
def get_disconnected_player_id(self, game_id: str) -> str | int | None:
    """Get the ID of the player who disconnected from a game.

    Args:
        game_id: Game identifier

    Returns:
        Player ID of disconnected player, or None if unknown
    """
    with self.lock:
        if game_id not in self.games:
            return None
        return self.games[game_id].disconnected_player_id
```

5. Update `handle_connection_lost` or wherever the disconnection is first detected to set `disconnected_player_id`. Search for where `p2p_connection_lost` is handled. In that handler, add:
```python
# Track which player disconnected (Phase 23)
if game_id in self.games:
    self.games[game_id].disconnected_player_id = player_id
```

Look for a pattern like:
```python
@socketio.on("p2p_connection_lost")
def handle_p2p_connection_lost(data):
```

In that handler, after extracting `player_id`, add:
```python
# Track disconnected player for data export (Phase 23 - DATA-04)
with PYODIDE_COORDINATOR.lock:
    if game_id in PYODIDE_COORDINATOR.games:
        # The player who reported the loss is NOT the disconnected player
        # The disconnected player is the OTHER player (peer)
        game = PYODIDE_COORDINATOR.games[game_id]
        for pid in game.players:
            if pid != player_id:
                game.disconnected_player_id = pid
                break
```

**Important:** The player who sends `p2p_connection_lost` is the one who DETECTED the loss, not the one who disconnected. The disconnected player is their peer.
  </action>
  <verify>
    grep -n "disconnected_player_id" interactive_gym/server/app.py
    grep -n "disconnected_player_id" interactive_gym/server/pyodide_game_coordinator.py
    grep -n "get_disconnected_player_id" interactive_gym/server/pyodide_game_coordinator.py
  </verify>
  <done>
    - `p2p_game_ended` event includes `disconnected_player_id` field
    - `PyodideGameState` has `disconnected_player_id` attribute
    - `get_disconnected_player_id()` method exists in coordinator
    - Disconnected player ID is tracked when connection loss detected
  </done>
</task>

</tasks>

<verification>
1. **Config API (CFG-01, CFG-02):**
   ```bash
   grep -n "partner_disconnect_message" interactive_gym/scenes/gym_scene.py
   grep -n "partner_disconnect_message" interactive_gym/server/app.py
   ```

2. **UI Changes (UI-01, UI-02, UI-03, UI-04):**
   ```bash
   # No redirect
   grep -n "window.location" interactive_gym/server/static/js/pyodide_multiplayer_game.js | grep -i "partner.*disconnect"
   # Should return nothing (no redirect)

   # In-page overlay
   grep -n "partnerDisconnectedOverlay" interactive_gym/server/static/js/pyodide_multiplayer_game.js

   # Hide game container and HUD
   grep -n "gameContainer.*display.*none" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   grep -n "hudText.*display.*none" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   ```

3. **Data Export (DATA-01, DATA-02, DATA-03, DATA-04):**
   ```bash
   # emitMultiplayerMetrics called before overlay
   grep -A20 "_handleReconnectionGameEnd" interactive_gym/server/static/js/pyodide_multiplayer_game.js | grep -E "emitMultiplayerMetrics|_showPartnerDisconnectedOverlay"

   # sessionPartialInfo fields
   grep -n "terminationReason.*partner_disconnected" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   grep -n "disconnectedPlayerId" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   ```

4. **Server-side disconnected player tracking:**
   ```bash
   grep -n "disconnected_player_id" interactive_gym/server/app.py
   grep -n "disconnected_player_id" interactive_gym/server/pyodide_game_coordinator.py
   ```
</verification>

<success_criteria>
All 10 requirements satisfied:

**UI Handling:**
- [x] UI-01: Participant stays on same page when partner disconnects (no redirect)
- [x] UI-02: Game container and HUD hidden when partner disconnection detected
- [x] UI-03: Disconnection message displayed on same page after partner disconnects
- [x] UI-04: Page remains displayed indefinitely (participant closes when done)

**Data Export:**
- [x] DATA-01: All gameplay data collected before disconnection is exported to server
- [x] DATA-02: Session marked as partial in exported data when partner disconnects
- [x] DATA-03: Disconnection reason included in session metadata
- [x] DATA-04: Disconnected player ID included in session metadata

**Configuration:**
- [x] CFG-01: Researchers can set custom partner disconnect message via GymScene config
- [x] CFG-02: Default message provided when no custom message configured
</success_criteria>

<output>
After completion, create `.planning/phases/23-partner-disconnect-handling/23-01-SUMMARY.md`
</output>
