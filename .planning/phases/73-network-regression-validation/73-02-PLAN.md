---
phase: 73-network-regression-validation
plan: 02
type: execute
wave: 2
depends_on: ["73-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 4 data comparison tests pass in a single pytest run"
    - "All 2 multiplayer basic tests pass in a single pytest run"
    - "All 2 multi-participant tests pass with 0.5s stagger in a single pytest run"
    - "The focus loss episode boundary parity test passes in a single pytest run"
  artifacts:
    - path: "tests/e2e/test_data_comparison.py"
      provides: "Data comparison test suite (4 tests)"
      contains: "test_export_parity_basic"
    - path: "tests/e2e/test_multiplayer_basic.py"
      provides: "Multiplayer basic test suite (2 tests)"
      contains: "test_two_players_connect_and_complete_episode"
    - path: "tests/e2e/test_multi_participant.py"
      provides: "Multi-participant test suite (2 tests)"
      contains: "test_three_simultaneous_games"
    - path: "tests/e2e/test_focus_loss_data_parity.py"
      provides: "Focus loss boundary parity test (1 test)"
      contains: "test_focus_loss_episode_boundary_parity"
  key_links:
    - from: "tests/e2e/test_multi_participant.py"
      to: "tests/fixtures/multi_participant.py"
      via: "GameOrchestrator import"
      pattern: "from tests.fixtures.multi_participant import GameOrchestrator"
    - from: "tests/e2e/test_data_comparison.py"
      to: "tests/fixtures/export_helpers.py"
      via: "export parity validation"
      pattern: "run_comparison"
---

<objective>
Run all regression E2E test suites (data comparison, multiplayer basic, multi-participant, focus loss) and ensure they pass. Diagnose and fix any failures inline.

Purpose: Validate REG-01 (data comparison), REG-02 (multiplayer basic), REG-03 (multi-participant), and REG-04 (focus loss) requirements. These suites exercise the core game flow without network stress and should pass given the Phase 71/72 fixes.

Output: All 9 regression tests passing across 4 test suites. Any code fixes committed. A SUMMARY documenting pass/fail results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/73-network-regression-validation/73-01-SUMMARY.md
@tests/e2e/test_data_comparison.py
@tests/e2e/test_multiplayer_basic.py
@tests/e2e/test_multi_participant.py
@tests/e2e/test_focus_loss_data_parity.py
@tests/conftest.py
@tests/fixtures/multi_participant.py
@tests/fixtures/game_helpers.py
@tests/fixtures/export_helpers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run multiplayer basic + data comparison + focus loss test suites</name>
  <files>tests/e2e/test_multiplayer_basic.py, tests/e2e/test_data_comparison.py, tests/e2e/test_focus_loss_data_parity.py</files>
  <action>
Run the three test suites that all use the module-scoped `flask_server` fixture (port 5702). Run them one at a time to isolate failures, since the flask_server fixture is module-scoped (fresh server per module).

**Step 1: Multiplayer basic (2 tests, fastest, good sanity check)**
```bash
cd /Users/chasemcd/Repositories/interactive-gym
python -m pytest tests/e2e/test_multiplayer_basic.py --headed --browser chromium -v 2>&1
```

Tests:
- test_two_players_connect_and_complete_episode (full game flow)
- test_matchmaking_pairs_two_players (lighter matchmaking check)

**Step 2: Data comparison (4 tests, export parity validation)**
```bash
python -m pytest tests/e2e/test_data_comparison.py --headed --browser chromium -v 2>&1
```

Tests:
- test_export_parity_basic (no network stress)
- test_export_parity_with_latency (100ms latency on player 2)
- test_active_input_parity (random actions, no latency)
- test_focus_loss_mid_episode_parity (focus loss mid-episode + parity)

NOTE: test_data_comparison.py has 4 tests sharing a module-scoped flask_server. Phase 71 discovered that 5+ game sessions in one module exhausts eventlet state. With 4 tests this should be fine, but watch for the 4th test timing out.

**Step 3: Focus loss boundary parity (1 test, separate module)**
```bash
python -m pytest tests/e2e/test_focus_loss_data_parity.py --headed --browser chromium -v 2>&1
```

Tests:
- test_focus_loss_episode_boundary_parity (focus loss near episode end + parity)

This was extracted to its own module in Phase 71-02 specifically because it was the 5th test in test_data_comparison.py and caused the flask_server to exhaust.

IF ANY TEST FAILS:
1. Capture full error output
2. For parity tests: check if export files were written, check comparison output
3. For basic tests: check if matchmaking or game start timed out
4. For focus loss: check if backgrounding/foregrounding worked correctly
5. Diagnose root cause and apply minimal fix
6. Re-run failing test, then full suite

Record complete pass/fail results for each suite.
  </action>
  <verify>
All 7 tests across the 3 suites show PASSED:
- `python -m pytest tests/e2e/test_multiplayer_basic.py --headed --browser chromium -v` = 2 passed
- `python -m pytest tests/e2e/test_data_comparison.py --headed --browser chromium -v` = 4 passed
- `python -m pytest tests/e2e/test_focus_loss_data_parity.py --headed --browser chromium -v` = 1 passed
  </verify>
  <done>All 7 tests pass across multiplayer basic, data comparison, and focus loss suites. REG-01, REG-02, and REG-04 requirements satisfied.</done>
</task>

<task type="auto">
  <name>Task 2: Run multi-participant test suite</name>
  <files>tests/e2e/test_multi_participant.py</files>
  <action>
Run the multi-participant test suite which uses `flask_server_fresh` (function-scoped, port 5705) and `multi_participant_contexts` (6 browser contexts):

```bash
cd /Users/chasemcd/Repositories/interactive-gym
python -m pytest tests/e2e/test_multi_participant.py --headed --browser chromium -v 2>&1
```

Tests:
- test_three_simultaneous_games (STRESS-01: 6 contexts, 3 concurrent games with 0.5s stagger)
- test_staggered_participant_arrival (FIFO pairing under staggered timing with 0.5s stagger)

These tests are the most resource-intensive: 6 browser contexts, 3 simultaneous games, WebRTC connections between all pairs. Each test has a 600s (10 minute) timeout.

Key risk areas:
- Port 5705 conflicts with any stale processes from prior runs
- 6 browser contexts competing for WebRTC resources
- 0.5s stagger (reduced from 5.0s in Phase 70) may be too aggressive
- GameOrchestrator.wait_for_all_episodes_with_parity does export parity checks

IF ANY TEST FAILS:
1. Capture full error output
2. Check if all 3 games matched correctly (FIFO pairing)
3. Check if any game failed parity validation
4. Check if any game timed out (300s per game episode timeout)
5. If stagger timing is the issue, consider increasing stagger_delay_sec back toward 1.0-2.0s
6. If port conflicts, ensure _ensure_port_available works for port 5705
7. Apply minimal fix and re-run

IMPORTANT: These tests take 5-10 minutes each. Total runtime may be 20+ minutes.

Record complete pass/fail results.
  </action>
  <verify>
All tests in `python -m pytest tests/e2e/test_multi_participant.py --headed --browser chromium -v` show PASSED status with 0 failures.
  </verify>
  <done>Both multi-participant tests pass. REG-03 requirement satisfied.</done>
</task>

</tasks>

<verification>
After both tasks complete, run the complete Phase 73 scope as a single combined run to confirm everything works together:

```bash
cd /Users/chasemcd/Repositories/interactive-gym
python -m pytest tests/e2e/test_multiplayer_basic.py tests/e2e/test_data_comparison.py tests/e2e/test_focus_loss_data_parity.py tests/e2e/test_multi_participant.py --headed --browser chromium -v 2>&1
```

This validates that:
1. All 9 regression tests pass
2. Module-scoped server fixtures don't conflict between suites
3. No resource leaks from earlier suites affect later ones

Combined with Plan 01 results (latency + disruption), this confirms all 6 Phase 73 success criteria are met.
</verification>

<success_criteria>
- All 4 data comparison tests pass (basic, latency, active input, focus loss mid-episode)
- All 2 multiplayer basic tests pass (full episode, matchmaking)
- All 2 multi-participant tests pass with 0.5s stagger (simultaneous, staggered)
- Focus loss episode boundary parity test passes
- No xfail markers, tolerance hacks, or skip annotations added
- REG-01, REG-02, REG-03, REG-04 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/73-network-regression-validation/73-02-SUMMARY.md`
</output>
