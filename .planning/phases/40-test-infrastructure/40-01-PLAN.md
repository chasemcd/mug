---
phase: 40-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/conftest.py
  - tests/e2e/__init__.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Flask server starts before tests run"
    - "Flask server stops after tests complete"
    - "Two isolated browser contexts can be created"
    - "pytest discovers and runs e2e tests"
  artifacts:
    - path: "tests/conftest.py"
      provides: "Shared pytest fixtures"
      exports: ["flask_server", "player_contexts"]
    - path: "tests/e2e/__init__.py"
      provides: "E2E test package marker"
    - path: "pyproject.toml"
      provides: "Test dependencies"
      contains: "playwright"
  key_links:
    - from: "tests/conftest.py"
      to: "overcooked_human_human_multiplayer.py"
      via: "subprocess.Popen"
      pattern: "subprocess\\.Popen.*overcooked_human_human_multiplayer"
---

<objective>
Set up Playwright test infrastructure with Flask server lifecycle management and dual browser contexts.

Purpose: Establish the foundation for E2E multiplayer testing - server fixture manages lifecycle, context fixture provides isolated browser sessions for two players.

Output: Working test fixtures that later plans will use for game automation tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-test-infrastructure/40-RESEARCH.md

Key codebase files:
@interactive_gym/examples/cogrid/overcooked_human_human_multiplayer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test dependencies to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add optional test dependencies to pyproject.toml:

```toml
[project.optional-dependencies]
test = [
    "pytest>=8.0",
    "playwright>=1.49",
    "pytest-playwright>=0.6",
    "pytest-timeout>=2.3",
]
```

This follows standard Python packaging conventions for optional test dependencies.
Users install with: `pip install -e ".[test]" && playwright install chromium`
  </action>
  <verify>
Run: `pip install -e ".[test]"` - should install without errors
Run: `python -c "import pytest; import playwright"` - should succeed
  </verify>
  <done>Test dependencies installable via pip install -e ".[test]"</done>
</task>

<task type="auto">
  <name>Task 2: Create test directory structure and conftest fixtures</name>
  <files>tests/__init__.py, tests/conftest.py, tests/e2e/__init__.py</files>
  <action>
Create the test directory structure:
- `tests/__init__.py` (empty package marker)
- `tests/e2e/__init__.py` (empty package marker)
- `tests/conftest.py` (shared fixtures)

In `tests/conftest.py`, implement:

1. **flask_server fixture (scope="module")**:
   - Start Flask server as subprocess using:
     `["python", "-m", "interactive_gym.examples.cogrid.overcooked_human_human_multiplayer", "--port", "5702"]`
   - Poll `http://localhost:5702` with HTTPConnection until server responds (max 30 retries, 1s each)
   - Yield server info dict: `{"url": "http://localhost:5702", "process": process}`
   - On teardown: `process.terminate()` then `process.wait(timeout=5)`
   - If startup fails after retries, terminate process and raise RuntimeError

2. **player_contexts fixture (scope="function")**:
   - Take `browser` fixture from pytest-playwright
   - Create two isolated browser contexts: `browser.new_context()`
   - Create a page in each context: `context.new_page()`
   - Yield tuple: `(page1, page2)`
   - On teardown: close both contexts

Use `http.client.HTTPConnection` for health check (NOT requests - avoid extra dependency).
Set `stdout=subprocess.PIPE, stderr=subprocess.PIPE` to capture server output.

Important: The module-scoped flask_server fixture starts ONCE per test module, not per test.
The function-scoped player_contexts fixture creates fresh browser contexts for each test.
  </action>
  <verify>
Run: `pytest --collect-only tests/` - should discover conftest.py
Run: `python -c "from tests.conftest import *"` - should import without errors
  </verify>
  <done>
- tests/conftest.py exists with flask_server and player_contexts fixtures
- tests/e2e/__init__.py exists (empty package marker)
- Fixtures use correct scoping (module for server, function for contexts)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create smoke test validating fixtures work</name>
  <files>tests/e2e/test_infrastructure.py</files>
  <action>
Create `tests/e2e/test_infrastructure.py` with a minimal smoke test:

```python
"""
Smoke test validating test infrastructure works.

This test:
1. Verifies Flask server is running (via flask_server fixture)
2. Verifies two browser contexts can load the game page
3. Does NOT test game logic - just infrastructure
"""
import pytest

@pytest.mark.timeout(60)
def test_server_starts_and_contexts_connect(flask_server, player_contexts):
    """Verify Flask server runs and two browsers can connect."""
    page1, page2 = player_contexts
    base_url = flask_server["url"]

    # Navigate both players to the game
    page1.goto(base_url)
    page2.goto(base_url)

    # Verify both pages loaded (look for text-container which is always present)
    assert page1.locator(".text-container").is_visible(timeout=10000)
    assert page2.locator(".text-container").is_visible(timeout=10000)

    # Verify server process is still running
    assert flask_server["process"].poll() is None, "Server crashed during test"
```

This is a minimal smoke test - it proves the infrastructure works without testing game logic.
  </action>
  <verify>
Run: `pytest tests/e2e/test_infrastructure.py -v --headed` (headed mode to see browsers)
Expected: Test passes, two browser windows open briefly, server starts and stops cleanly.
Check: No orphan python processes after test completes (run `ps aux | grep overcooked`)
  </verify>
  <done>
- Smoke test passes: server starts, browsers connect, server stops
- No orphan processes after test run
- Test completes within 60 seconds
  </done>
</task>

</tasks>

<verification>
1. Dependencies installed: `pip install -e ".[test]" && playwright install chromium`
2. Test discovery works: `pytest --collect-only tests/`
3. Smoke test passes: `pytest tests/e2e/test_infrastructure.py -v`
4. Server cleanup verified: `ps aux | grep overcooked` shows no orphans after test
</verification>

<success_criteria>
- Test dependencies defined in pyproject.toml
- Flask server fixture starts/stops cleanly
- Two browser contexts can be created and navigate to game
- Smoke test passes and completes within 60 seconds
- No process leaks after test completion
</success_criteria>

<output>
After completion, create `.planning/phases/40-test-infrastructure/40-01-SUMMARY.md`
</output>
