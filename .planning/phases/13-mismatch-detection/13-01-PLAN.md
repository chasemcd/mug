---
phase: 13-mismatch-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "System identifies exact frame number when hash mismatch occurs (DETECT-01)"
    - "Peer hashes are buffered until local confirmation catches up (DETECT-02)"
    - "Desync events are logged with frame, both hashes, and timestamp (DETECT-03)"
    - "verifiedFrame tracks highest mutually-verified frame (DETECT-04)"
    - "Full state dump is captured when mismatch detected (DETECT-05)"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Mismatch detection logic with verifiedFrame, desyncEvents, comparison methods"
      contains: "verifiedFrame|desyncEvents|_attemptHashComparison|_markFrameVerified|_handleDesync"
  key_links:
    - from: "_handleStateHash()"
      to: "_attemptHashComparison()"
      via: "Called after storing peer hash in pendingPeerHashes"
      pattern: "_attemptHashComparison\\(frameNumber\\)"
    - from: "_computeAndStoreConfirmedHash()"
      to: "_attemptHashComparison()"
      via: "Called after storing local hash in confirmedHashHistory"
      pattern: "_attemptHashComparison\\(frameNumber\\)"
    - from: "_attemptHashComparison()"
      to: "_markFrameVerified() or _handleDesync()"
      via: "Comparison result determines which path"
      pattern: "(this._markFrameVerified|this._handleDesync)"
---

<objective>
Implement mismatch detection logic that compares local and peer state hashes, tracks verified frames, and logs desync events with full context.

Purpose: Enable detection of non-deterministic behavior or networking issues by identifying exactly when peers diverge, with enough diagnostic data to debug the cause.

Output: Working comparison logic that triggers on hash receipt or local confirmation, updates verifiedFrame on match, and captures detailed desync events on mismatch.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-p2p-hash-exchange/12-01-SUMMARY.md
@.planning/research/ARCHITECTURE.md
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verifiedFrame and desyncEvents data structures</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add two new instance properties in the constructor, near the existing hash-related properties (after `this.pendingPeerHashes = new Map();` around line 569):

```javascript
// Mismatch detection state (Phase 13: DETECT-04, DETECT-03)
this.verifiedFrame = -1;  // Highest frame mutually verified by both peers
this.desyncEvents = [];   // [{frame, ourHash, peerHash, timestamp, stateDump}, ...]
```

Also update `clearGGPOState()` (around line 3325) to reset these on episode reset:

```javascript
// Clear mismatch detection state for new episode (DETECT-03, DETECT-04)
this.verifiedFrame = -1;
this.desyncEvents = [];
```

Add this after the existing hash clearing lines (after `this.pendingPeerHashes.clear();`).
  </action>
  <verify>
Grep for `verifiedFrame` and `desyncEvents` in the file - should find declarations in constructor and clearing in clearGGPOState().
  </verify>
  <done>
verifiedFrame initialized to -1 in constructor, desyncEvents initialized to empty array, both reset in clearGGPOState().
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement _attemptHashComparison, _markFrameVerified, and _handleDesync methods</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add three new methods after `_handleStateHash()` (around line 2141). These implement the core comparison logic:

```javascript
/**
 * Attempt to compare hashes for a given frame.
 * Called when either local hash is stored or peer hash is received.
 * Requires both hashes to exist for comparison. (DETECT-01, DETECT-02)
 * @param {number} frameNumber - Frame to compare
 */
_attemptHashComparison(frameNumber) {
    // Skip during rollback - state is in flux
    if (this.rollbackInProgress) {
        return;
    }

    const ourHash = this.confirmedHashHistory.get(frameNumber);
    const peerHash = this.pendingPeerHashes.get(frameNumber);

    // Need both hashes to compare (DETECT-02: peer hash buffered until we catch up)
    if (!ourHash || !peerHash) {
        return;
    }

    // Remove from pending - we're about to process it
    this.pendingPeerHashes.delete(frameNumber);

    // Compare hashes
    if (ourHash === peerHash) {
        this._markFrameVerified(frameNumber);
    } else {
        this._handleDesync(frameNumber, ourHash, peerHash);
    }
}

/**
 * Mark a frame as mutually verified (both peers agree on hash).
 * Updates verifiedFrame to track highest verified frame. (DETECT-04)
 * @param {number} frameNumber - Frame that was verified
 */
_markFrameVerified(frameNumber) {
    // Only update if this is a new high-water mark
    if (frameNumber > this.verifiedFrame) {
        this.verifiedFrame = frameNumber;
        p2pLog.debug(`Frame ${frameNumber} verified - hashes match`);
    }
}

/**
 * Handle a desync (hash mismatch) event.
 * Logs detailed event with frame, both hashes, timestamp, and state dump. (DETECT-01, DETECT-03, DETECT-05)
 * @param {number} frameNumber - Frame where mismatch occurred
 * @param {string} ourHash - Our computed hash for this frame
 * @param {string} peerHash - Peer's hash for this frame
 */
async _handleDesync(frameNumber, ourHash, peerHash) {
    // Capture current state for debugging (DETECT-05)
    let stateDump = null;
    try {
        if (this.stateSyncSupported) {
            const stateJson = await this.pyodide.runPythonAsync(`
import json
_env_state_dump = env.get_state()
json.dumps(_env_state_dump, sort_keys=True, default=str)
`);
            stateDump = JSON.parse(stateJson);
        }
    } catch (e) {
        p2pLog.warn(`Failed to capture state dump for desync: ${e.message}`);
    }

    // Create desync event (DETECT-03)
    const desyncEvent = {
        frame: frameNumber,
        ourHash: ourHash,
        peerHash: peerHash,
        timestamp: Date.now(),
        stateDump: stateDump,
        currentFrame: this.frameNumber,
        verifiedFrameAtDesync: this.verifiedFrame
    };

    this.desyncEvents.push(desyncEvent);

    // Log with high visibility (DETECT-01: exact frame identified)
    p2pLog.warn(
        `DESYNC DETECTED at frame ${frameNumber}: ` +
        `ourHash=${ourHash}, peerHash=${peerHash}, ` +
        `currentFrame=${this.frameNumber}, lastVerified=${this.verifiedFrame}`
    );
}
```

Note: `_handleDesync` is async because it captures state dump via Pyodide. The callers don't need to await it - the event is recorded asynchronously.
  </action>
  <verify>
Grep for `_attemptHashComparison`, `_markFrameVerified`, `_handleDesync` - all three methods should exist with proper JSDoc comments and logging.
  </verify>
  <done>
Three methods implemented: _attemptHashComparison checks both hashes exist and compares, _markFrameVerified updates verifiedFrame high-water mark, _handleDesync captures full event with state dump.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire comparison triggers and add rollback integration</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Update three locations to trigger comparison and handle rollback:

**1. Update `_handleStateHash()` to trigger comparison after storing peer hash:**

Find the method (around line 2128) and add the comparison call after storing:

```javascript
_handleStateHash(buffer) {
    const decoded = decodeStateHash(buffer);
    if (!decoded) {
        p2pLog.warn('Failed to decode state hash message');
        return;
    }

    const { frameNumber, hash } = decoded;

    // Store for comparison (DETECT-02: buffer until local catches up)
    this.pendingPeerHashes.set(frameNumber, hash);

    p2pLog.debug(`Received peer hash for frame ${frameNumber}: ${hash}`);

    // Attempt comparison - will succeed if we have local hash (DETECT-01)
    this._attemptHashComparison(frameNumber);
}
```

**2. Update `_computeAndStoreConfirmedHash()` to trigger comparison after storing local hash:**

Find the method (around line 2036) and add the comparison call after storing hash and queueing for exchange:

```javascript
// After this line: this.pendingHashExchange.push({ frame: frameNumber, hash });
// Add:
// Attempt comparison - will succeed if we have peer hash (DETECT-01)
this._attemptHashComparison(frameNumber);
```

The full context around line 2049-2055 should become:
```javascript
this.confirmedHashHistory.set(frameNumber, hash);

// Queue for P2P exchange (Phase 12)
this.pendingHashExchange.push({ frame: frameNumber, hash });

// Attempt comparison - will succeed if we have peer hash (DETECT-01)
this._attemptHashComparison(frameNumber);

// Prune old entries to prevent memory growth
this._pruneConfirmedHashHistory();
```

**3. Update `performRollback()` to reset verifiedFrame:**

Find the section where confirmedFrame is reset (around line 2978-2980) and add verifiedFrame reset after it:

```javascript
// Also reset confirmedFrame to before rollback point
// (it will be recalculated after replay completes via _updateConfirmedFrame)
this.confirmedFrame = Math.min(this.confirmedFrame, targetFrame - 1);

// Reset verifiedFrame - cannot verify frames that are being replayed (DETECT-04)
this.verifiedFrame = Math.min(this.verifiedFrame, targetFrame - 1);
```
  </action>
  <verify>
1. Grep for `_attemptHashComparison` - should appear in _handleStateHash, _computeAndStoreConfirmedHash, and its own definition (3 locations minimum).
2. Grep for `this.verifiedFrame = Math.min` - should appear in performRollback.
3. Run syntax check: `node --check interactive_gym/server/static/js/pyodide_multiplayer_game.js`
  </verify>
  <done>
Comparison triggered on both peer hash receipt and local hash storage. verifiedFrame reset on rollback to maintain invariant that verified frames are never replayed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax validation:**
   ```bash
   node --check interactive_gym/server/static/js/pyodide_multiplayer_game.js
   ```

2. **Structure verification:**
   ```bash
   # Check data structures exist
   grep -n "this.verifiedFrame" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   grep -n "this.desyncEvents" interactive_gym/server/static/js/pyodide_multiplayer_game.js

   # Check methods exist
   grep -n "_attemptHashComparison\|_markFrameVerified\|_handleDesync" interactive_gym/server/static/js/pyodide_multiplayer_game.js

   # Check wiring complete
   grep -A2 "pendingPeerHashes.set" interactive_gym/server/static/js/pyodide_multiplayer_game.js | grep "_attemptHashComparison"
   grep -A2 "pendingHashExchange.push" interactive_gym/server/static/js/pyodide_multiplayer_game.js | grep "_attemptHashComparison"
   ```

3. **Requirements coverage check:**
   - DETECT-01: `_handleDesync` logs exact frame number
   - DETECT-02: `pendingPeerHashes` buffers until `_attemptHashComparison` finds local hash
   - DETECT-03: `desyncEvents` array stores frame, ourHash, peerHash, timestamp
   - DETECT-04: `verifiedFrame` updated in `_markFrameVerified`, reset in rollback and clearGGPOState
   - DETECT-05: `_handleDesync` captures stateDump via env.get_state()
</verification>

<success_criteria>
- [ ] verifiedFrame and desyncEvents initialized in constructor
- [ ] verifiedFrame and desyncEvents cleared in clearGGPOState()
- [ ] _attemptHashComparison method compares local and peer hashes
- [ ] _markFrameVerified updates verifiedFrame high-water mark
- [ ] _handleDesync logs event with frame, both hashes, timestamp, and state dump
- [ ] _handleStateHash calls _attemptHashComparison after storing peer hash
- [ ] _computeAndStoreConfirmedHash calls _attemptHashComparison after storing local hash
- [ ] performRollback resets verifiedFrame to min(verifiedFrame, targetFrame - 1)
- [ ] All DETECT-01 through DETECT-05 requirements satisfied
- [ ] No JavaScript syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-mismatch-detection/13-01-SUMMARY.md`
</output>
