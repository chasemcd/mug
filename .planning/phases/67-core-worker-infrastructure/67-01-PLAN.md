---
phase: 67-core-worker-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_worker.js
  - interactive_gym/server/static/js/PyodideWorker.js
autonomous: true

must_haves:
  truths:
    - "Pyodide loads in a Web Worker, not the main thread"
    - "Main thread can run setInterval callbacks during Pyodide init (proves non-blocking)"
    - "Worker sends READY event before accepting step/reset commands"
    - "Errors in Worker propagate to main thread as rejected promises"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_worker.js"
      provides: "Worker script that loads Pyodide and handles messages"
      contains: "importScripts"
    - path: "interactive_gym/server/static/js/PyodideWorker.js"
      provides: "Main thread class for Worker communication"
      exports: ["PyodideWorker"]
  key_links:
    - from: "PyodideWorker.js"
      to: "pyodide_worker.js"
      via: "new Worker('/static/js/pyodide_worker.js')"
      pattern: "new Worker"
    - from: "pyodide_worker.js"
      to: "PyodideWorker.js"
      via: "postMessage with typed messages"
      pattern: "self\\.postMessage.*type:"
---

<objective>
Create the foundational Pyodide Web Worker infrastructure: a Worker script (pyodide_worker.js) that runs Pyodide in an isolated thread, and a main thread class (PyodideWorker.js) that provides async methods for init/step/reset operations.

Purpose: Move Pyodide execution off the main thread so Socket.IO can respond to ping messages during WASM compilation, preventing false disconnects during concurrent game startup.

Output: Two new JavaScript files that can be tested standalone before integrating with RemoteGame (Phase 68).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-core-worker-infrastructure/67-RESEARCH.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md

# Existing patterns to follow
@interactive_gym/server/static/js/pyodide_multiplayer_game.js (lines 57-172 for GameTimerWorker pattern)
@interactive_gym/server/static/js/pyodide_remote_game.js (lines 1-80 for current Pyodide usage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pyodide_worker.js (Worker Script)</name>
  <files>interactive_gym/server/static/js/pyodide_worker.js</files>
  <action>
Create the Worker script that:

1. **Uses importScripts for Pyodide CDN** (NOT ES6 import):
   ```javascript
   importScripts('https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js');
   ```

2. **Implements READY gate pattern** (prevents race conditions):
   - `let pyodideReady = false;` and `const messageQueue = [];`
   - Queue messages received before Pyodide loads
   - Process queue after READY sent
   - Send `{ type: 'ready' }` before accepting commands

3. **Message protocol** (from STACK.md):
   - Incoming: `{ type, id, payload }` where type is 'installPackages', 'initEnv', 'step', 'reset'
   - Outgoing: `{ type, id, result?, error?, stage?, message? }`
   - Types: 'progress', 'ready', 'installed', 'envReady', 'result', 'error'

4. **Handler implementations**:
   - `handleInstallPackages(id, payload)`: Loop packages, post progress, post 'installed'
   - `handleInitEnv(id, payload)`: Run envCode via runPythonAsync, post 'envReady'
   - `handleStep(id, payload)`: Run step with actions, convert result with `.toJs()`, post 'result'
   - `handleReset(id, payload)`: Run reset with optional seed, convert result, post 'result'

5. **Error handling** (from PITFALLS.md):
   - Wrap ALL async operations in try/catch
   - Post `{ type: 'error', id, error: { message, stack } }` on failure
   - Never let errors silently swallow

**Critical patterns from research:**
- Use `result.toJs({ depth: 2 })` to convert PyProxy objects before postMessage
- Load micropip immediately after loadPyodide (required for package installation)
- Include timestamp in progress messages for debugging
  </action>
  <verify>
File exists at `interactive_gym/server/static/js/pyodide_worker.js` and contains:
- `importScripts` call for Pyodide CDN
- `pyodideReady` flag and `messageQueue` array
- Handler functions for step/reset/initEnv/installPackages
- try/catch error handling with postMessage
  </verify>
  <done>
pyodide_worker.js created with READY gate pattern, typed message handlers, and error propagation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PyodideWorker.js (Main Thread Class)</name>
  <files>interactive_gym/server/static/js/PyodideWorker.js</files>
  <action>
Create the main thread class that:

1. **ES6 module export** (for import by RemoteGame in Phase 68):
   ```javascript
   export class PyodideWorker {
   ```

2. **Constructor with options**:
   - `this.worker = null;`
   - `this.pendingRequests = new Map();` (id -> {resolve, reject})
   - `this.requestCounter = 0;`
   - `this.onProgress = options.onProgress || null;` (callback for progress events)
   - `this.ready = false;`

3. **init() method**:
   - Create Worker: `new Worker('/static/js/pyodide_worker.js');`
   - Set up onmessage handler calling `_handleMessage`
   - Set up onerror handler for uncaught Worker errors
   - Return Promise that resolves when 'ready' message received
   - Store `this.ready = true` on ready

4. **Public async methods** (all return Promises via _sendRequest):
   - `installPackages(packages)`: Send 'installPackages' with packages array
   - `initEnv(envCode)`: Send 'initEnv' with environment code string
   - `step(actions)`: Send 'step' with actions object, return step result
   - `reset(seed = null)`: Send 'reset' with optional seed, return reset result

5. **destroy() method**:
   - Call `this.worker.terminate()`
   - Clear pendingRequests Map
   - Set worker to null

6. **Private methods**:
   - `_nextId()`: Return `++this.requestCounter`
   - `_sendRequest(type, payload)`: Create Promise, store in pendingRequests Map, postMessage
   - `_handleMessage(event)`: Route by type (progress -> callback, ready -> resolve init, result/error -> resolve/reject pending)

**Critical patterns:**
- Check `this.ready` before allowing step/reset (reject if not ready)
- Always delete from pendingRequests after resolve/reject
- Log progress events with timestamp for debugging
- Worker path must be '/static/js/pyodide_worker.js' (matches Flask static serving)
  </action>
  <verify>
File exists at `interactive_gym/server/static/js/PyodideWorker.js` and contains:
- `export class PyodideWorker`
- `pendingRequests = new Map()`
- `async init()` method that awaits ready
- `step()`, `reset()`, `installPackages()`, `initEnv()` methods
- `destroy()` method
  </verify>
  <done>
PyodideWorker.js created with async init/step/reset API and request/response correlation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Browser Verification Test</name>
  <files>interactive_gym/server/static/js/test_pyodide_worker.html</files>
  <action>
Create a standalone HTML test page that verifies non-blocking behavior:

1. **HTML structure**:
   - Basic HTML5 page with title "PyodideWorker Test"
   - `<div id="log">` for output
   - `<button id="run-test">` to start test

2. **Non-blocking verification test** (WORKER-02 success criteria):
   ```javascript
   let pings = 0;
   const pingInterval = setInterval(() => {
       log(`ping ${++pings} at ${Date.now()}`);
   }, 500);

   const worker = new PyodideWorker({
       onProgress: (stage, msg) => log(`[Progress] ${stage}: ${msg}`)
   });

   await worker.init();  // Should NOT block pings

   clearInterval(pingInterval);
   log(`Non-blocking verified: ${pings} pings during init`);
   // Expect 10-30 pings during typical 5-15 second init
   ```

3. **Functional verification**:
   - Install a simple package (e.g., 'numpy')
   - Init a simple environment: `env = type('Env', (), {'step': lambda s, a: (1,2,3,4,5), 'reset': lambda s: (1,{})})()`
   - Call reset() and log result
   - Call step({}) and log result
   - Call destroy() and verify clean shutdown

4. **Error handling test**:
   - Send step before init completes
   - Verify rejection with appropriate error message

**Import PyodideWorker as ES6 module:**
```html
<script type="module">
import { PyodideWorker } from '/static/js/PyodideWorker.js';
// test code here
</script>
```
  </action>
  <verify>
- File exists at `interactive_gym/server/static/js/test_pyodide_worker.html`
- Contains ES6 import of PyodideWorker
- Contains ping interval test for non-blocking verification
- Contains functional test for step/reset
  </verify>
  <done>
Test page created that can be opened in browser to verify:
1. Main thread remains responsive during Pyodide init (pings continue)
2. READY event received before commands work
3. step/reset return expected results
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
```bash
# Files exist
ls -la interactive_gym/server/static/js/pyodide_worker.js
ls -la interactive_gym/server/static/js/PyodideWorker.js
ls -la interactive_gym/server/static/js/test_pyodide_worker.html

# Worker has required patterns
grep -q "importScripts" interactive_gym/server/static/js/pyodide_worker.js
grep -q "pyodideReady" interactive_gym/server/static/js/pyodide_worker.js
grep -q "messageQueue" interactive_gym/server/static/js/pyodide_worker.js
grep -q "type: 'ready'" interactive_gym/server/static/js/pyodide_worker.js

# Main class has required exports
grep -q "export class PyodideWorker" interactive_gym/server/static/js/PyodideWorker.js
grep -q "pendingRequests" interactive_gym/server/static/js/PyodideWorker.js
grep -q "async init" interactive_gym/server/static/js/PyodideWorker.js
```

**Manual verification (after starting server):**
1. Start dev server: `python -m interactive_gym.run`
2. Open browser to `http://localhost:5001/static/js/test_pyodide_worker.html`
3. Click "Run Test" button
4. Verify:
   - Pings appear at 500ms intervals during Pyodide init (non-blocking)
   - Progress messages appear (Loading Pyodide, Loading micropip)
   - "Non-blocking verified: N pings" message with N > 10
   - Step and reset results appear
   - No console errors
</verification>

<success_criteria>
**WORKER-01 (PyodideWorker class loads Pyodide in Worker):**
- pyodide_worker.js uses importScripts to load Pyodide
- PyodideWorker.js creates Worker and manages lifecycle

**WORKER-02 (Main thread responsive during init):**
- Test page shows 10+ pings during Pyodide initialization
- No main thread blocking visible in browser

**WORKER-03 (READY event before commands):**
- Worker sends { type: 'ready' } after loadPyodide completes
- PyodideWorker.init() resolves only after ready received
- step/reset before ready results in rejection
</success_criteria>

<output>
After completion, create `.planning/phases/67-core-worker-infrastructure/67-01-SUMMARY.md`
</output>
