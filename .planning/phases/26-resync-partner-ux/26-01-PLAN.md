---
phase: 26-resync-partner-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "When backgrounded player refocuses, buffered inputs are processed rapidly"
    - "Focused partner's game loop never pauses or stutters"
    - "Focused partner sees backgrounded player go idle (using defaultAction)"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "_performFastForward method for catching up after background period"
      contains: "_performFastForward"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "_pendingFastForward flag and refocus trigger"
      contains: "_pendingFastForward"
  key_links:
    - from: "FocusManager._onForegrounded"
      to: "_pendingFastForward flag"
      via: "callback sets flag to true"
      pattern: "_pendingFastForward = true"
    - from: "_handleWorkerTick"
      to: "_performFastForward"
      via: "checks flag and calls fast-forward"
      pattern: "_pendingFastForward.*_performFastForward"
    - from: "_performFastForward"
      to: "storeRemoteInput"
      via: "injects buffered inputs into GGPO buffer"
      pattern: "storeRemoteInput.*packet"
---

<objective>
Implement fast-forward resync when backgrounded player refocuses, while keeping focused partner uninterrupted

Purpose: When a player tabs away and returns, they need to catch up to the current game state by processing all buffered partner inputs rapidly. The partner who stayed focused should experience zero interruption - they already see the backgrounded player going idle (defaultAction) via the existing P2P input flow from Phase 25.

Output:
- `_performFastForward()` method that drains buffered inputs and steps through frames rapidly
- Refocus callback hook that triggers fast-forward
- Safety limits to prevent browser freeze on long background periods
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-focus-detection/25-01-SUMMARY.md
@.planning/phases/26-resync-partner-ux/26-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement _performFastForward method</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add `_performFastForward()` method to `MultiplayerPyodideGame` class, near the other GGPO methods (after `performRollback`).

Implementation:
1. Drain buffered inputs via `this.focusManager.drainBufferedInputs()`
2. Return early if no buffered inputs
3. Inject each buffered input into GGPO buffer via `this.storeRemoteInput(playerId, action, frame)` for each input in each packet
4. Determine target frame from max frame number in buffered inputs
5. Set `this.rollbackInProgress = true` to prevent nested operations
6. Fast-forward loop: step each frame from current to target without rendering
   - Get human player IDs via existing pattern (filter policyMapping for 'human')
   - Get inputs via `this.getInputsForFrame(frame, humanPlayerIds, false)` (false = don't track predictions)
   - Build finalActions for all agents (humans from buffer, bots from lastExecutedActions or defaultAction)
   - Call `await this.stepWithActions(finalActions)`
   - Record in actionSequence (same pattern as normal step)
   - Increment frameNumber
   - Prune periodically (every 20 frames)
7. Safety limits: MAX_FRAMES = 300 (30s at 10fps), MAX_MS = 1000 (1 second processing time)
8. Log start and end with frame count and elapsed time via p2pLog.warn (important event)
9. Set `this.rollbackInProgress = false` in finally block

Pattern to follow: Adapt from existing `performRollback()` method which already does frame-by-frame stepping without rendering.

DO NOT:
- Trigger rollbacks during fast-forward (the rollbackInProgress guard handles this)
- Save snapshots during fast-forward (skip for performance)
- Compute hashes during fast-forward (skip for performance)
- Render during fast-forward (stepWithActions doesn't render, just steps)
  </action>
  <verify>
Grep for `_performFastForward` in the file confirms method exists with:
- `drainBufferedInputs()` call
- `storeRemoteInput` calls
- `rollbackInProgress = true/false`
- `stepWithActions` call
- MAX_FRAMES and MAX_MS constants
  </verify>
  <done>
`_performFastForward()` method exists and follows research patterns for batch frame processing with safety limits
  </done>
</task>

<task type="auto">
  <name>Task 2: Hook fast-forward into refocus event</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Wire up the fast-forward trigger:

1. Add `_pendingFastForward` property:
   - Initialize to `false` in constructor (near other state flags)

2. Hook into FocusManager's foregrounded event:
   - In constructor, after creating FocusManager, save reference to original `_onForegrounded`
   - Override to set `this._pendingFastForward = true` AND call original behavior
   - Example:
     ```javascript
     const originalOnForegrounded = this.focusManager._onForegrounded.bind(this.focusManager);
     this.focusManager._onForegrounded = () => {
         originalOnForegrounded();
         this._pendingFastForward = true;
         p2pLog.info('Tab foregrounded - scheduling fast-forward');
     };
     ```

3. Check for pending fast-forward in `_handleWorkerTick`:
   - AFTER the reconnection pause check
   - BEFORE the isBackgrounded check (critical - we're no longer backgrounded when this fires)
   - If `_pendingFastForward` is true AND NOT `this.focusManager.isBackgrounded`:
     - Set `_pendingFastForward = false`
     - Call `await this._performFastForward()`
     - Continue to normal tick (don't return - we want to process current frame after catching up)
   - Note: `_handleWorkerTick` needs to be async or use `.then()` pattern

Pattern:
```javascript
// In _handleWorkerTick, after reconnection check, before isBackgrounded check:
if (this._pendingFastForward && !this.focusManager?.isBackgrounded) {
    this._pendingFastForward = false;
    await this._performFastForward();
    // Continue to normal tick processing
}
```

Important: Since `_handleWorkerTick` may need to be async, ensure the tick callback pattern supports this. The existing code already uses async in `step()` which is called from the callback, so this should work.
  </action>
  <verify>
1. Grep for `_pendingFastForward` shows initialization and usage
2. Grep for `Tab foregrounded - scheduling fast-forward` shows the hook is in place
3. Grep in `_handleWorkerTick` shows the fast-forward check before the backgrounded check
  </verify>
  <done>
Fast-forward is triggered on refocus via _pendingFastForward flag, checked in _handleWorkerTick before backgrounded check
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify partner experience is uninterrupted</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Verify that PARTNER-01 and PARTNER-02 are already satisfied by Phase 25 implementation:

1. Read and confirm the existing code handles partner experience:
   - In `_handleInputPacket`: When local player is NOT backgrounded, partner inputs are processed normally
   - The backgrounded player sends `defaultAction` via normal P2P (their local input logic uses defaultAction when backgrounded)
   - Partner's game loop has NO knowledge of other player's focus state - it just receives inputs and steps

2. Add a clarifying comment in `_handleWorkerTick` near the backgrounded check:
   ```javascript
   // Phase 25/26: Skip processing when tab is backgrounded
   // Worker keeps ticking (so we know elapsed time), but we don't advance frames.
   // Partner inputs are buffered; we'll fast-forward on refocus (Phase 26).
   // IMPORTANT: Partner's game loop is unaffected - they continue receiving our
   // defaultAction inputs and stepping normally (PARTNER-01, PARTNER-02).
   ```

3. Confirm in `step()` that when backgrounded, local action is `defaultAction`:
   - This happens because `allActionsDict[this.myPlayerId]` comes from the input system which returns defaultAction when no input is collected
   - The P2P send still happens with this defaultAction, so partner receives it
   - Add a brief comment if not already clear

This task is primarily verification that existing code satisfies requirements, with minor documentation additions.
  </action>
  <verify>
1. Read `_handleInputPacket` - confirm NO special handling for partner's focus state (just processes inputs normally)
2. Read `step()` - confirm local action falls back to defaultAction when needed
3. Grep for "PARTNER-01" or "PARTNER-02" shows new comments documenting this
  </verify>
  <done>
Partner experience requirements (PARTNER-01, PARTNER-02) are documented as satisfied by existing Phase 25 code - partner continues uninterrupted while backgrounded player sends idle inputs
  </done>
</task>

</tasks>

<verification>
All requirements validated:

1. **BG-03 (fast-forward on refocus):**
   - `_performFastForward()` method drains buffered inputs and steps through frames
   - `_pendingFastForward` flag triggers fast-forward on first tick after refocus
   - Safety limits prevent browser freeze

2. **PARTNER-01 (no interruption):**
   - Partner's game loop has no synchronization points with backgrounded player
   - Partner receives inputs normally, steps normally
   - No pause or special handling when partner backgrounds

3. **PARTNER-02 (sees idle):**
   - Backgrounded player sends defaultAction via P2P
   - Partner receives and uses these inputs normally
   - Visual result: backgrounded player appears to do nothing (idle)

Console verification:
1. Open game in two browser tabs
2. Start multiplayer game
3. Tab away from one tab for 5-10 seconds
4. Tab back - should see "FAST-FORWARD" log with frame count
5. Focused tab should show no stuttering or pauses in its console
</verification>

<success_criteria>
- [ ] `_performFastForward()` method exists with buffered input processing and safety limits
- [ ] `_pendingFastForward` flag set on foregrounded event
- [ ] `_handleWorkerTick` checks flag and calls fast-forward before backgrounded check
- [ ] Partner experience documented as uninterrupted (existing behavior)
- [ ] No new external dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/26-resync-partner-ux/26-01-SUMMARY.md`
</output>
