---
phase: 36-buffer-split
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Frame data is written to speculative buffer during step() execution"
    - "Data is promoted to canonical buffer only when all inputs for that frame are received"
    - "Export reads only from canonical buffer (frameDataBuffer)"
    - "Rollback clears both speculative and canonical buffers for frames >= target"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Dual-buffer data recording architecture"
      contains: "speculativeFrameData"
  key_links:
    - from: "storeFrameData()"
      to: "speculativeFrameData"
      via: "Map.set() call"
      pattern: "this\\.speculativeFrameData\\.set"
    - from: "_updateConfirmedFrame()"
      to: "_promoteConfirmedFrames()"
      via: "method call at end"
      pattern: "this\\._promoteConfirmedFrames\\(\\)"
    - from: "_promoteConfirmedFrames()"
      to: "frameDataBuffer"
      via: "promotion when frame <= confirmedFrame"
      pattern: "this\\.frameDataBuffer\\.set.*speculativeFrameData"
---

<objective>
Separate speculative frame data from confirmed frame data using a dual-buffer architecture.

Purpose: Fix data export parity â€” both players export identical game data regardless of rollbacks, by ensuring only confirmed-frame data is exported.

Output: Modified `pyodide_multiplayer_game.js` with `speculativeFrameData` buffer, modified `storeFrameData()`, new `_promoteConfirmedFrames()` method, and extended rollback clearing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-buffer-split/36-RESEARCH.md
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add speculativeFrameData buffer and modify storeFrameData()</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
1. In the constructor (around line 1024, after `this.frameDataBuffer = new Map();`), add:
```javascript
// Speculative frame data buffer - holds unconfirmed frame data
// Data is promoted to frameDataBuffer when confirmedFrame advances
this.speculativeFrameData = new Map();
```

2. Modify the `storeFrameData()` method (around line 3547) to write to `speculativeFrameData` instead of `frameDataBuffer`:

Before:
```javascript
storeFrameData(frameNumber, data) {
    this.frameDataBuffer.set(frameNumber, {
```

After:
```javascript
/**
 * Store frame data in the speculative buffer.
 * Data will be promoted to canonical buffer (frameDataBuffer) when confirmedFrame advances.
 * On rollback, speculative data is cleared and re-stored during replay.
 */
storeFrameData(frameNumber, data) {
    this.speculativeFrameData.set(frameNumber, {
```

The rest of the method body remains unchanged (actions, rewards, terminateds, truncateds, infos, isFocused, timestamp).
  </action>
  <verify>
1. Grep for `this.speculativeFrameData = new Map()` to confirm initialization
2. Grep for `this.speculativeFrameData.set` in storeFrameData to confirm redirect
3. Verify `frameDataBuffer.set` does NOT appear in storeFrameData (only in promotion method)
  </verify>
  <done>
- speculativeFrameData Map initialized in constructor
- storeFrameData() writes to speculativeFrameData instead of frameDataBuffer
  </done>
</task>

<task type="auto">
  <name>Task 2: Add _promoteConfirmedFrames() and integrate into _updateConfirmedFrame()</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
1. Add new method `_promoteConfirmedFrames()` after `_updateConfirmedFrame()` (around line 2951):

```javascript
/**
 * Promote confirmed frame data from speculative to canonical buffer.
 * Only frames where frame <= confirmedFrame are promoted.
 * This ensures only data with confirmed inputs is exported.
 */
_promoteConfirmedFrames() {
    const promoted = [];
    for (const [frame, data] of this.speculativeFrameData.entries()) {
        if (frame <= this.confirmedFrame) {
            // Promote to canonical buffer
            this.frameDataBuffer.set(frame, data);
            promoted.push(frame);
        }
    }
    // Remove promoted entries from speculative buffer
    for (const frame of promoted) {
        this.speculativeFrameData.delete(frame);
    }
    if (promoted.length > 0) {
        p2pLog.debug(`Promoted ${promoted.length} frames to canonical buffer (up to frame ${this.confirmedFrame})`);
    }
}
```

2. At the END of `_updateConfirmedFrame()` (around line 2950, after the for loop), add the promotion call:

```javascript
        // ... existing for loop ends here ...
        }
    }

    // Promote confirmed frames to canonical buffer (Phase 36)
    this._promoteConfirmedFrames();
}
```

Note: The call to `_promoteConfirmedFrames()` must be AFTER the for loop that updates `this.confirmedFrame`, so that promotion happens with the updated confirmation boundary.
  </action>
  <verify>
1. Grep for `_promoteConfirmedFrames` to confirm method exists and is called
2. Grep for `frameDataBuffer.set.*speculativeFrameData` to confirm promotion pattern
3. Verify promotion is called at the END of _updateConfirmedFrame()
  </verify>
  <done>
- _promoteConfirmedFrames() method exists
- Method promotes frames where frame <= confirmedFrame from speculative to canonical
- Method is called at the end of _updateConfirmedFrame()
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend clearFrameDataFromRollback() and episode reset to clear both buffers</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
1. Extend `clearFrameDataFromRollback()` (around line 3563) to clear BOTH buffers:

Before:
```javascript
clearFrameDataFromRollback(targetFrame) {
    for (const frame of this.frameDataBuffer.keys()) {
        if (frame >= targetFrame) {
            this.frameDataBuffer.delete(frame);
        }
    }
    p2pLog.debug(`Cleared frame data buffer from frame ${targetFrame} onwards`);
}
```

After:
```javascript
/**
 * Clear frame data buffer entries from rollback target onwards.
 * Clears both speculative and canonical buffers to ensure
 * replayed frames are stored with correct data.
 */
clearFrameDataFromRollback(targetFrame) {
    // Clear canonical buffer (safety valve - shouldn't have unconfirmed frames)
    for (const frame of this.frameDataBuffer.keys()) {
        if (frame >= targetFrame) {
            this.frameDataBuffer.delete(frame);
        }
    }
    // Clear speculative buffer (primary target - unconfirmed frames)
    for (const frame of this.speculativeFrameData.keys()) {
        if (frame >= targetFrame) {
            this.speculativeFrameData.delete(frame);
        }
    }
    p2pLog.debug(`Cleared frame data buffers from frame ${targetFrame} onwards`);
}
```

2. In the episode reset section (around line 1835 where `this.frameDataBuffer.clear()` is called), also clear the speculative buffer:

After the existing line:
```javascript
// Clear frame data buffer for new episode
this.frameDataBuffer.clear();
```

Add:
```javascript
this.speculativeFrameData.clear();
```

3. Also clear speculative buffer after emitEpisodeData (around line 3726):

After the existing line:
```javascript
// Clear the buffer after emitting
this.frameDataBuffer.clear();
```

Add:
```javascript
this.speculativeFrameData.clear();
```
  </action>
  <verify>
1. Grep for `speculativeFrameData.keys()` in clearFrameDataFromRollback to confirm rollback clearing
2. Grep for `speculativeFrameData.clear()` to confirm episode reset clearing (should appear twice - in reset and after emit)
3. Run a quick console test: verify that after rollback, both buffers are cleared for frames >= target
  </verify>
  <done>
- clearFrameDataFromRollback() clears both frameDataBuffer and speculativeFrameData
- Episode reset clears both buffers
- Post-emit cleanup clears both buffers
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the complete data flow:

1. **Speculative storage**: Run game, check that after step() data is in speculativeFrameData:
   - In browser console: `window.pyodideGame.speculativeFrameData.size` should be > 0 after a few frames

2. **Promotion**: Check that after _updateConfirmedFrame(), data moves to frameDataBuffer:
   - `window.pyodideGame.frameDataBuffer.size` should grow as frames are confirmed
   - `window.pyodideGame.speculativeFrameData.size` should decrease after promotion

3. **Rollback clearing**: Trigger a rollback (high latency) and verify both buffers cleared:
   - Console logs should show "Cleared frame data buffers from frame X onwards"

4. **Export integrity**: At episode end, verify frameDataBuffer contains only confirmed data:
   - Export should have no gaps in frame numbers
   - Both players should export identical action sequences
</verification>

<success_criteria>
- [ ] `speculativeFrameData` Map exists and is initialized in constructor
- [ ] `storeFrameData()` writes to `speculativeFrameData`, NOT `frameDataBuffer`
- [ ] `_promoteConfirmedFrames()` method exists and promotes frames where frame <= confirmedFrame
- [ ] `_promoteConfirmedFrames()` is called at the END of `_updateConfirmedFrame()`
- [ ] `clearFrameDataFromRollback()` clears BOTH buffers
- [ ] Episode reset clears BOTH buffers
- [ ] Console logs show promotion activity: "Promoted N frames to canonical buffer"
- [ ] Requirements REC-01, REC-02, REC-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/36-buffer-split/36-01-SUMMARY.md`
</output>
