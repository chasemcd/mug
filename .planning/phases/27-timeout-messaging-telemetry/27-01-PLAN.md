---
phase: 27-timeout-messaging-telemetry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/scenes/gym_scene.py
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Focus loss timeout is configurable via Python API (default 30s)"
    - "When timeout exceeded, game ends for both players with in-page overlay"
    - "Custom message displayed when game ends due to focus loss"
    - "Focus loss events (backgroundPeriods) included in exported metrics"
    - "Duration of each focus loss period included in exported data"
  artifacts:
    - path: "interactive_gym/scenes/gym_scene.py"
      provides: "focus_loss_config() method with timeout_ms and message parameters"
      contains: "focus_loss_timeout_ms"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Timeout check in FocusManager, focus telemetry in metrics export"
      contains: "focusLoss"
  key_links:
    - from: "gym_scene.py"
      to: "pyodide_multiplayer_game.js"
      via: "scene_metadata.focus_loss_timeout_ms"
      pattern: "focus_loss_timeout_ms"
    - from: "FocusManager"
      to: "_handleWorkerTick"
      via: "checkTimeout() call during background state"
      pattern: "checkTimeout"
    - from: "FocusManager"
      to: "exportMultiplayerMetrics"
      via: "getTelemetry() inclusion in metrics"
      pattern: "focusManager.*getTelemetry"
---

<objective>
Add configurable focus loss timeout with graceful game ending and research telemetry export.

Purpose: Complete v1.5 milestone by providing researchers with configurable timeout behavior when participants tab away, plus comprehensive focus loss data for research analysis.

Output:
- Python config API for timeout (default 30s) and custom message
- Client-side timeout enforcement with game-end overlay
- Focus loss telemetry in exported multiplayer metrics
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior phase references
@.planning/phases/25-focus-detection/25-01-SUMMARY.md (FocusManager with getTelemetry)
@.planning/phases/26-resync-partner-ux/26-01-SUMMARY.md (fast-forward, _pendingFastForward)

# Source files
@interactive_gym/scenes/gym_scene.py (config API patterns)
@interactive_gym/server/static/js/pyodide_multiplayer_game.js (FocusManager, metrics export)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Python config API for focus loss timeout and message</name>
  <files>
    interactive_gym/scenes/gym_scene.py
  </files>
  <action>
Add focus loss configuration following the established patterns from `reconnection_config()` and `partner_disconnect_message_config()`.

**1. Add attributes after `partner_disconnect_message` (around line 188):**

```python
# Focus loss timeout and message (Phase 27)
self.focus_loss_timeout_ms: int = 30000  # Default 30 seconds (TIMEOUT-01)
self.focus_loss_message: str | None = None  # Custom message, None uses default
```

**2. Add builder method after `partner_disconnect_message_config()` (around line 808):**

```python
def focus_loss_config(
    self,
    timeout_ms: int = NotProvided,
    message: str = NotProvided,
):
    """Configure focus loss handling for multiplayer games.

    When a player tabs away from the game for longer than the timeout,
    the game ends for both players with an in-page overlay message.

    :param timeout_ms: Time in milliseconds before game ends due to focus loss (default: 30000)
    :type timeout_ms: int
    :param message: Custom message to display when game ends due to focus loss timeout
    :type message: str

    :returns: self for method chaining

    Example::

        scene.focus_loss_config(
            timeout_ms=15000,  # 15 seconds
            message="You were away too long. The experiment has ended."
        )
    """
    if timeout_ms is not NotProvided:
        self.focus_loss_timeout_ms = timeout_ms
    if message is not NotProvided:
        self.focus_loss_message = message

    return self
```

The attributes are already included in scene_metadata via the existing `vars(self)` serialization pattern used for other config values.
  </action>
  <verify>
```bash
grep -n "focus_loss_timeout_ms\|focus_loss_message\|focus_loss_config" interactive_gym/scenes/gym_scene.py
```
Expect: attribute declarations (~line 189-190), builder method (~line 810+)
  </verify>
  <done>
GymScene has `focus_loss_config()` builder method accepting `timeout_ms` (default 30000) and `message` parameters. Attributes are serialized to client via scene_metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement timeout check and game-end flow in FocusManager</name>
  <files>
    interactive_gym/server/static/js/pyodide_multiplayer_game.js
  </files>
  <action>
Add timeout enforcement to FocusManager and integrate with game-end flow.

**1. Add timeout config property to FocusManager class (after `constructor`):**

In `FocusManager` constructor, add:
```javascript
// Timeout config (Phase 27 - TIMEOUT-01)
this.timeoutMs = 30000; // Default 30s, overridden from scene_metadata
this.timeoutTriggered = false;
this.onTimeout = null; // Callback when timeout is exceeded
```

**2. Add `setTimeoutConfig()` method to FocusManager:**

```javascript
/**
 * Configure timeout settings from scene_metadata.
 * @param {number} timeoutMs - Timeout in milliseconds
 * @param {Function} onTimeout - Callback when timeout exceeded
 */
setTimeoutConfig(timeoutMs, onTimeout) {
    this.timeoutMs = timeoutMs;
    this.onTimeout = onTimeout;
    p2pLog.info(`Focus loss timeout configured: ${timeoutMs}ms`);
}
```

**3. Add `checkTimeout()` method to FocusManager:**

```javascript
/**
 * Check if current background period exceeds timeout.
 * Called from _handleWorkerTick when backgrounded.
 * @returns {boolean} True if timeout exceeded
 */
checkTimeout() {
    if (!this.isBackgrounded || this.timeoutTriggered) {
        return false;
    }

    const currentPeriod = this.backgroundPeriods[this.backgroundPeriods.length - 1];
    if (!currentPeriod || currentPeriod.endTime !== null) {
        return false;
    }

    const durationMs = Date.now() - currentPeriod.startTime;
    if (durationMs >= this.timeoutMs) {
        this.timeoutTriggered = true;
        p2pLog.warn(`Focus loss timeout exceeded: ${durationMs}ms >= ${this.timeoutMs}ms`);
        if (this.onTimeout) {
            this.onTimeout();
        }
        return true;
    }
    return false;
}
```

**4. Update FocusManager `reset()` to clear timeout state:**

```javascript
reset() {
    this.backgroundPeriods = [];
    this.backgroundInputBuffer = [];
    this.timeoutTriggered = false; // Add this line
}
```

**5. In PyodideMultiplayerGame constructor, after storing config, read focus loss settings:**

Find where `partner_disconnect_message` is read from scene_metadata (around line 1085) and add after it:
```javascript
// Focus loss timeout config (Phase 27 - TIMEOUT-01)
if (data.scene_metadata?.focus_loss_timeout_ms) {
    const timeoutMs = data.scene_metadata.focus_loss_timeout_ms;
    const message = data.scene_metadata.focus_loss_message;
    this.config.focus_loss_timeout_ms = timeoutMs;
    this.config.focus_loss_message = message;
    p2pLog.info(`Focus loss config: timeout=${timeoutMs}ms, message=${message || '(default)'}`);
}
```

**6. After FocusManager is created (in constructor, after `this.focusManager = new FocusManager()`), configure timeout:**

```javascript
// Configure focus loss timeout (Phase 27)
if (this.config?.focus_loss_timeout_ms) {
    this.focusManager.setTimeoutConfig(
        this.config.focus_loss_timeout_ms,
        () => this._handleFocusLossTimeout()
    );
}
```

**7. Add `_handleFocusLossTimeout()` method (after `_handleReconnectionGameEnd`):**

```javascript
/**
 * Handle focus loss timeout - game ends for both players (Phase 27 - TIMEOUT-02, TIMEOUT-03).
 * Similar to partner disconnection flow but triggered by local focus loss timeout.
 */
_handleFocusLossTimeout() {
    p2pLog.warn('Focus loss timeout - ending game');

    // Stop the game loop
    this._destroyTimerWorker();

    // Mark session as partial with focus_loss_timeout reason
    this.sessionPartialInfo = {
        isPartial: true,
        terminationReason: 'focus_loss_timeout',
        timeoutMs: this.config?.focus_loss_timeout_ms || 30000,
        backgroundDurationMs: this.focusManager?.getTelemetry()?.totalBackgroundMs || 0
    };

    // Export metrics before showing overlay (Phase 27 - TELEM-01, TELEM-02)
    if (typeof socket !== 'undefined' && this.sceneId) {
        this.emitMultiplayerMetrics(this.sceneId);
    }

    // Get custom message or default
    const customMessage = this.config?.focus_loss_message;
    const message = customMessage || "You were away from the game for too long. The game has ended.";

    // Show in-page overlay (reuse partner disconnect overlay pattern)
    this._showFocusLossTimeoutOverlay(message);

    // Notify server that game ended due to focus loss
    if (typeof socket !== 'undefined') {
        socket.emit('leave_game', { session_id: window.sessionId });
        socket.emit('p2p_focus_loss_timeout', {
            game_id: this.gameId,
            player_id: this.myPlayerId,
            timeout_ms: this.config?.focus_loss_timeout_ms || 30000,
            background_duration_ms: this.focusManager?.getTelemetry()?.totalBackgroundMs || 0
        });
    }

    // Close P2P connection
    if (this.webrtcManager) {
        this.webrtcManager.close();
    }
}
```

**8. Add `_showFocusLossTimeoutOverlay()` method (after `_showPartnerDisconnectedOverlay`):**

```javascript
/**
 * Show focus loss timeout overlay (Phase 27 - TIMEOUT-03).
 * Reuses partner disconnect overlay pattern.
 * @param {string} message - Message to display
 */
_showFocusLossTimeoutOverlay(message) {
    // Hide game UI elements (same as partner disconnect)
    const gameContainer = document.getElementById('gameContainer');
    const hudText = document.getElementById('hudText');
    if (gameContainer) gameContainer.style.display = 'none';
    if (hudText) hudText.style.display = 'none';

    // Create full-page overlay
    const overlay = document.createElement('div');
    overlay.id = 'focusLossTimeoutOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        color: white;
        font-family: Arial, sans-serif;
    `;

    // Add message
    const messageEl = document.createElement('div');
    messageEl.style.cssText = `
        font-size: 24px;
        text-align: center;
        max-width: 600px;
        padding: 20px;
        line-height: 1.5;
    `;
    messageEl.textContent = message;
    overlay.appendChild(messageEl);

    document.body.appendChild(overlay);
    p2pLog.info('Focus loss timeout overlay displayed');
}
```

**9. In `_handleWorkerTick`, add timeout check when backgrounded:**

Find the early return when backgrounded (around where `if (this.focusManager?.isBackgrounded)` check is). BEFORE the early return, add:
```javascript
// Check for focus loss timeout (Phase 27 - TIMEOUT-02)
if (this.focusManager.checkTimeout()) {
    return; // Timeout handler will end the game
}
```

This should be placed INSIDE the `if (this.focusManager?.isBackgrounded)` block, before any other processing or early return.
  </action>
  <verify>
```bash
grep -n "checkTimeout\|setTimeoutConfig\|_handleFocusLossTimeout\|_showFocusLossTimeoutOverlay\|focus_loss_timeout_ms" interactive_gym/server/static/js/pyodide_multiplayer_game.js | head -20
```
Expect: All method definitions and config reading present
  </verify>
  <done>
FocusManager has `checkTimeout()` method called every tick while backgrounded. When timeout exceeded, `_handleFocusLossTimeout()` stops game, exports metrics, shows overlay with configurable message, and notifies server.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add focus telemetry to multiplayer metrics export</name>
  <files>
    interactive_gym/server/static/js/pyodide_multiplayer_game.js
  </files>
  <action>
Add focus loss telemetry to the exported metrics for research analysis.

**1. In `exportMultiplayerMetrics()`, add focus loss data section:**

Find `exportMultiplayerMetrics()` method. After the `connection:` block (around line 6216) and before `inputDelivery:`, add:

```javascript
// Focus loss telemetry (Phase 27 - TELEM-01, TELEM-02)
focusLoss: this.focusManager ? {
    backgroundPeriods: this.focusManager.getTelemetry().backgroundPeriods,
    totalBackgroundMs: this.focusManager.getTelemetry().totalBackgroundMs,
    periodCount: this.focusManager.getTelemetry().periodCount,
    timeoutTriggered: this.focusManager.timeoutTriggered,
    timeoutConfigMs: this.config?.focus_loss_timeout_ms || null
} : null,
```

**2. In `exportSessionMetrics()`, add focus loss summary:**

Find `exportSessionMetrics()` method. After the `sync:` block, add:

```javascript
// Focus loss (Phase 27)
focusLoss: this.focusManager ? {
    totalBackgroundMs: this.focusManager.getTelemetry().totalBackgroundMs,
    periodCount: this.focusManager.getTelemetry().periodCount,
    timeoutTriggered: this.focusManager.timeoutTriggered
} : null,
```

**3. Add `sessionPartialInfo` to `exportMultiplayerMetrics()` output:**

In the return object of `exportMultiplayerMetrics()`, after `focusLoss:`, add:

```javascript
// Session partial info (Phase 27)
sessionPartial: this.sessionPartialInfo || null,
```
  </action>
  <verify>
```bash
grep -n "focusLoss:" interactive_gym/server/static/js/pyodide_multiplayer_game.js
```
Expect: focusLoss blocks in both exportMultiplayerMetrics and exportSessionMetrics

```bash
grep -n "backgroundPeriods\|totalBackgroundMs\|timeoutTriggered" interactive_gym/server/static/js/pyodide_multiplayer_game.js | grep -v "FocusManager\|getTelemetry"
```
Expect: References in export methods
  </verify>
  <done>
`exportMultiplayerMetrics()` includes full focus loss telemetry (backgroundPeriods with timestamps, totalBackgroundMs, periodCount, timeoutTriggered). `exportSessionMetrics()` includes summary. Both exported when game ends normally or due to timeout.
  </done>
</task>

</tasks>

<verification>
```bash
# Config API
grep -n "focus_loss_config\|focus_loss_timeout_ms\|focus_loss_message" interactive_gym/scenes/gym_scene.py

# Client-side timeout handling
grep -n "checkTimeout\|setTimeoutConfig\|_handleFocusLossTimeout" interactive_gym/server/static/js/pyodide_multiplayer_game.js

# Telemetry export
grep -n "focusLoss:" interactive_gym/server/static/js/pyodide_multiplayer_game.js

# All requirements covered
echo "TIMEOUT-01: focus_loss_timeout_ms default 30000"
echo "TIMEOUT-02: checkTimeout() -> _handleFocusLossTimeout()"
echo "TIMEOUT-03: focus_loss_message in overlay"
echo "TELEM-01: backgroundPeriods in exportMultiplayerMetrics"
echo "TELEM-02: totalBackgroundMs, period durations in export"
```
</verification>

<success_criteria>
1. `GymScene.focus_loss_config(timeout_ms=15000, message="...")` configures timeout and message
2. Default timeout is 30 seconds when not configured
3. When player is backgrounded longer than timeout, game ends with overlay
4. Custom message displayed in overlay when configured
5. Default message "You were away from the game for too long..." when not configured
6. `exportMultiplayerMetrics()` includes `focusLoss` object with:
   - `backgroundPeriods` array with start/end/duration for each period
   - `totalBackgroundMs` cumulative background time
   - `periodCount` number of focus loss events
   - `timeoutTriggered` boolean
7. Server notified via `p2p_focus_loss_timeout` socket event
</success_criteria>

<output>
After completion, create `.planning/phases/27-timeout-messaging-telemetry/27-01-SUMMARY.md`
</output>
