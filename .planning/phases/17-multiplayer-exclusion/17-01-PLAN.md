---
phase: 17-multiplayer-exclusion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/app.py
  - interactive_gym/server/pyodide_game_coordinator.py
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Non-excluded player sees 'Your partner experienced a technical issue' message"
    - "Game terminates cleanly for both players when one is excluded"
    - "Valid game data up to exclusion point is preserved"
    - "Session data marked as partial with termination reason"
  artifacts:
    - path: "interactive_gym/server/app.py"
      provides: "mid_game_exclusion socket handler"
      contains: "@socketio.on('mid_game_exclusion')"
    - path: "interactive_gym/server/pyodide_game_coordinator.py"
      provides: "handle_player_exclusion method"
      contains: "def handle_player_exclusion"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "partner_excluded event handler and partial session tracking"
      contains: "socket.on('partner_excluded'"
  key_links:
    - from: "app.py mid_game_exclusion handler"
      to: "PyodideGameCoordinator.handle_player_exclusion()"
      via: "PYODIDE_COORDINATOR method call"
      pattern: "PYODIDE_COORDINATOR\\.handle_player_exclusion"
    - from: "handle_player_exclusion()"
      to: "partner's socket"
      via: "emit partner_excluded event"
      pattern: "emit.*partner_excluded"
    - from: "partner_excluded handler"
      to: "exportMultiplayerMetrics()"
      via: "sessionPartialInfo assignment before export"
      pattern: "sessionPartialInfo.*isPartial"
---

<objective>
Implement coordinated game termination when one player is excluded mid-game.

Purpose: When continuous monitoring (Phase 16) excludes a player, their partner needs clear notification ("Your partner experienced a technical issue"), clean game termination, and preserved data marked as a partial session.

Output: Server-side handler for `mid_game_exclusion` event, partner notification via `partner_excluded` event, and partial session markers in exported metrics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-multiplayer-exclusion/17-01-RESEARCH.md
@.planning/phases/16-continuous-monitoring/16-01-SUMMARY.md
@interactive_gym/server/app.py
@interactive_gym/server/pyodide_game_coordinator.py
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side exclusion handler and coordinator method</name>
  <files>
    interactive_gym/server/app.py
    interactive_gym/server/pyodide_game_coordinator.py
  </files>
  <action>
    **In app.py** (after the pyodide_player_action handler, ~line 1297):
    Add `@socketio.on('mid_game_exclusion')` handler that:
    1. Validates PYODIDE_COORDINATOR exists
    2. Extracts game_id, player_id (as excluded_player_id), reason, frame_number from data
    3. Logs the exclusion event
    4. Calls `PYODIDE_COORDINATOR.handle_player_exclusion(game_id, excluded_player_id, reason, frame_number)`

    **In pyodide_game_coordinator.py** (after `handle_webrtc_signal` method, ~line 552):
    Add `handle_player_exclusion()` method that:
    1. Acquires lock, validates game_id and player_id exist
    2. Finds partner socket(s) by iterating game.players excluding the excluded player
    3. Emits `partner_excluded` to each partner socket with:
       - message: "Your partner experienced a technical issue. The game has ended."
       - frame_number: the exclusion frame
       - reason: "partner_exclusion"
    4. Emits `trigger_data_export` to each partner socket with:
       - is_partial: True
       - termination_reason: "partner_exclusion"
       - termination_frame: frame_number
    5. Logs notification count
    6. Uses `eventlet.sleep(0.1)` before cleanup (existing pattern from game_manager.py)
    7. Stops server_runner if exists
    8. Deletes game from self.games
    9. Logs cleanup completion

    Follow existing patterns in pyodide_game_coordinator.py (see remove_player method for similar structure).
  </action>
  <verify>
    1. `grep -n "mid_game_exclusion" interactive_gym/server/app.py` shows handler
    2. `grep -n "handle_player_exclusion" interactive_gym/server/pyodide_game_coordinator.py` shows method
    3. `grep -n "partner_excluded" interactive_gym/server/pyodide_game_coordinator.py` shows emit
  </verify>
  <done>
    - mid_game_exclusion socket handler exists in app.py
    - handle_player_exclusion method exists in coordinator
    - partner_excluded and trigger_data_export events emitted to partner
    - Game cleanup includes eventlet.sleep(0.1) before deletion
  </done>
</task>

<task type="auto">
  <name>Task 2: Client-side partner notification handling</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
    **In setupMultiplayerHandlers()** (after other socket handlers):
    Add `socket.on('partner_excluded', ...)` handler that:
    1. Logs the event via p2pLog.warn
    2. Sets `this.state = "done"` and `this.episodeComplete = true`
    3. Pauses continuousMonitor if exists
    4. Calls `this._showPartnerExcludedUI(data.message)`
    5. Closes webrtcManager if exists

    Add `socket.on('trigger_data_export', ...)` handler that:
    1. Sets `this.sessionPartialInfo` object with:
       - isPartial: true
       - terminationReason: data.termination_reason
       - terminationFrame: data.termination_frame
    2. Calls `this.emitMultiplayerMetrics(this.sceneId)` to export data immediately
    3. Emits `end_game_request_redirect` with partner_exclusion: true

    **Add new method `_showPartnerExcludedUI(message)`** (near _showMidGameExclusionUI):
    1. Create or get overlay element with id 'partnerExcludedOverlay'
    2. Style: fixed position, dark background (rgba 0,0,0,0.75), centered flex
    3. Inner content: white background, padding, rounded corners
    4. Header: "Game Ended" in neutral color (#333, not red)
    5. Message paragraph with the provided message
    6. Subtext: "Your game data has been saved. You will be redirected shortly..."
    7. Display the overlay

    Note: Partner notification UI should be neutral/informational (not alarming like the exclusion UI which uses red).
  </action>
  <verify>
    1. `grep -n "partner_excluded" interactive_gym/server/static/js/pyodide_multiplayer_game.js` shows handler
    2. `grep -n "trigger_data_export" interactive_gym/server/static/js/pyodide_multiplayer_game.js` shows handler
    3. `grep -n "_showPartnerExcludedUI" interactive_gym/server/static/js/pyodide_multiplayer_game.js` shows method
  </verify>
  <done>
    - partner_excluded socket handler stops game and shows UI
    - trigger_data_export handler saves partial session info and exports metrics
    - Partner sees neutral "Game Ended" message with "partner experienced technical issue" text
    - Partner redirected after data export
  </done>
</task>

<task type="auto">
  <name>Task 3: Partial session marking in metrics export</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
    **In exportMultiplayerMetrics()** method:
    Add `sessionStatus` object to the returned metrics (after existing fields):
    ```javascript
    sessionStatus: {
        isPartial: this.sessionPartialInfo?.isPartial || false,
        terminationReason: this.sessionPartialInfo?.terminationReason || 'normal',
        terminationFrame: this.sessionPartialInfo?.terminationFrame || this.frameNumber,
        completedEpisodes: this.cumulativeValidation?.episodes?.length || 0
    }
    ```

    **In _handleMidGameExclusion()** method (existing from Phase 16):
    Before calling emitMultiplayerMetrics or leave_game, add:
    ```javascript
    // Mark own session as partial before export
    this.sessionPartialInfo = {
        isPartial: true,
        terminationReason: reason,  // 'sustained_ping' or 'tab_hidden'
        terminationFrame: this.frameNumber
    };
    ```

    **Add property initialization** in constructor or initialization:
    Add `this.sessionPartialInfo = null;` to track partial session state.

    This ensures BOTH players (excluded and partner) have their session data marked as partial with appropriate termination reasons:
    - Excluded player: reason is 'sustained_ping' or 'tab_hidden'
    - Partner: reason is 'partner_exclusion'
  </action>
  <verify>
    1. `grep -n "sessionStatus" interactive_gym/server/static/js/pyodide_multiplayer_game.js` shows export field
    2. `grep -n "sessionPartialInfo" interactive_gym/server/static/js/pyodide_multiplayer_game.js` shows both tracking and usage
    3. Check _handleMidGameExclusion sets sessionPartialInfo before export
  </verify>
  <done>
    - exportMultiplayerMetrics includes sessionStatus object
    - sessionStatus.isPartial is true for both excluded player and partner
    - terminationReason distinguishes self-exclusion from partner-exclusion
    - Data is preserved up to exclusion frame
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Server handler chain:**
   ```bash
   grep -n "mid_game_exclusion\|handle_player_exclusion\|partner_excluded" \
     interactive_gym/server/app.py \
     interactive_gym/server/pyodide_game_coordinator.py
   ```

2. **Client handler chain:**
   ```bash
   grep -n "partner_excluded\|trigger_data_export\|sessionPartialInfo\|sessionStatus" \
     interactive_gym/server/static/js/pyodide_multiplayer_game.js
   ```

3. **Partial session marking in both paths:**
   - Excluded player: sessionPartialInfo set in _handleMidGameExclusion
   - Partner: sessionPartialInfo set in trigger_data_export handler

4. **Code review for race conditions:**
   - Server emits partner_excluded BEFORE cleanup
   - Server uses eventlet.sleep(0.1) before deleting game
   - Client exports metrics BEFORE requesting redirect
</verification>

<success_criteria>
- [ ] MULTI-01: Non-excluded player sees "Your partner experienced a technical issue" message in neutral UI
- [ ] MULTI-02: Game terminates cleanly - both players stop game loop, server cleans up game state
- [ ] MULTI-03: Valid game data preserved - emitMultiplayerMetrics called before redirect, sessionStatus.isPartial = true with termination reason
</success_criteria>

<output>
After completion, create `.planning/phases/17-multiplayer-exclusion/17-01-SUMMARY.md` using the summary template.
</output>
