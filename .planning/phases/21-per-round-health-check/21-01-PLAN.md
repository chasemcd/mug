---
phase: 21-per-round-health-check
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "DataChannel connection verified healthy before each round begins"
    - "Round start blocks until P2P connection confirmed usable"
    - "If connection is in reconnecting state, round waits for reconnection"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Per-round health check logic in reset() flow"
      contains: "_waitForHealthyConnection"
  key_links:
    - from: "reset() method"
      to: "webrtcManager.isConnectionUsable()"
      via: "_waitForHealthyConnection helper"
      pattern: "isConnectionUsable"
---

<objective>
Add per-round DataChannel health verification to block round start until P2P connection is confirmed healthy.

Purpose: Ensure each round begins with a verified working P2P connection, preventing game state divergence from undetected connection issues between rounds.

Output: Modified pyodide_multiplayer_game.js with health check gating in reset() flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-mid-game-reconnection/20-01-SUMMARY.md
@.planning/phases/20-mid-game-reconnection/20-02-SUMMARY.md

Key infrastructure from Phase 20:
- `webrtcManager.isConnectionUsable()` - checks ICE connected/completed AND DataChannel open
- `reconnectionState` object with states: 'connected', 'pausing', 'paused', 'reconnecting', 'terminated'
- Reconnection timeout already handles game termination if recovery fails

Integration point in reset() method (line ~1528):
```javascript
// P2P episode start synchronization
// Compute state hash and wait for peer to be ready before starting
if (!this.serverAuthoritative && this.webrtcManager?.isReady()) {
    // ... existing sync logic
}
```

The health check should run BEFORE the episode sync, gating on connection health.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _waitForHealthyConnection helper method</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add a new async helper method `_waitForHealthyConnection(timeoutMs = 10000)` to the PyodideMultiplayerGame class that:

1. Returns immediately if `this.webrtcManager?.isConnectionUsable()` returns true (ROUND-01 fast path)

2. If connection is NOT usable:
   - Check `this.reconnectionState.state`:
     - If 'paused' or 'reconnecting': wait for reconnection to complete
     - If 'terminated': throw error (game should end)
     - If 'connected' but isConnectionUsable() is false: connection is degraded, log warning and proceed (edge case - ICE may be transitioning)

3. Implement waiting via Promise that:
   - Polls `isConnectionUsable()` every 100ms
   - Resolves when connection becomes usable
   - Rejects on timeout with descriptive error
   - Resolves immediately if reconnectionState transitions to 'connected' AND isConnectionUsable() is true

4. Log health check status via p2pLog:
   - `p2pLog.debug('Per-round health check: connection usable')` on fast path
   - `p2pLog.info('Per-round health check: waiting for connection recovery...')` when waiting
   - `p2pLog.info('Per-round health check: connection recovered, proceeding')` on recovery

Add the method near the episode sync methods (around line 5150-5200) for logical grouping.

Return signature: `Promise<void>` - resolves when healthy, rejects on timeout/termination
  </action>
  <verify>
Grep for `_waitForHealthyConnection` in pyodide_multiplayer_game.js confirms method exists with:
- isConnectionUsable() check
- reconnectionState.state checks
- Polling loop with timeout
- Appropriate logging
  </verify>
  <done>
`_waitForHealthyConnection(timeoutMs)` method exists and handles all connection states (usable, paused, reconnecting, terminated).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire health check into reset() flow</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Modify the reset() method to call `_waitForHealthyConnection()` BEFORE the existing P2P episode sync logic.

Find the block starting at approximately line 1526:
```javascript
// P2P episode start synchronization
// Compute state hash and wait for peer to be ready before starting
if (!this.serverAuthoritative && this.webrtcManager?.isReady()) {
```

Replace with:
```javascript
// P2P per-round health check (Phase 21 - ROUND-01, ROUND-02)
// Verify DataChannel connection is healthy before starting round
if (!this.serverAuthoritative && this.webrtcManager) {
    try {
        await this._waitForHealthyConnection(10000);  // 10 second timeout
    } catch (e) {
        p2pLog.error(`Per-round health check failed: ${e.message}`);
        // Don't proceed with round - reconnection handler will end game if terminated
        // Or timeout will have elapsed - let the game end naturally via existing flow
        return [obs, infos, render_state];  // Return early, let caller handle state
    }
}

// P2P episode start synchronization
// Compute state hash and wait for peer to be ready before starting
if (!this.serverAuthoritative && this.webrtcManager?.isReady()) {
```

Key changes:
1. Health check runs first, blocks until connection healthy (ROUND-02)
2. Use `this.webrtcManager` existence check (not `.isReady()`) for the health check block
3. Keep existing `.isReady()` check for episode sync (unchanged logic)
4. Early return on health check failure - reconnection flow handles termination

Add comment referencing requirements: `// Phase 21 - ROUND-01, ROUND-02`
  </action>
  <verify>
1. Read reset() method and confirm health check block appears BEFORE episode sync block
2. Confirm try/catch wraps _waitForHealthyConnection call
3. Confirm early return on failure
  </verify>
  <done>
reset() method calls _waitForHealthyConnection() before P2P episode sync, blocking round start until connection confirmed healthy.
  </done>
</task>

</tasks>

<verification>
1. Code review:
   - `_waitForHealthyConnection` method exists with proper logic
   - reset() calls health check before episode sync
   - Logging statements present for debugging

2. Logic trace:
   - Healthy connection: health check passes immediately, proceeds to episode sync
   - Paused/reconnecting: health check waits, reconnection timeout will terminate game if recovery fails
   - Connection usable after wait: health check resolves, proceeds to episode sync
   - Timeout during wait: health check rejects, reset() returns early
</verification>

<success_criteria>
- ROUND-01: `isConnectionUsable()` called before each round (in `_waitForHealthyConnection`)
- ROUND-02: Round start blocks until connection usable (via Promise waiting pattern)
- Integration with Phase 20 reconnection flow preserved (doesn't duplicate termination logic)
- No breaking changes to existing reset() behavior when connection is healthy
</success_criteria>

<output>
After completion, create `.planning/phases/21-per-round-health-check/21-01-SUMMARY.md`
</output>
