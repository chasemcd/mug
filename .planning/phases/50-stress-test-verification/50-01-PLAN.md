---
phase: 50-stress-test-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/test_latency_injection.py
  - tests/e2e/test_network_disruption.py
  - tests/e2e/test_data_comparison.py
autonomous: true

must_haves:
  truths:
    - "test_active_input_with_latency[100] passes without xfail marker"
    - "test_active_input_with_latency[200] passes without xfail marker"
    - "test_active_input_with_packet_loss passes without xfail marker"
    - "test_focus_loss_mid_episode_parity passes (already no xfail)"
    - "test_focus_loss_episode_boundary_parity passes (already no xfail)"
    - "All E2E tests pass with no xfail markers remaining"
  artifacts:
    - path: "tests/e2e/test_latency_injection.py"
      provides: "Active input + latency test without xfail"
      contains: "def test_active_input_with_latency"
    - path: "tests/e2e/test_network_disruption.py"
      provides: "Active input + packet loss test without xfail"
      contains: "def test_active_input_with_packet_loss"
  key_links:
    - from: "tests/e2e/test_latency_injection.py"
      to: "Phases 48-49 fixes"
      via: "dual-buffer data recording now handles edge cases"
      pattern: "no xfail decorator"
---

<objective>
Remove xfail markers from stress tests and verify all E2E tests pass.

Purpose: Confirm that Phases 48-49 fixes (isFocused column consistency and episode boundary row parity) have resolved the dual-buffer edge cases that previously caused test failures under stress conditions.

Output: All E2E tests passing with no xfail markers, proving data export parity works under network stress.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-isfocused-column-consistency/48-01-SUMMARY.md
@.planning/phases/49-episode-boundary-row-parity/49-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove xfail markers from stress tests</name>
  <files>
    tests/e2e/test_latency_injection.py
    tests/e2e/test_network_disruption.py
    tests/e2e/test_data_comparison.py
  </files>
  <action>
Remove xfail markers and update docstrings in the following tests:

1. In `tests/e2e/test_latency_injection.py`:
   - Remove line 294: `@pytest.mark.xfail(reason="Known issue: data parity under latency + active inputs may fail due to dual-buffer edge cases")`
   - Update docstring for `test_active_input_with_latency` (lines 303-315) to remove the "NOTE: This test is marked xfail..." paragraph and replace with a note that this validates the dual-buffer fixes from Phases 48-49

2. In `tests/e2e/test_network_disruption.py`:
   - Remove line 259: `@pytest.mark.xfail(reason="Known issue: data parity under packet loss + active inputs may fail due to dual-buffer edge cases")`
   - Update docstring for `test_active_input_with_packet_loss` (lines 270-282) to remove the "NOTE: This test is marked xfail..." paragraph and replace with a note that this validates the dual-buffer fixes from Phases 48-49

3. In `tests/e2e/test_data_comparison.py`:
   - Update docstring for `test_focus_loss_mid_episode_parity` (lines 400-404) to remove the outdated "NOTE: This test is marked xfail..." paragraph - the xfail was already removed in Phase 48, but the docstring is stale
   - The test at line 381 has no xfail marker (verified)
   - The test at line 506 `test_focus_loss_episode_boundary_parity` also has no xfail marker (xfail was removed in Phase 49), no stale NOTE in docstring
  </action>
  <verify>
    grep -n "xfail" tests/e2e/test_latency_injection.py tests/e2e/test_network_disruption.py tests/e2e/test_data_comparison.py
    # Should return NO matches for xfail in test functions (only potentially in docstrings describing what was fixed)
  </verify>
  <done>
    No @pytest.mark.xfail decorators remain in any E2E test files. Docstrings updated to reflect that tests now pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full E2E test suite and verify all pass</name>
  <files>
    tests/e2e/test_infrastructure.py
    tests/e2e/test_multiplayer_basic.py
    tests/e2e/test_latency_injection.py
    tests/e2e/test_network_disruption.py
    tests/e2e/test_data_comparison.py
  </files>
  <action>
Run the complete E2E test suite in headed mode to verify all tests pass:

```bash
cd /Users/chasemcd/Repositories/interactive-gym
python -m pytest tests/e2e/ -v --headed --timeout=300
```

Expected test count: 15+ tests across all E2E test files.

Key tests that must pass (previously xfail):
- test_active_input_with_latency[100]
- test_active_input_with_latency[200]
- test_active_input_with_packet_loss
- test_focus_loss_mid_episode_parity
- test_focus_loss_episode_boundary_parity

If any test fails:
1. Capture the failure output
2. Diagnose whether it's a real failure or test environment issue
3. If real failure, this indicates the Phase 48-49 fixes didn't fully address the edge case - document for investigation

Note: Tests take ~2-5 minutes each, full suite may take 30+ minutes.
  </action>
  <verify>
    Test output shows all tests passed (0 failures, 0 errors, 0 xfail)
  </verify>
  <done>
    All E2E tests pass without xfail markers. Data parity verified under stress conditions.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **No xfail markers remain:**
   ```bash
   grep -r "@pytest.mark.xfail" tests/e2e/
   ```
   Should return no matches.

2. **All tests pass:**
   ```bash
   python -m pytest tests/e2e/ -v --headed --timeout=300 2>&1 | tail -20
   ```
   Should show "X passed" with 0 failures/errors/xfail.

3. **Requirements verified:**
   - STRESS-01: test_active_input_with_latency[100] passes
   - STRESS-02: test_active_input_with_latency[200] passes
   - STRESS-03: test_active_input_with_packet_loss passes
   - STRESS-04: test_focus_loss_mid_episode_parity passes
   - STRESS-05: test_focus_loss_episode_boundary_parity passes
   - VERIFY-01: All E2E tests pass with no xfail markers
   - VERIFY-02: Research exports are byte-identical (validated by comparison tests)
</verification>

<success_criteria>
1. No @pytest.mark.xfail decorators in tests/e2e/*.py
2. All E2E tests pass (0 failures, 0 errors, 0 xfail)
3. Data parity tests confirm exports are identical under stress
4. v1.11 milestone complete - all data export edge cases fixed
</success_criteria>

<output>
After completion, create `.planning/phases/50-stress-test-verification/50-01-SUMMARY.md`
</output>
