---
phase: 38-episode-boundary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Episode end promotes all remaining speculative frames before export"
    - "Warning logged if unconfirmed frames promoted at boundary"
    - "Both players export identical frame counts after episode end"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "_promoteRemainingAtBoundary() method"
      contains: "_promoteRemainingAtBoundary"
  key_links:
    - from: "signalEpisodeComplete()"
      to: "_promoteRemainingAtBoundary()"
      via: "Method call before _emitEpisodeDataFromBuffer()"
      pattern: "_promoteRemainingAtBoundary\\(\\)"
    - from: "_promoteRemainingAtBoundary()"
      to: "frameDataBuffer"
      via: "Force promotion of all speculative entries"
      pattern: "frameDataBuffer\\.set"
---

<objective>
Add forced promotion of remaining speculative frames at episode boundary before export.

Purpose: Ensure all frame data is captured in export even when confirmedFrame lags behind frameNumber at episode end.

Output: Modified signalEpisodeComplete() with new _promoteRemainingAtBoundary() method that force-promotes all remaining speculative frames with warning logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-episode-boundary/38-RESEARCH.md
@.planning/phases/36-buffer-split/36-01-SUMMARY.md
@.planning/phases/37-fast-forward-fix/37-01-SUMMARY.md
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _promoteRemainingAtBoundary() method</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add new method `_promoteRemainingAtBoundary()` immediately after `_promoteConfirmedFrames()` (around line 2982).

The method should:
1. Check if `speculativeFrameData.size === 0` - if so, return early (normal case)
2. Log a warning with: remaining count, confirmedFrame value, frameNumber value
3. Force-promote ALL remaining speculative entries to frameDataBuffer (not just confirmed ones)
4. Clear speculativeFrameData after promotion

Key differences from _promoteConfirmedFrames():
- Does NOT check `frame <= confirmedFrame` - promotes all remaining frames
- Uses console.warn instead of p2pLog.debug (this is unusual, worth attention)
- Clears entire speculativeFrameData at end

Implementation:
```javascript
/**
 * Force-promote any remaining speculative frames at episode boundary.
 * Called before export to ensure all frame data is captured.
 *
 * At episode end, both players have executed identical steps with real inputs.
 * The data is correct - it just hasn't been "confirmed" because input
 * confirmation packets are still in flight.
 *
 * Phase 38: EDGE-02
 */
_promoteRemainingAtBoundary() {
    const remaining = this.speculativeFrameData.size;
    if (remaining === 0) return;

    // Log warning - this indicates confirmedFrame was behind at episode end
    console.warn(`[Episode Boundary] Promoting ${remaining} unconfirmed frames ` +
        `at episode end (confirmedFrame=${this.confirmedFrame}, frameNumber=${this.frameNumber})`);

    // Promote all remaining frames - don't check confirmedFrame
    for (const [frame, data] of this.speculativeFrameData.entries()) {
        this.frameDataBuffer.set(frame, data);
    }
    this.speculativeFrameData.clear();
}
```
  </action>
  <verify>
Grep for `_promoteRemainingAtBoundary` shows method definition around line 2983-3000.
  </verify>
  <done>
Method exists with: early return if empty, console.warn with frame info, force promotion of all entries, clearing of speculativeFrameData.
  </done>
</task>

<task type="auto">
  <name>Task 2: Call _promoteRemainingAtBoundary() before export in signalEpisodeComplete()</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Modify `signalEpisodeComplete()` (around line 3687) to call `_promoteRemainingAtBoundary()` before the export.

Current code (lines 3697-3702):
```javascript
// Export episode data from the rollback-safe buffer
// This ensures only correct, validated data is emitted
if (this.sceneId) {
    this._emitEpisodeDataFromBuffer();
}
```

Change to:
```javascript
// Phase 38 (EDGE-02): Promote any remaining unconfirmed frames before export
// At episode end, all frames have real inputs - just not yet confirmed via packets
this._promoteRemainingAtBoundary();

// Export episode data from the rollback-safe buffer
// This ensures only correct, validated data is emitted
if (this.sceneId) {
    this._emitEpisodeDataFromBuffer();
}
```

The call must be BEFORE the if-block that calls _emitEpisodeDataFromBuffer(), not inside it.
This ensures promotion happens regardless of whether sceneId exists.
  </action>
  <verify>
Grep for `_promoteRemainingAtBoundary` in signalEpisodeComplete context shows the call before _emitEpisodeDataFromBuffer.
  </verify>
  <done>
signalEpisodeComplete() calls _promoteRemainingAtBoundary() before exporting episode data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify implementation with grep checks</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Run verification commands to confirm implementation:

1. Grep for method definition:
   `grep -n "_promoteRemainingAtBoundary" interactive_gym/server/static/js/pyodide_multiplayer_game.js`
   Expected: 2 occurrences - definition (~line 2983) and call in signalEpisodeComplete (~line 3700)

2. Grep for warning message:
   `grep -n "Episode Boundary" interactive_gym/server/static/js/pyodide_multiplayer_game.js`
   Expected: 1 occurrence in _promoteRemainingAtBoundary

3. Verify call order in signalEpisodeComplete:
   `grep -A 10 "signalEpisodeComplete()" interactive_gym/server/static/js/pyodide_multiplayer_game.js | head -20`
   Expected: _promoteRemainingAtBoundary() call before _emitEpisodeDataFromBuffer()

If any checks fail, fix the implementation before proceeding.
  </action>
  <verify>
All three grep commands produce expected output.
  </verify>
  <done>
- _promoteRemainingAtBoundary appears twice (definition and call)
- "Episode Boundary" warning message exists in method
- Call order is correct: promotion before export
  </done>
</task>

</tasks>

<verification>
## Code Verification
- [ ] `_promoteRemainingAtBoundary()` method exists after `_promoteConfirmedFrames()`
- [ ] Method promotes ALL speculative frames (no confirmedFrame check)
- [ ] Method logs warning with frame counts when promotion occurs
- [ ] `signalEpisodeComplete()` calls `_promoteRemainingAtBoundary()` before export
- [ ] Call is outside the `if (this.sceneId)` block

## Runtime Verification (manual)
1. Start multiplayer game
2. Play until episode ends naturally
3. Check console for `[Episode Boundary] Promoting N unconfirmed frames` warning
   - If warning appears: confirms fix is working (frames were unconfirmed at boundary)
   - If no warning: confirms normal case (all frames already confirmed)
4. Verify `window.pyodideGame.speculativeFrameData.size === 0` after episode end
5. Verify `window.pyodideGame.frameDataBuffer.size` matches expected frame count
</verification>

<success_criteria>
1. Episode end promotes all remaining speculative frames before triggering export
2. Warning logged if promoting unconfirmed frames at episode boundary
3. Both players export identical frame counts (verified via SUMMARY comparison)
</success_criteria>

<output>
After completion, create `.planning/phases/38-episode-boundary/38-01-SUMMARY.md`
</output>
