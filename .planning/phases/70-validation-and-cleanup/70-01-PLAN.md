---
phase: 70-validation-and-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/test_multi_participant.py
  - tests/fixtures/multi_participant.py
  - tests/e2e/test_lifecycle_stress.py
autonomous: true

must_haves:
  truths:
    - "3 concurrent games start without Socket.IO disconnects using 0.5s stagger"
    - "Multi-participant test test_three_simultaneous_games passes with stagger_delay_sec=0.5"
    - "Multi-participant test test_staggered_participant_arrival passes with stagger_delay_sec=0.5"
    - "All games complete with verified data parity at reduced stagger"
  artifacts:
    - path: "tests/e2e/test_multi_participant.py"
      provides: "Multi-participant tests with 0.5s stagger delay"
      contains: "stagger_delay_sec=0.5"
    - path: "tests/fixtures/multi_participant.py"
      provides: "GameOrchestrator default stagger reduced to 0.5s"
      contains: "stagger_delay_sec: float = 0.5"
  key_links:
    - from: "tests/e2e/test_multi_participant.py"
      to: "GameOrchestrator.start_all_games"
      via: "stagger_delay_sec parameter"
      pattern: "stagger_delay_sec=0\\.5"
---

<objective>
Validate that the Pyodide Web Worker migration (Phases 67-69) eliminates Socket.IO disconnects during concurrent game startup by reducing the inter-game stagger delay from 5.0s to 0.5s.

Purpose: This is the primary validation of the entire v1.16 milestone. Before Worker migration, Pyodide initialization blocked the main thread for several seconds, causing Socket.IO to miss ping responses and disconnect. With Pyodide in a Worker, the main thread stays responsive, so games should start concurrently with minimal stagger.

Output: Updated test files with 0.5s stagger, passing test results confirming VALID-01 and VALID-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tests/e2e/test_multi_participant.py
@tests/fixtures/multi_participant.py
@tests/e2e/test_lifecycle_stress.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce stagger delay from 5.0s to 0.5s in all test files</name>
  <files>
    tests/e2e/test_multi_participant.py
    tests/fixtures/multi_participant.py
    tests/e2e/test_lifecycle_stress.py
  </files>
  <action>
    Update all stagger delay values from 5.0s to 0.5s:

    1. In `tests/fixtures/multi_participant.py`:
       - Change `start_all_games` default parameter from `stagger_delay_sec: float = 5.0` to `stagger_delay_sec: float = 0.5`
       - This is the only place the default needs to change; all callers use the default

    2. In `tests/e2e/test_multi_participant.py`:
       - Change `orchestrator.start_all_games(stagger_delay_sec=5.0)` to `orchestrator.start_all_games(stagger_delay_sec=0.5)` in both test_three_simultaneous_games and test_staggered_participant_arrival

    3. In `tests/e2e/test_lifecycle_stress.py`:
       - Change all `orchestrator.start_all_games(stagger_delay_sec=5.0)` calls to `orchestrator.start_all_games(stagger_delay_sec=0.5)`
       - There should be 2-3 occurrences in different test functions

    Do NOT change:
    - The 0.5s delay between partner start button clicks inside start_all_games (line ~357 in multi_participant.py: `time.sleep(0.5)  # Wait for P1 to enter waitroom before P2 clicks`) -- this is for matchmaker ordering, not Pyodide init
    - The 0.1s delay between partner navigations (line ~307: `time.sleep(0.1)  # Small gap between partners`) -- same reason

    Why 0.5s not 0s: The 0.5s stagger between game pairs gives WebRTC signaling time to complete for one pair before the next begins. This is a P2P connection concern, not a Pyodide concern. The requirement explicitly says 0.5s (VALID-02), not zero.
  </action>
  <verify>
    Run grep to confirm no remaining `stagger_delay_sec=5.0` references:
    ```
    grep -rn "stagger_delay_sec=5.0" tests/
    ```
    Should return zero results.

    Run grep to confirm new values:
    ```
    grep -rn "stagger_delay_sec=0.5" tests/
    ```
    Should return all the updated call sites.
  </verify>
  <done>
    All stagger_delay_sec values changed from 5.0 to 0.5 in test_multi_participant.py, multi_participant.py, and test_lifecycle_stress.py. No 5.0s references remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run multi-participant tests and validate Socket.IO stability</name>
  <files>tests/e2e/test_multi_participant.py</files>
  <action>
    Run the two key multi-participant tests with the reduced stagger:

    ```bash
    cd /Users/chasemcd/Repositories/interactive-gym
    PWHEADED=1 python -m pytest tests/e2e/test_multi_participant.py::test_three_simultaneous_games -v --timeout=600 2>&1
    ```

    This test starts 3 concurrent games (6 browser contexts) with 0.5s stagger between game pairs. It validates:
    - All 6 Socket.IO connections remain stable during concurrent Pyodide initialization (VALID-01)
    - All 3 games complete with verified data parity (VALID-02)

    If the test passes, VALID-01 and VALID-02 are satisfied.

    If the test fails with Socket.IO disconnection errors:
    - Check the error output for which game pair failed
    - Look for "disconnect" or "transport close" in the output
    - This would indicate the Worker migration did NOT fully solve the main-thread blocking issue
    - Document the failure in the summary

    Then run the second test:
    ```bash
    PWHEADED=1 python -m pytest tests/e2e/test_multi_participant.py::test_staggered_participant_arrival -v --timeout=600 2>&1
    ```

    Both tests must pass for VALID-01/VALID-02 to be satisfied.

    IMPORTANT: These tests require headed mode (WebRTC needs real browser). Use PWHEADED=1.
    IMPORTANT: Tests take 5-10 minutes each due to Pyodide loading and game episodes.
  </action>
  <verify>
    Both tests pass:
    ```
    test_three_simultaneous_games PASSED
    test_staggered_participant_arrival PASSED
    ```
    Test output shows all 3 games completed with verified data parity.
    No Socket.IO disconnect errors in output.
  </verify>
  <done>
    test_three_simultaneous_games and test_staggered_participant_arrival both pass with 0.5s stagger (down from 5.0s), confirming that the Pyodide Worker migration eliminates Socket.IO disconnects during concurrent game startup. VALID-01 and VALID-02 satisfied.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "stagger_delay_sec=5.0" tests/` returns zero results
2. `grep -rn "stagger_delay_sec=0.5" tests/` shows all call sites updated
3. test_three_simultaneous_games passes with 0.5s stagger
4. test_staggered_participant_arrival passes with 0.5s stagger
5. No Socket.IO disconnect errors in test output
</verification>

<success_criteria>
- All stagger delays reduced from 5.0s to 0.5s
- Both multi-participant tests pass at 0.5s stagger
- All 3 concurrent games complete with verified data parity
- VALID-01 satisfied: Socket.IO stable during concurrent Pyodide init
- VALID-02 satisfied: Multi-participant tests pass with 0.5s stagger
</success_criteria>

<output>
After completion, create `.planning/phases/70-validation-and-cleanup/70-01-SUMMARY.md`
</output>
