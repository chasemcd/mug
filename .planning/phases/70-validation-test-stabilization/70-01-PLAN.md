---
phase: 70-validation-test-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/fixtures/multi_participant.py
  - tests/e2e/test_multi_participant.py
  - tests/e2e/test_lifecycle_stress.py
autonomous: false

must_haves:
  truths:
    - "Multi-participant tests use 0.5s stagger between game pairs (not 5.0s)"
    - "All 3 concurrent games start and complete with 0.5s stagger delay"
    - "Socket.IO connections remain stable during near-simultaneous game starts"
    - "Game loop frame timing is unchanged (no performance regression)"
    - "All existing E2E tests pass without regressions from v1.16 changes"
  artifacts:
    - path: "tests/fixtures/multi_participant.py"
      provides: "GameOrchestrator with reduced default stagger"
      contains: "stagger_delay_sec: float = 0.5"
    - path: "tests/e2e/test_multi_participant.py"
      provides: "Multi-participant tests with 0.5s stagger"
      contains: "stagger_delay_sec=0.5"
    - path: "tests/e2e/test_lifecycle_stress.py"
      provides: "Lifecycle stress tests with 0.5s stagger"
      contains: "stagger_delay_sec=0.5"
  key_links:
    - from: "tests/e2e/test_multi_participant.py"
      to: "tests/fixtures/multi_participant.py"
      via: "orchestrator.start_all_games(stagger_delay_sec=0.5)"
      pattern: "start_all_games.*stagger_delay_sec=0\\.5"
---

<objective>
Reduce stagger delay from 5.0s to 0.5s in all multi-participant E2E tests and verify all tests pass, proving that Pyodide pre-loading (Phases 67-69) eliminated the need for large delays between concurrent game starts.

Purpose: This is the final validation phase for v1.16 Pyodide Pre-loading. The 5.0s stagger was needed because concurrent loadPyodide() calls blocked the main thread, causing Socket.IO ping timeouts and false disconnects. With pre-loading during compat check (Phase 67), shared instance reuse (Phase 68), and server-side grace (Phase 69), concurrent game starts should work with minimal delay.

Output: All E2E tests passing with 0.5s stagger, completing TEST-01 through TEST-05 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-server-init-grace/69-01-SUMMARY.md

@tests/fixtures/multi_participant.py
@tests/e2e/test_multi_participant.py
@tests/e2e/test_lifecycle_stress.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce stagger delay from 5.0s to 0.5s in all test files</name>
  <files>
    tests/fixtures/multi_participant.py
    tests/e2e/test_multi_participant.py
    tests/e2e/test_lifecycle_stress.py
  </files>
  <action>
    Change the stagger delay in all locations from 5.0s to 0.5s:

    1. **tests/fixtures/multi_participant.py** (GameOrchestrator.start_all_games):
       - Line ~272: Change default parameter `stagger_delay_sec: float = 5.0` to `stagger_delay_sec: float = 0.5`
       - Update the docstring to reflect the new default and explain WHY the stagger was reduced (Pyodide pre-loading eliminates concurrent init blocking)

    2. **tests/e2e/test_multi_participant.py**:
       - Line ~57 (test_three_simultaneous_games): Change `orchestrator.start_all_games(stagger_delay_sec=5.0)` to `orchestrator.start_all_games(stagger_delay_sec=0.5)`
       - Line ~101 (test_staggered_participant_arrival): Change `orchestrator.start_all_games(stagger_delay_sec=5.0)` to `orchestrator.start_all_games(stagger_delay_sec=0.5)`
       - Update the module docstring to note that stagger was reduced from 5.0s to 0.5s thanks to Pyodide pre-loading

    3. **tests/e2e/test_lifecycle_stress.py**:
       - Line ~63 (test_multi_episode_completion): Change `orchestrator.start_all_games(stagger_delay_sec=5.0)` to `orchestrator.start_all_games(stagger_delay_sec=0.5)`
       - Line ~456 (test_mixed_lifecycle_scenarios): Change `orchestrator.start_all_games(stagger_delay_sec=5.0)` to `orchestrator.start_all_games(stagger_delay_sec=0.5)`

    Keep the 0.5s partner click delay (`time.sleep(0.5)` between Start button clicks within a pair) -- this ensures P1 enters waitroom before P2 clicks. That delay is about FIFO matchmaker ordering, not about Pyodide loading.

    Do NOT change any test logic, assertion structure, timeouts, or episode configuration. Only change the stagger_delay_sec values.
  </action>
  <verify>
    1. `grep -rn "stagger_delay_sec=5.0" tests/` returns no results
    2. `grep -rn "stagger_delay_sec=0.5" tests/e2e/test_multi_participant.py` returns 2 results
    3. `grep -rn "stagger_delay_sec=0.5" tests/e2e/test_lifecycle_stress.py` returns 2 results
    4. `grep -n "stagger_delay_sec: float = 0.5" tests/fixtures/multi_participant.py` returns 1 result
    5. `python -c "from tests.fixtures.multi_participant import GameOrchestrator"` succeeds (no syntax errors)
  </verify>
  <done>
    All stagger_delay_sec values changed from 5.0 to 0.5 across test_multi_participant.py (2 sites), test_lifecycle_stress.py (2 sites), and multi_participant.py default parameter (1 site). No instances of 5.0s stagger remain. TEST-01 satisfied.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Reduced stagger delay from 5.0s to 0.5s in all multi-participant E2E tests. This is the culmination of v1.16 Pyodide Pre-loading -- if tests pass with 0.5s stagger, concurrent game starts work without the large delays that were previously needed to avoid Socket.IO disconnects from main-thread blocking.
  </what-built>
  <how-to-verify>
    Run the full E2E test suite in headed mode. Tests require a display since WebRTC needs headed Chromium.

    **Step 1: Run multi-participant tests (TEST-01, TEST-02, TEST-03)**
    ```bash
    pytest tests/e2e/test_multi_participant.py -v --timeout=600
    ```
    Expected: Both tests pass (test_three_simultaneous_games, test_staggered_participant_arrival) with 0.5s stagger. All 3 game pairs start near-simultaneously without Socket.IO disconnects.

    **Step 2: Run basic multiplayer test (TEST-05 regression check)**
    ```bash
    pytest tests/e2e/test_multiplayer_basic.py -v --timeout=300
    ```
    Expected: test_two_players_connect_and_complete_episode passes.

    **Step 3: Run data comparison tests (TEST-05 regression check)**
    ```bash
    pytest tests/e2e/test_data_comparison.py -v --timeout=300
    ```
    Expected: All data comparison tests pass.

    **Step 4: Run latency injection tests (TEST-05 regression check)**
    ```bash
    pytest tests/e2e/test_latency_injection.py -v --timeout=300
    ```
    Expected: All latency tests pass.

    **Step 5: Run network disruption tests (TEST-05 regression check)**
    ```bash
    pytest tests/e2e/test_network_disruption.py -v --timeout=300
    ```
    Expected: All network disruption tests pass.

    **Step 6 (optional): Run lifecycle stress tests (TEST-04 timing verification)**
    ```bash
    pytest tests/e2e/test_lifecycle_stress.py -v --timeout=600
    ```
    Expected: Lifecycle tests pass with 0.5s stagger. Frame timing in console output shows normal per-frame execution (~10-100ms).

    If any test fails with socket disconnection errors during game start, that indicates the pre-loading or grace mechanism is not fully working and needs debugging.

    TEST-04 (performance regression) is verified implicitly: if games complete within the same timeouts as before, per-frame timing is unchanged. The console output from GameOrchestrator logs frame numbers that can be inspected.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which tests failed and with what errors</resume-signal>
</task>

</tasks>

<verification>
After all tests pass:

1. TEST-01: `grep -rn "stagger_delay_sec=5.0" tests/` returns nothing (stagger removed)
2. TEST-02: Multi-participant tests pass with 0.5s stagger (near-simultaneous starts)
3. TEST-03: No Socket.IO disconnect errors in test output during concurrent game starts
4. TEST-04: Games complete within normal timeouts (no performance regression)
5. TEST-05: All existing E2E test files pass (test_multiplayer_basic, test_data_comparison, test_latency_injection, test_network_disruption, test_multi_participant)
</verification>

<success_criteria>
- Zero instances of `stagger_delay_sec=5.0` in test codebase
- All multi-participant tests pass with `stagger_delay_sec=0.5`
- All existing E2E tests pass without regressions
- No false disconnect errors during concurrent game starts
- TEST-01 through TEST-05 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/70-validation-test-stabilization/70-01-SUMMARY.md`
</output>
