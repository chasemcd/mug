---
phase: 37-fast-forward-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Fast-forward frames appear in exported data"
    - "Tab refocus followed by episode end exports all frames"
    - "speculativeFrameData is empty after fast-forward completes"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "_promoteConfirmedFrames() call in _performFastForward()"
      contains: "_promoteConfirmedFrames"
  key_links:
    - from: "_performFastForward()"
      to: "_promoteConfirmedFrames()"
      via: "method call after confirmedFrame update"
      pattern: "this\\._promoteConfirmedFrames\\(\\)"
---

<objective>
Add _promoteConfirmedFrames() call to _performFastForward() so fast-forward frames are promoted to the canonical buffer.

Purpose: Fix data export gap where tab refocus fast-forward frames are stored in speculativeFrameData but never promoted to frameDataBuffer, causing missing frames in export.

Output: Fast-forward follows the same confirmation-gated recording path as normal execution (EDGE-01).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-fast-forward-fix/37-RESEARCH.md
@.planning/phases/36-buffer-split/36-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _promoteConfirmedFrames() call after confirmedFrame update in _performFastForward()</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
In `_performFastForward()`, add a call to `this._promoteConfirmedFrames()` immediately after the line `this.confirmedFrame = this.frameNumber - 1;` (around line 5025).

Find this code block:
```javascript
// Update confirmedFrame to match - all fast-forwarded frames used real inputs
// This prevents GGPO from thinking we have many unconfirmed frames
this.confirmedFrame = this.frameNumber - 1;

// Update HUD to reflect fast-forwarded state
```

Add the promotion call:
```javascript
// Update confirmedFrame to match - all fast-forwarded frames used real inputs
// This prevents GGPO from thinking we have many unconfirmed frames
this.confirmedFrame = this.frameNumber - 1;

// Promote fast-forward frames to canonical buffer (Phase 37: EDGE-01)
// Without this, data stays in speculativeFrameData and is missing from export
this._promoteConfirmedFrames();

// Update HUD to reflect fast-forwarded state
```

Rationale: Fast-forward stores frame data in speculativeFrameData via storeFrameData(), but directly sets confirmedFrame without calling _updateConfirmedFrame(). This bypasses the promotion path. Adding the explicit _promoteConfirmedFrames() call uses the existing Phase 36 infrastructure to move fast-forward frames to the canonical buffer.
  </action>
  <verify>
1. Grep for the new line: `grep -n "_promoteConfirmedFrames" interactive_gym/server/static/js/pyodide_multiplayer_game.js` should show call in _performFastForward()
2. Code inspection: The call should appear after `this.confirmedFrame = this.frameNumber - 1` and before `ui_utils.updateHUDText()`
  </verify>
  <done>
- _promoteConfirmedFrames() called after confirmedFrame update in _performFastForward()
- Comment explains Phase 37 / EDGE-01 purpose
- Fast-forward frames will be promoted to canonical buffer
  </done>
</task>

</tasks>

<verification>
After implementation:

1. **Code verification:**
   - `grep -n "_promoteConfirmedFrames" pyodide_multiplayer_game.js` shows two calls:
     - One in `_updateConfirmedFrame()` (existing from Phase 36)
     - One in `_performFastForward()` (new from this phase)

2. **Runtime verification (manual testing):**
   - Start multiplayer game
   - Tab away, wait for fast-forward to build up buffered frames
   - Tab back, observe console for "Promoted N frames to canonical buffer"
   - Check `window.pyodideGame.speculativeFrameData.size` is 0 after fast-forward
   - Check `window.pyodideGame.frameDataBuffer.size` includes fast-forward frames
   - Complete episode, verify export contains all frames (no gaps)
</verification>

<success_criteria>
- [ ] _promoteConfirmedFrames() called in _performFastForward() after confirmedFrame update
- [ ] After fast-forward, speculativeFrameData.size is 0 (all frames promoted)
- [ ] After fast-forward, frameDataBuffer contains the fast-forward frames
- [ ] Console shows "Promoted N frames to canonical buffer" where N = fast-forward frame count
- [ ] Requirement EDGE-01 satisfied: Fast-forward uses same confirmation-gated recording path
</success_criteria>

<output>
After completion, create `.planning/phases/37-fast-forward-fix/37-01-SUMMARY.md`
</output>
