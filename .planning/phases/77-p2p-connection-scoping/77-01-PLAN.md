---
phase: 77-p2p-connection-scoping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
  - interactive_gym/server/static/js/index.js
autonomous: true

must_haves:
  truths:
    - "When a participant advances past a GymScene, all WebRTC connections are closed (no lingering DataChannels or PeerConnections)"
    - "When a participant is on a non-GymScene scene, no partner-disconnected overlay appears even if their former partner disconnects"
    - "Existing GymScene gameplay is unaffected (P2P connections still work during active game)"
    - "If the next scene is also a GymScene, a fresh WebRTC connection is established successfully"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "cleanupForSceneExit() method and sceneExited guard flag"
      contains: "cleanupForSceneExit"
    - path: "interactive_gym/server/static/js/index.js"
      provides: "P2P cleanup call in terminateGymScene()"
      contains: "cleanupForSceneExit"
  key_links:
    - from: "interactive_gym/server/static/js/index.js"
      to: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      via: "terminateGymScene() calls pyodideRemoteGame.cleanupForSceneExit()"
      pattern: "pyodideRemoteGame\\.cleanupForSceneExit"
    - from: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      to: "interactive_gym/server/static/js/webrtc_manager.js"
      via: "cleanupForSceneExit() calls this.webrtcManager.close()"
      pattern: "this\\.webrtcManager\\.close"
---

<objective>
Close P2P/WebRTC connections when a GymScene exits and suppress stale partner-disconnected overlays on non-game scenes.

Purpose: Currently, when a participant advances past a GymScene (to a survey, instructions, or end screen), the WebRTC connection, socket listeners, telemetry polling, and timer worker all persist from the old MultiplayerPyodideGame instance. If the former partner then disconnects, the `p2p_game_ended` event fires, `_handleReconnectionGameEnd()` runs, and the full-page "partner disconnected" overlay appears on top of the survey/end screen. This phase scopes P2P resources to GymScene lifetime and guards overlay display.

Output: Modified `pyodide_multiplayer_game.js` with `cleanupForSceneExit()` method and `sceneExited` guard, and modified `index.js` calling cleanup from `terminateGymScene()`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-p2p-connection-scoping/77-RESEARCH.md
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
@interactive_gym/server/static/js/index.js
@interactive_gym/server/static/js/webrtc_manager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sceneExited flag, cleanupForSceneExit() method, and overlay guards to MultiplayerPyodideGame</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
  Make three additions to MultiplayerPyodideGame in `pyodide_multiplayer_game.js`:

  **1a. Initialize `sceneExited` flag in constructor (around line 1169, after reconnectionState):**

  Add `this.sceneExited = false;` with a comment: `// Phase 77: Set true when scene exits to guard stale event handlers`

  **1b. Add `cleanupForSceneExit()` method (after `_stopP2PHealthReporting()` around line 5800, in the P2P health section):**

  ```javascript
  /**
   * Clean up P2P resources when exiting a GymScene (Phase 77 - P2P-01, P2P-02).
   * Called from terminateGymScene() in index.js.
   * Sets sceneExited flag FIRST (synchronous) to guard all stale event handlers,
   * then tears down WebRTC, telemetry, health reporting, and timer worker.
   *
   * IMPORTANT: Do NOT null out `this` or remove socket listeners.
   * - Socket listeners are anonymous arrow functions with no stored reference (can't socket.off).
   * - The game_id filter in each listener + sceneExited guard prevents stale event processing.
   * - The game instance may be reused if the next scene is also a GymScene (reinitialize_environment path).
   */
  cleanupForSceneExit() {
      // Set flag FIRST (synchronous) to guard all handlers immediately
      this.sceneExited = true;
      p2pLog.info('Scene exit cleanup initiated');

      // Close WebRTC connection (P2P-01)
      // WebRTCManager.close() is idempotent - handles null peerConnection/dataChannel
      if (this.webrtcManager) {
          this.webrtcManager.close();
          this.webrtcManager = null;
      }

      // Stop latency telemetry polling (Phase 22)
      if (this.latencyTelemetry) {
          this.latencyTelemetry.stop();
      }

      // Stop P2P health reporting interval
      this._stopP2PHealthReporting();

      // Destroy Web Worker timer (Phase 24)
      this._destroyTimerWorker();
  }
  ```

  **1c. Add sceneExited guards at the top of three methods:**

  In `_handleReconnectionGameEnd(data)` (line ~6415), add as the FIRST check (before the focusLossTimeoutTerminal check):
  ```javascript
  // P2P-02: Don't show overlay if scene already exited
  if (this.sceneExited) {
      p2pLog.info('Ignoring p2p_game_ended - scene already exited');
      return;
  }
  ```

  In `_onP2PConnectionLost(info)` (line ~6262), add as an additional early-return condition alongside the existing check. Change:
  ```javascript
  if (this.reconnectionState.isPaused || this.state === 'done') {
  ```
  to:
  ```javascript
  if (this.sceneExited || this.reconnectionState.isPaused || this.state === 'done') {
  ```

  In `_handleFocusLossTimeout()` (line ~6575), add as the FIRST line of the method:
  ```javascript
  // P2P-02: Don't show overlay if scene already exited
  if (this.sceneExited) return;
  ```

  **1d. Reset sceneExited in _initP2PConnection() (line ~5570):**

  Add at the beginning of `_initP2PConnection()`, before `this.p2pValidation.state = 'connecting';`:
  ```javascript
  // Reset scene exit flag for new game (Phase 77 - Pitfall 3: reuse scenario)
  this.sceneExited = false;
  ```

  **Anti-patterns to AVOID:**
  - Do NOT set `pyodideRemoteGame = null` in index.js -- the instance may be reused if the next scene is also a GymScene
  - Do NOT try to remove socket listeners with `socket.off()` -- they are anonymous arrow functions with no stored reference
  - Do NOT modify `isDone()` -- the `partnerDisconnectedTerminal` check exists for a valid reason (prevents scene advance during active game disconnect)
  </action>
  <verify>
  1. Search for `cleanupForSceneExit` in the file -- should appear exactly: once as method definition, zero in constructor
  2. Search for `sceneExited` -- should appear: once in constructor (initialization), once in cleanupForSceneExit (set true), once in _initP2PConnection (reset false), three guard checks (in _handleReconnectionGameEnd, _onP2PConnectionLost, _handleFocusLossTimeout)
  3. Verify the file has no syntax errors: `node -c interactive_gym/server/static/js/pyodide_multiplayer_game.js` (should output nothing / exit 0)
  </verify>
  <done>
  - `cleanupForSceneExit()` method exists and closes webrtcManager, stops latencyTelemetry, stops health reporting, destroys timer worker
  - `sceneExited` flag is initialized false in constructor, set true in cleanupForSceneExit, reset false in _initP2PConnection
  - `_handleReconnectionGameEnd` returns early when sceneExited is true (prevents partner-disconnected overlay)
  - `_onP2PConnectionLost` returns early when sceneExited is true
  - `_handleFocusLossTimeout` returns early when sceneExited is true
  </done>
</task>

<task type="auto">
  <name>Task 2: Call cleanupForSceneExit() from terminateGymScene() in index.js</name>
  <files>interactive_gym/server/static/js/index.js</files>
  <action>
  In `terminateGymScene(data)` (line 1527), add the P2P cleanup call AFTER the existing interval clearing (lines 1532-1540) and BEFORE the sync_globals emit (line 1543).

  Add these lines between the `refreshStartButton` clear block and the `socket.emit("sync_globals", ...)` line:

  ```javascript
  // Phase 77 (P2P-01, P2P-02): Clean up P2P resources when exiting GymScene
  // Must happen before data emission so sceneExited flag is set before any
  // race-window p2p_game_ended events can trigger stale overlays
  if (pyodideRemoteGame && typeof pyodideRemoteGame.cleanupForSceneExit === 'function') {
      pyodideRemoteGame.cleanupForSceneExit();
  }
  ```

  The `typeof` check ensures backward compatibility -- single-player `RemoteGame` instances don't have this method, and this call is harmless (skipped) for them.

  The placement is important:
  - AFTER interval clearing: intervals are already stopped
  - BEFORE sync_globals + data emission: the sceneExited flag must be set before any socket events could trigger stale handlers
  - BEFORE UI cleanup: overlay guard must be active before any partner disconnect events could show overlays

  Do NOT:
  - Set `pyodideRemoteGame = null` -- the instance may be reused for the next GymScene
  - Add any other cleanup logic here -- all P2P-specific cleanup is encapsulated in cleanupForSceneExit()
  </action>
  <verify>
  1. Search for `cleanupForSceneExit` in index.js -- should appear exactly once, inside terminateGymScene()
  2. Verify the call is after `refreshStartButton` clear and before `socket.emit("sync_globals")`
  3. Verify the file has no syntax errors: `node -c interactive_gym/server/static/js/index.js` (should output nothing / exit 0)
  4. Run the basic multiplayer E2E test to verify no regression: `cd /Users/chasemcd/Repositories/interactive-gym && python -m pytest tests/e2e/test_multiplayer_basic.py -x --timeout=300 -v`
  </verify>
  <done>
  - `terminateGymScene()` calls `pyodideRemoteGame.cleanupForSceneExit()` with typeof guard
  - Call is positioned after interval clearing and before data emission
  - Basic multiplayer E2E test passes (no regression from cleanup changes)
  - Both files pass `node -c` syntax check
  </done>
</task>

</tasks>

<verification>
**Syntax verification (both files):**
```bash
node -c interactive_gym/server/static/js/pyodide_multiplayer_game.js
node -c interactive_gym/server/static/js/index.js
```

**Regression test (basic multiplayer gameplay unaffected):**
```bash
cd /Users/chasemcd/Repositories/interactive-gym && python -m pytest tests/e2e/test_multiplayer_basic.py -x --timeout=300 -v
```

**Extended regression (partner disconnect path still works during active game):**
```bash
cd /Users/chasemcd/Repositories/interactive-gym && python -m pytest tests/e2e/test_lifecycle_stress.py::test_mid_game_disconnect -x --timeout=300 -v
```

**Code search verification:**
- `grep -n "cleanupForSceneExit" interactive_gym/server/static/js/pyodide_multiplayer_game.js` -- method definition + _initP2PConnection mention in comment
- `grep -n "cleanupForSceneExit" interactive_gym/server/static/js/index.js` -- single call in terminateGymScene
- `grep -n "sceneExited" interactive_gym/server/static/js/pyodide_multiplayer_game.js` -- constructor init, cleanupForSceneExit set, _initP2PConnection reset, three guard checks
</verification>

<success_criteria>
1. P2P-01: `cleanupForSceneExit()` closes WebRTC (webrtcManager.close()), stops telemetry, stops health reporting, destroys timer worker -- all called from terminateGymScene()
2. P2P-02: `_handleReconnectionGameEnd()`, `_onP2PConnectionLost()`, and `_handleFocusLossTimeout()` all return early when `sceneExited === true` -- preventing overlay display on non-game scenes
3. No regression: existing multiplayer gameplay works (basic multiplayer test passes), partner disconnect during active game still shows overlay correctly (lifecycle stress test passes)
4. Reuse scenario: `_initP2PConnection()` resets `sceneExited = false` so subsequent GymScenes work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/77-p2p-connection-scoping/77-01-SUMMARY.md`
</output>
