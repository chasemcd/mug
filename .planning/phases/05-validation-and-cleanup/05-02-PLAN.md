---
phase: 05-validation-and-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "P2P DataChannel is primary input path when healthy"
    - "SocketIO only used as fallback when P2P unavailable or failed"
    - "Rollback events are logged with frame and cause details"
    - "Session metrics can be exported for research analysis"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "P2P-first input sending, rollback logging, metrics export"
      contains: "sendInputToOtherPlayers"
  key_links:
    - from: "step() method"
      to: "sendInputToOtherPlayers()"
      via: "Input sending dispatch"
      pattern: "sendInputToOtherPlayers"
    - from: "storeRemoteInput()"
      to: "sessionMetrics.rollbacks"
      via: "Rollback event logging"
      pattern: "rollbackEvent"
---

<objective>
Implement P2P-first input sending and enhance research data collection.

Purpose: Currently inputs are sent via BOTH SocketIO and P2P in parallel (dual-path). This wastes server bandwidth when P2P is healthy. Switch to P2P-first: use DataChannel when connected, fall back to SocketIO only when P2P unavailable or send fails. Also enhance rollback event logging for research analysis.

Output: P2P is primary transport with SocketIO fallback, rollback events captured in session metrics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-validation-and-cleanup/05-RESEARCH.md
@.planning/phases/05-validation-and-cleanup/05-01-SUMMARY.md
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement P2P-first input sending</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Replace the current dual-path input sending logic (approximately lines 1130-1148) with P2P-first pattern.

Current code sends via BOTH paths simultaneously:
```javascript
// Always send via SocketIO
socket.emit('pyodide_player_action', {...});
// Also send via P2P if connected
if (this.p2pConnected && this.p2pInputSender) {
    this.p2pInputSender.recordAndSend(...);
}
```

Change to P2P-first with fallback:

1. Create a helper method `_sendViaSocketIO(action, targetFrame)` that encapsulates the SocketIO emit logic
2. Replace the inline sending logic with:

```javascript
// P2P-first input sending
const p2pHealthy = this.p2pConnected &&
                   this.p2pInputSender &&
                   !this.p2pMetrics.p2pFallbackTriggered;

if (p2pHealthy) {
    // Primary: P2P DataChannel
    const sent = this.p2pInputSender.recordAndSend(myCurrentAction, targetFrame);
    if (sent) {
        this.p2pMetrics.inputsSentViaP2P++;
        // P2P success - don't use SocketIO
    } else {
        // P2P send failed (buffer congested) - fall back to SocketIO
        console.warn('[P2P] Send failed (buffer full), falling back to SocketIO');
        this._sendViaSocketIO(myCurrentAction, targetFrame);
    }
} else {
    // No healthy P2P connection - use SocketIO
    this._sendViaSocketIO(myCurrentAction, targetFrame);
}
```

3. Add the helper method near other private methods:
```javascript
_sendViaSocketIO(action, targetFrame) {
    socket.emit('pyodide_player_action', {
        game_id: this.gameId,
        player_id: this.myPlayerId,
        action: action,
        frame_number: targetFrame,
        timestamp: Date.now(),
        sync_epoch: this.syncEpoch
    });
    this.p2pMetrics.inputsSentViaSocketIO++;
}
```

This ensures:
- P2P is tried first when healthy
- SocketIO only used as fallback
- Clear metrics tracking for research
  </action>
  <verify>
Grep: `grep -n "_sendViaSocketIO\|p2pHealthy" interactive_gym/server/static/js/pyodide_multiplayer_game.js` should show the new method and variable
  </verify>
  <done>
P2P DataChannel is primary input path. SocketIO only used when P2P unavailable or buffer congested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rollback event logging for research</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Enhance rollback detection in `storeRemoteInput()` method to capture detailed rollback events for research analysis.

1. Initialize sessionMetrics in constructor (if not already present):
```javascript
this.sessionMetrics = {
    rollbacks: {
        events: [],
        count: 0,
        maxFrames: 0
    }
};
```

2. Find the misprediction detection block in `storeRemoteInput()` - look for where `pendingRollbackFrame` is set when `usedAction !== action`.

3. Enhance that block to record the rollback event:
```javascript
if (usedAction !== undefined && usedAction !== action) {
    const rollbackFrames = this.frameNumber - frameNumber;

    const rollbackEvent = {
        frame: frameNumber,
        currentFrame: this.frameNumber,
        rollbackFrames: rollbackFrames,
        playerId: playerIdStr,
        predictedAction: usedAction,
        actualAction: action,
        timestamp: Date.now()
    };

    // Track for research export
    this.sessionMetrics.rollbacks.events.push(rollbackEvent);
    this.sessionMetrics.rollbacks.count++;
    this.sessionMetrics.rollbacks.maxFrames = Math.max(
        this.sessionMetrics.rollbacks.maxFrames,
        rollbackFrames
    );

    console.log(
        `[GGPO] Late input triggering rollback: ` +
        `player=${playerIdStr}, frame=${frameNumber}, ` +
        `predicted=${usedAction}, actual=${action}, ` +
        `rollback depth=${rollbackFrames} frames`
    );

    this.pendingRollbackFrame = Math.min(
        this.pendingRollbackFrame ?? frameNumber,
        frameNumber
    );
}
```

4. Add method to export session metrics (for episode summary or server persistence):
```javascript
exportSessionMetrics() {
    return {
        gameId: this.gameId,
        playerId: this.myPlayerId,

        connection: {
            type: this.p2pMetrics.connectionType || 'unknown',
            connectionDetails: this.p2pMetrics.connectionDetails || {}
        },

        inputs: {
            sentViaP2P: this.p2pMetrics.inputsSentViaP2P,
            sentViaSocketIO: this.p2pMetrics.inputsSentViaSocketIO,
            receivedViaP2P: this.p2pMetrics.inputsReceivedViaP2P,
            receivedViaSocketIO: this.p2pMetrics.inputsReceivedViaSocketIO
        },

        rollbacks: this.sessionMetrics.rollbacks,

        sync: {
            p2pHashMismatches: this.p2pHashMismatches || 0
        },

        quality: {
            p2pFallbackTriggered: this.p2pMetrics.p2pFallbackTriggered,
            p2pFallbackFrame: this.p2pMetrics.p2pFallbackFrame
        },

        frames: {
            total: this.frameNumber
        }
    };
}
```

5. Call `exportSessionMetrics()` in the episode summary logging (find the episode complete handler) and include the metrics in the console output.
  </action>
  <verify>
Grep: `grep -n "sessionMetrics\|rollbackEvent\|exportSessionMetrics" interactive_gym/server/static/js/pyodide_multiplayer_game.js` should show the new tracking code
  </verify>
  <done>
Rollback events captured with frame, cause, and player details. Session metrics exportable for research analysis.
  </done>
</task>

</tasks>

<verification>
1. P2P-first logic implemented (check for p2pHealthy variable)
2. `_sendViaSocketIO()` helper method exists
3. `sessionMetrics.rollbacks.events` array captures rollback details
4. `exportSessionMetrics()` method returns structured data
5. Episode summary includes session metrics
</verification>

<success_criteria>
- P2P is primary input transport (SocketIO is fallback only)
- Rollback events logged with frame, predicted/actual action, player ID
- Session metrics exportable for research
- CLEAN-01 requirement further satisfied (server-relay path disabled when P2P active)
</success_criteria>

<output>
After completion, create `.planning/phases/05-validation-and-cleanup/05-02-SUMMARY.md`
</output>
