---
phase: 05-validation-and-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/pyodide_game_coordinator.py
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "No 'host' concept exists in P2P multiplayer mode"
    - "All players receive player assignment with seed"
    - "Symmetric peers work without host election"
  artifacts:
    - path: "interactive_gym/server/pyodide_game_coordinator.py"
      provides: "PyodideGameState without host_player_id"
      contains: "pyodide_player_assigned"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Client without isHost flag"
      contains: "pyodide_player_assigned"
  key_links:
    - from: "pyodide_game_coordinator.py"
      to: "pyodide_multiplayer_game.js"
      via: "pyodide_player_assigned socket event"
      pattern: "pyodide_player_assigned"
---

<objective>
Remove legacy host-based sync code from P2P multiplayer mode.

Purpose: The symmetric P2P architecture (Phase 3) made the host concept obsolete. Both peers broadcast state hashes, both process inputs identically. The `isHost` flag and `host_player_id` field are vestigial and should be removed. The `pyodide_host_elected` event should be renamed to `pyodide_player_assigned` since it now only serves to distribute player ID and seed.

Output: Clean codebase without host concept, same functionality via `pyodide_player_assigned` event.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-validation-and-cleanup/05-RESEARCH.md
@interactive_gym/server/pyodide_game_coordinator.py
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove host_player_id from server-side PyodideGameCoordinator</name>
  <files>interactive_gym/server/pyodide_game_coordinator.py</files>
  <action>
1. Remove `host_player_id` field from `PyodideGameState` dataclass (line 32)
2. Remove `host_player_id=None` from `create_game()` method (line 134)
3. In `add_player()` method (lines 217-249):
   - Remove the `if game.host_player_id is None:` conditional
   - Rename event from `pyodide_host_elected` to `pyodide_player_assigned`
   - Remove `is_host` field from event payload
   - Keep `player_id`, `game_id`, `game_seed`, `num_players` in payload
   - Every player gets the same event structure (no host vs non-host distinction)
4. Remove `host_id` from the non-host branch payload (line 241)
5. Update logging to remove host references (line 249)
6. In `_handle_disconnect()` (line 422): Remove `was_host` check - all players are equal

The event payload should become:
```python
self.sio.emit('pyodide_player_assigned', {
    'player_id': player_id,
    'game_id': game_id,
    'game_seed': game.rng_seed,
    'num_players': game.num_expected_players
}, room=socket_id)
```
  </action>
  <verify>
Run: `python -c "from interactive_gym.server import pyodide_game_coordinator; print('Import OK')"`
Grep: `grep -n "host_player_id\|pyodide_host_elected\|is_host" interactive_gym/server/pyodide_game_coordinator.py` should return no results
  </verify>
  <done>
Server-side code has no host concept. `pyodide_player_assigned` event sent to all players with identical structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove isHost from client-side MultiplayerPyodideGame</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
1. Remove `this.isHost = false;` property initialization (line 415)
2. Rename socket handler from `pyodide_host_elected` to `pyodide_player_assigned` (line 454)
3. In the handler:
   - Remove `this.isHost = data.is_host;` line (line 458)
   - Remove `(host: ${this.isHost})` from console log (line 463)
   - Keep: myPlayerId, gameId, gameSeed assignments
4. Search for any other `this.isHost` references and remove them
5. If `shouldLogData` was tied to `isHost`, keep it but set based on different criteria (e.g., player_id === 0 or first player connected) - check research for guidance

Important: The `shouldLogData` flag may still be needed for host-only data logging. If so, assign it based on a different criterion (e.g., lowest player_id or explicit server flag). Check the existing usage pattern.

The handler should become:
```javascript
socket.on('pyodide_player_assigned', (data) => {
    this.myPlayerId = data.player_id;
    this.gameId = data.game_id;
    this.gameSeed = data.game_seed;

    if (this.gameSeed) {
        seeded_random.initMultiplayerRNG(this.gameSeed);
        console.log(`[MultiplayerPyodide] Player ${this.myPlayerId} assigned to game ${this.gameId} with seed ${this.gameSeed}`);
    }
});
```
  </action>
  <verify>
Grep: `grep -n "isHost\|pyodide_host_elected" interactive_gym/server/static/js/pyodide_multiplayer_game.js` should return no results
  </verify>
  <done>
Client-side code has no host concept. Handler renamed to `pyodide_player_assigned`, isHost flag removed.
  </done>
</task>

</tasks>

<verification>
1. Server imports without error
2. No references to `host_player_id`, `isHost`, or `pyodide_host_elected` remain in modified files
3. `pyodide_player_assigned` event and handler exist
4. Code structure preserved (no syntax errors)
</verification>

<success_criteria>
- CLEAN-01 requirement partially satisfied (host concept removed)
- Both server and client use `pyodide_player_assigned` event
- No `isHost` or `host_player_id` fields exist
- Symmetric peer architecture preserved
</success_criteria>

<output>
After completion, create `.planning/phases/05-validation-and-cleanup/05-01-SUMMARY.md`
</output>
