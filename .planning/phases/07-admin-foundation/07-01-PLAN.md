---
phase: 07-admin-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/admin/__init__.py
  - interactive_gym/server/admin/routes.py
  - interactive_gym/server/admin/namespace.py
  - interactive_gym/server/admin/templates/login.html
  - interactive_gym/server/admin/templates/dashboard.html
  - interactive_gym/server/admin/templates/base.html
  - interactive_gym/server/app.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin and see a dashboard page"
    - "Unauthenticated users are redirected to login when accessing /admin"
    - "Admin can authenticate with password and access the dashboard"
    - "Authenticated admin session persists across page refreshes"
    - "Admin SocketIO namespace is isolated from participant namespace"
  artifacts:
    - path: "interactive_gym/server/admin/__init__.py"
      provides: "Admin blueprint registration and configuration"
      contains: "admin_bp"
    - path: "interactive_gym/server/admin/routes.py"
      provides: "Flask routes for /admin, /admin/login, /admin/logout"
      exports: ["dashboard", "login", "logout"]
    - path: "interactive_gym/server/admin/namespace.py"
      provides: "AdminNamespace for /admin SocketIO"
      contains: "class AdminNamespace"
    - path: "interactive_gym/server/admin/templates/login.html"
      provides: "Admin login form page"
      min_lines: 30
    - path: "interactive_gym/server/admin/templates/dashboard.html"
      provides: "Admin dashboard shell page"
      min_lines: 40
  key_links:
    - from: "interactive_gym/server/app.py"
      to: "admin_bp"
      via: "app.register_blueprint(admin_bp)"
      pattern: "register_blueprint.*admin"
    - from: "interactive_gym/server/app.py"
      to: "AdminNamespace"
      via: "socketio.on_namespace(AdminNamespace)"
      pattern: "on_namespace.*Admin"
    - from: "routes.py dashboard()"
      to: "@login_required"
      via: "decorator requiring authentication"
      pattern: "@login_required"
---

<objective>
Implement secure admin infrastructure with authentication and namespace isolation.

Purpose: Establish the foundation for the admin dashboard that will enable researchers to monitor experiments in real-time. This phase creates the authentication layer, Flask Blueprint routing, and SocketIO namespace separation that all subsequent admin features depend on. Security first - admin routes must require authentication before any functionality.

Output: Working admin login flow at `/admin/login`, authenticated dashboard shell at `/admin`, and isolated `/admin` SocketIO namespace ready for real-time updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/v1.1/SUMMARY.md
@.planning/research/v1.1/ARCHITECTURE.md
@.planning/research/v1.1/STACK.md
@.planning/research/v1.1/PITFALLS.md
@interactive_gym/server/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin module structure and Flask-Login setup</name>
  <files>
    interactive_gym/server/admin/__init__.py
    interactive_gym/server/admin/routes.py
    requirements.txt
  </files>
  <action>
    1. Add `flask-login>=0.6.3` to requirements.txt (keep existing packages).

    2. Create `interactive_gym/server/admin/` directory structure.

    3. Create `interactive_gym/server/admin/__init__.py`:
       ```python
       from flask import Blueprint
       from flask_login import LoginManager

       admin_bp = Blueprint(
           'admin',
           __name__,
           url_prefix='/admin',
           template_folder='templates',
           static_folder='static',
           static_url_path='/admin/static'
       )

       # Simple admin user class for Flask-Login
       class AdminUser:
           def __init__(self, id='admin'):
               self.id = id
               self.is_authenticated = True
               self.is_active = True
               self.is_anonymous = False

           def get_id(self):
               return self.id

       from . import routes  # Import routes after blueprint creation
       ```

    4. Create `interactive_gym/server/admin/routes.py`:
       ```python
       import os
       import functools
       from flask import render_template, redirect, url_for, request, flash, session
       from flask_login import login_user, logout_user, login_required, current_user
       from . import admin_bp, AdminUser

       # Admin password from environment variable (default for development)
       ADMIN_PASSWORD = os.environ.get('ADMIN_PASSWORD', 'admin123')

       def admin_required(f):
           """Decorator that requires admin authentication."""
           @functools.wraps(f)
           @login_required
           def decorated_function(*args, **kwargs):
               return f(*args, **kwargs)
           return decorated_function

       @admin_bp.route('/')
       @admin_required
       def dashboard():
           """Main admin dashboard page."""
           return render_template('dashboard.html')

       @admin_bp.route('/login', methods=['GET', 'POST'])
       def login():
           """Admin login page."""
           if current_user.is_authenticated:
               return redirect(url_for('admin.dashboard'))

           error = None
           if request.method == 'POST':
               password = request.form.get('password', '')
               if password == ADMIN_PASSWORD:
                   user = AdminUser()
                   login_user(user, remember=True)
                   next_page = request.args.get('next')
                   return redirect(next_page or url_for('admin.dashboard'))
               else:
                   error = 'Invalid password'

           return render_template('login.html', error=error)

       @admin_bp.route('/logout')
       @login_required
       def logout():
           """Log out admin user."""
           logout_user()
           return redirect(url_for('admin.login'))
       ```

    5. The password-based auth is intentionally simple per research recommendations - no multi-user permissions needed for v1.1.
  </action>
  <verify>
    - `grep -r "flask-login" requirements.txt` shows flask-login>=0.6.3
    - `ls interactive_gym/server/admin/` shows __init__.py and routes.py
    - `grep -n "admin_bp" interactive_gym/server/admin/__init__.py` shows Blueprint creation
    - `grep -n "@admin_required" interactive_gym/server/admin/routes.py` shows decorator usage
  </verify>
  <done>
    - Flask-Login added to requirements.txt
    - Admin blueprint created with url_prefix='/admin'
    - AdminUser class for session management
    - Login/logout/dashboard routes defined
    - Password authentication from ADMIN_PASSWORD env var (default: admin123)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin templates with DaisyUI styling</name>
  <files>
    interactive_gym/server/admin/templates/base.html
    interactive_gym/server/admin/templates/login.html
    interactive_gym/server/admin/templates/dashboard.html
  </files>
  <action>
    1. Create `interactive_gym/server/admin/templates/` directory.

    2. Create `interactive_gym/server/admin/templates/base.html`:
       ```html
       <!DOCTYPE html>
       <html lang="en" data-theme="light">
       <head>
           <meta charset="UTF-8">
           <meta name="viewport" content="width=device-width, initial-scale=1.0">
           <title>{% block title %}Admin{% endblock %} - Interactive Gym</title>

           <!-- DaisyUI + Tailwind CSS from CDN -->
           <link href="https://cdn.jsdelivr.net/npm/daisyui@5/dist/full.min.css" rel="stylesheet">
           <script src="https://cdn.tailwindcss.com"></script>

           <!-- HTMX for dynamic updates -->
           <script src="https://unpkg.com/htmx.org@2.0.8"></script>

           <!-- Socket.IO client -->
           <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

           {% block head %}{% endblock %}
       </head>
       <body class="min-h-screen bg-base-200">
           {% block body %}{% endblock %}

           {% block scripts %}{% endblock %}
       </body>
       </html>
       ```

    3. Create `interactive_gym/server/admin/templates/login.html`:
       ```html
       {% extends "base.html" %}

       {% block title %}Login{% endblock %}

       {% block body %}
       <div class="min-h-screen flex items-center justify-center">
           <div class="card w-96 bg-base-100 shadow-xl">
               <div class="card-body">
                   <h2 class="card-title text-2xl font-bold text-center w-full justify-center mb-4">
                       Admin Dashboard
                   </h2>
                   <p class="text-center text-base-content/70 mb-6">
                       Interactive Gym Experiment Monitor
                   </p>

                   {% if error %}
                   <div class="alert alert-error mb-4">
                       <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                       </svg>
                       <span>{{ error }}</span>
                   </div>
                   {% endif %}

                   <form method="POST" action="{{ url_for('admin.login') }}">
                       <div class="form-control w-full mb-4">
                           <label class="label">
                               <span class="label-text">Password</span>
                           </label>
                           <input type="password"
                                  name="password"
                                  placeholder="Enter admin password"
                                  class="input input-bordered w-full"
                                  autofocus
                                  required />
                       </div>

                       <div class="form-control mt-6">
                           <button type="submit" class="btn btn-primary w-full">
                               Sign In
                           </button>
                       </div>
                   </form>
               </div>
           </div>
       </div>
       {% endblock %}
       ```

    4. Create `interactive_gym/server/admin/templates/dashboard.html`:
       ```html
       {% extends "base.html" %}

       {% block title %}Dashboard{% endblock %}

       {% block body %}
       <div class="navbar bg-base-100 shadow-lg">
           <div class="flex-1">
               <span class="text-xl font-bold px-4">Interactive Gym Admin</span>
           </div>
           <div class="flex-none">
               <div class="badge badge-success badge-outline mr-4" id="connection-status">
                   Connecting...
               </div>
               <a href="{{ url_for('admin.logout') }}" class="btn btn-ghost btn-sm">
                   Logout
               </a>
           </div>
       </div>

       <div class="container mx-auto p-6">
           <!-- Stats overview (placeholder for Phase 8) -->
           <div class="stats shadow w-full mb-6 bg-base-100">
               <div class="stat">
                   <div class="stat-title">Active Participants</div>
                   <div class="stat-value" id="stat-participants">-</div>
                   <div class="stat-desc">Currently connected</div>
               </div>
               <div class="stat">
                   <div class="stat-title">Active Games</div>
                   <div class="stat-value" id="stat-games">-</div>
                   <div class="stat-desc">In progress</div>
               </div>
               <div class="stat">
                   <div class="stat-title">Waiting Room</div>
                   <div class="stat-value" id="stat-waiting">-</div>
                   <div class="stat-desc">Participants waiting</div>
               </div>
           </div>

           <!-- Main content area (placeholder for Phase 8) -->
           <div class="card bg-base-100 shadow-xl">
               <div class="card-body">
                   <h2 class="card-title">Experiment Monitor</h2>
                   <p class="text-base-content/70">
                       Dashboard foundation ready. Participant monitoring will be added in Phase 8.
                   </p>

                   <div class="divider"></div>

                   <div class="overflow-x-auto">
                       <table class="table" id="participants-table">
                           <thead>
                               <tr>
                                   <th>Subject ID</th>
                                   <th>Status</th>
                                   <th>Current Scene</th>
                                   <th>Connected</th>
                               </tr>
                           </thead>
                           <tbody id="participants-tbody">
                               <!-- Populated via SocketIO in Phase 8 -->
                               <tr>
                                   <td colspan="4" class="text-center text-base-content/50">
                                       No participants connected
                                   </td>
                               </tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>
       {% endblock %}

       {% block scripts %}
       <script>
           // Connect to admin SocketIO namespace
           const adminSocket = io('/admin', {
               transports: ['websocket', 'polling']
           });

           adminSocket.on('connect', () => {
               console.log('Admin connected to /admin namespace');
               document.getElementById('connection-status').textContent = 'Connected';
               document.getElementById('connection-status').classList.remove('badge-warning');
               document.getElementById('connection-status').classList.add('badge-success');
           });

           adminSocket.on('disconnect', () => {
               console.log('Admin disconnected from /admin namespace');
               document.getElementById('connection-status').textContent = 'Disconnected';
               document.getElementById('connection-status').classList.remove('badge-success');
               document.getElementById('connection-status').classList.add('badge-error');
           });

           adminSocket.on('connect_error', (error) => {
               console.error('Admin connection error:', error);
               document.getElementById('connection-status').textContent = 'Error';
               document.getElementById('connection-status').classList.add('badge-error');
           });

           // Placeholder for state updates (Phase 8)
           adminSocket.on('state_update', (data) => {
               console.log('State update received:', data);
           });
       </script>
       {% endblock %}
       ```

    5. Templates use DaisyUI 5 classes per STACK.md recommendations. No custom CSS needed.
  </action>
  <verify>
    - `ls interactive_gym/server/admin/templates/` shows base.html, login.html, dashboard.html
    - `grep -n "daisyui" interactive_gym/server/admin/templates/base.html` shows CDN link
    - `grep -n "io('/admin'" interactive_gym/server/admin/templates/dashboard.html` shows namespace connection
  </verify>
  <done>
    - base.html with DaisyUI/Tailwind CDN imports
    - login.html with password form and error display
    - dashboard.html with navbar, stats placeholders, and SocketIO connection
    - Admin SocketIO connects to /admin namespace (isolated from participants)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AdminNamespace and integrate with app.py</name>
  <files>
    interactive_gym/server/admin/namespace.py
    interactive_gym/server/app.py
  </files>
  <action>
    1. Create `interactive_gym/server/admin/namespace.py`:
       ```python
       """
       Admin SocketIO namespace for real-time dashboard updates.

       This namespace is isolated from the participant namespace (/) to ensure:
       - Admin traffic doesn't pollute participant rooms
       - Different authentication can be applied
       - Can be disabled in production without affecting participants
       """
       import logging
       from flask import session
       from flask_socketio import Namespace, emit, join_room, leave_room
       from flask_login import current_user

       logger = logging.getLogger(__name__)


       class AdminNamespace(Namespace):
           """
           Handles all admin client connections on /admin namespace.

           Security: Requires authenticated admin session before allowing connection.
           """

           def __init__(self, namespace, aggregator=None):
               """
               Initialize admin namespace.

               Args:
                   namespace: The namespace path (should be '/admin')
                   aggregator: Optional AdminEventAggregator for state access (Phase 8+)
               """
               super().__init__(namespace)
               self.aggregator = aggregator
               logger.info(f"AdminNamespace initialized on {namespace}")

           def on_connect(self):
               """
               Handle admin client connection.

               Verifies the user is authenticated before allowing connection.
               Joins the admin_broadcast room for receiving updates.
               """
               # Check if user is authenticated via Flask-Login session
               if not current_user.is_authenticated:
                   logger.warning("Unauthenticated admin connection attempt rejected")
                   return False  # Reject connection

               logger.info(f"Admin connected: {current_user.get_id()}")

               # Join broadcast room for receiving state updates
               join_room('admin_broadcast')

               # Send initial connection confirmation
               emit('admin_connected', {
                   'status': 'connected',
                   'message': 'Admin dashboard connected to /admin namespace'
               })

               return True

           def on_disconnect(self):
               """Handle admin client disconnection."""
               logger.info("Admin disconnected from /admin namespace")
               leave_room('admin_broadcast')

           def on_request_state(self):
               """
               Admin requests current experiment state snapshot.

               Will be implemented in Phase 8 when AdminEventAggregator is added.
               """
               logger.debug("Admin requested state snapshot")

               if self.aggregator:
                   # Phase 8: Return aggregated state
                   state = self.aggregator.get_experiment_snapshot()
                   emit('state_update', state)
               else:
                   # Phase 7: Return placeholder
                   emit('state_update', {
                       'participants': [],
                       'games': [],
                       'message': 'State aggregation not yet implemented'
                   })

           def on_subscribe_participant(self, data):
               """
               Subscribe to updates for a specific participant.

               Args:
                   data: {'subject_id': str}
               """
               subject_id = data.get('subject_id')
               if subject_id:
                   join_room(f'admin_participant_{subject_id}')
                   logger.debug(f"Admin subscribed to participant {subject_id}")

           def on_unsubscribe_participant(self, data):
               """
               Unsubscribe from a specific participant's updates.

               Args:
                   data: {'subject_id': str}
               """
               subject_id = data.get('subject_id')
               if subject_id:
                   leave_room(f'admin_participant_{subject_id}')
                   logger.debug(f"Admin unsubscribed from participant {subject_id}")
       ```

    2. Modify `interactive_gym/server/app.py` to integrate admin components:

       a. Add imports near the top (after existing imports around line 30):
          ```python
          from flask_login import LoginManager
          from interactive_gym.server.admin import admin_bp, AdminUser
          from interactive_gym.server.admin.namespace import AdminNamespace
          ```

       b. After Flask app creation (around line 132-142), add Flask-Login setup:
          ```python
          # Flask-Login setup for admin authentication
          login_manager = LoginManager()
          login_manager.init_app(app)
          login_manager.login_view = 'admin.login'
          login_manager.login_message = 'Please log in to access the admin dashboard.'

          @login_manager.user_loader
          def load_user(user_id):
              if user_id == 'admin':
                  return AdminUser(user_id)
              return None

          # Register admin blueprint
          app.register_blueprint(admin_bp)
          ```

       c. In the `run()` function (around line 1278), after socketio is initialized and before socketio.run(), add:
          ```python
          # Register admin namespace
          admin_namespace = AdminNamespace('/admin')
          socketio.on_namespace(admin_namespace)
          logger.info("Admin namespace registered on /admin")
          ```

    3. IMPORTANT: Preserve all existing code in app.py. Only add the new admin integration code.
  </action>
  <verify>
    - `grep -n "AdminNamespace" interactive_gym/server/admin/namespace.py` shows class definition
    - `grep -n "register_blueprint.*admin" interactive_gym/server/app.py` shows blueprint registration
    - `grep -n "on_namespace.*Admin" interactive_gym/server/app.py` shows namespace registration
    - `grep -n "login_manager" interactive_gym/server/app.py` shows Flask-Login setup
    - Run: `python -c "from interactive_gym.server.admin import admin_bp; print('Import OK')"` - should succeed
  </verify>
  <done>
    - AdminNamespace class with connect/disconnect handlers
    - Namespace rejects unauthenticated connections
    - Admin joins admin_broadcast room on connect
    - Flask-Login integrated in app.py
    - Admin blueprint registered at /admin
    - AdminNamespace registered on /admin SocketIO namespace
  </done>
</task>

</tasks>

<verification>
1. Unit verification:
   - `grep -r "flask-login" requirements.txt` confirms dependency added
   - `ls -la interactive_gym/server/admin/` shows module structure
   - `python -c "from interactive_gym.server.app import app, socketio; print('Imports OK')"` succeeds

2. Manual testing flow:
   a. Start the server: `python -m interactive_gym.server.app` (or your normal start command)
   b. Navigate to http://localhost:PORT/admin
   c. Should redirect to http://localhost:PORT/admin/login
   d. Enter wrong password -> see "Invalid password" error
   e. Enter correct password (default: admin123 or ADMIN_PASSWORD env var)
   f. Should redirect to dashboard at /admin
   g. Dashboard should show "Connected" badge (SocketIO connected)
   h. Open browser console, should see "Admin connected to /admin namespace"
   i. Click Logout -> redirects to login page
   j. Try accessing /admin directly -> redirects to login (session cleared)

3. Namespace isolation check:
   - Open participant view (http://localhost:PORT/some-uuid)
   - Open admin dashboard in another tab
   - In admin console: `adminSocket.emit('test')` should not appear in participant console
   - Participant SocketIO events should not appear in admin console
</verification>

<success_criteria>
1. Admin can navigate to `/admin` and sees either dashboard (if authenticated) or login redirect
2. Unauthenticated users are redirected to `/admin/login` when accessing `/admin`
3. Admin can authenticate with ADMIN_PASSWORD env var (default: admin123) and access dashboard
4. Authenticated admin session persists across page refreshes (Flask-Login remember=True)
5. Admin SocketIO namespace `/admin` is separate from participant namespace `/`
6. AdminNamespace rejects connections from unauthenticated users
7. Dashboard displays "Connected" status when SocketIO connects successfully
8. All existing participant functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-foundation/07-01-SUMMARY.md`
</output>
