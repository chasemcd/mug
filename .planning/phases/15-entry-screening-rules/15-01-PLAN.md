---
phase: 15-entry-screening-rules
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/scenes/gym_scene.py
  - interactive_gym/configurations/remote_config.py
  - interactive_gym/server/static/templates/index.html
  - interactive_gym/server/static/js/index.js
autonomous: true

must_haves:
  truths:
    - "Researcher can configure device type exclusion (mobile/desktop/both) in Python config"
    - "Researcher can configure browser requirements (require/block specific browsers)"
    - "Participant blocked at entry if ping exceeds configured threshold"
    - "Participant sees rule-specific message explaining why excluded"
  artifacts:
    - path: "interactive_gym/scenes/gym_scene.py"
      provides: "Entry screening configuration via entry_screening() method"
      contains: "def entry_screening"
    - path: "interactive_gym/server/static/js/index.js"
      provides: "Client-side browser/device detection and exclusion flow"
      contains: "runEntryScreening"
    - path: "interactive_gym/server/static/templates/index.html"
      provides: "ua-parser-js CDN script"
      contains: "UAParser"
  key_links:
    - from: "interactive_gym/scenes/gym_scene.py"
      to: "activate_scene event"
      via: "get_complete_scene_metadata()"
      pattern: "device_exclusion|browser_requirements|browser_blocklist"
    - from: "interactive_gym/server/static/js/index.js"
      to: "UAParser"
      via: "runEntryScreening function"
      pattern: "new UAParser"
    - from: "interactive_gym/server/static/js/index.js"
      to: "exclusion UI"
      via: "showExclusionMessage function"
      pattern: "showExclusionMessage.*exclusion_messages"
---

<objective>
Implement pre-game entry screening that blocks participants based on device type, browser type, and ping threshold before they can join a game.

Purpose: Researchers need to exclude participants whose devices, browsers, or network conditions don't meet experiment requirements. This phase adds client-side checks with clear exclusion messaging.

Output: Working entry screening with Python configuration API, client-side detection via ua-parser-js, and rule-specific exclusion messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-entry-screening-rules/15-01-RESEARCH.md

# Key source files
@interactive_gym/scenes/gym_scene.py
@interactive_gym/configurations/remote_config.py
@interactive_gym/server/static/js/index.js
@interactive_gym/server/static/templates/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add entry screening configuration to GymScene</name>
  <files>
    - interactive_gym/scenes/gym_scene.py
    - interactive_gym/configurations/remote_config.py
  </files>
  <action>
Add entry screening configuration attributes and method to GymScene class.

1. Add new instance attributes in `__init__`:
```python
# Entry screening (Phase 15)
self.device_exclusion: str | None = None  # "mobile", "desktop", or None (allow all)
self.browser_requirements: list[str] | None = None  # Allowed browsers, e.g., ["Chrome", "Firefox"]
self.browser_blocklist: list[str] | None = None  # Blocked browsers, e.g., ["Safari"]
self.exclusion_messages: dict[str, str] = {
    "mobile": "This study requires a desktop or laptop computer. Please return on a non-mobile device.",
    "desktop": "This study requires a mobile device. Please return on a phone or tablet.",
    "browser": "Your browser is not supported for this study. Please use a different browser.",
    "ping": "Your internet connection is too slow for this study. Please try again with a stronger connection."
}
```

2. Add `entry_screening()` method after the existing `player_grouping()` method:
```python
def entry_screening(
    self,
    device_exclusion: str = NotProvided,
    browser_requirements: list[str] = NotProvided,
    browser_blocklist: list[str] = NotProvided,
    max_ping: int = NotProvided,
    min_ping_measurements: int = NotProvided,
    exclusion_messages: dict[str, str] = NotProvided,
):
    """Configure entry screening rules for the GymScene.

    Entry screening runs before the participant can start the game.
    If any check fails, the participant sees the appropriate exclusion message
    and cannot proceed.

    :param device_exclusion: Device type to exclude. "mobile" excludes phones/tablets,
        "desktop" excludes desktop/laptop computers, None allows all. defaults to NotProvided
    :type device_exclusion: str, optional
    :param browser_requirements: List of allowed browser names (case-insensitive).
        If provided, only these browsers are allowed. e.g., ["Chrome", "Firefox"]. defaults to NotProvided
    :type browser_requirements: list[str], optional
    :param browser_blocklist: List of blocked browser names (case-insensitive).
        These browsers are excluded even if in requirements. e.g., ["Safari"]. defaults to NotProvided
    :type browser_blocklist: list[str], optional
    :param max_ping: Maximum allowed latency in milliseconds. Participants with
        ping exceeding this are excluded. defaults to NotProvided
    :type max_ping: int, optional
    :param min_ping_measurements: Minimum number of ping measurements required
        before checking latency. defaults to NotProvided
    :type min_ping_measurements: int, optional
    :param exclusion_messages: Custom messages for each exclusion type.
        Keys: "mobile", "desktop", "browser", "ping". defaults to NotProvided
    :type exclusion_messages: dict[str, str], optional
    :return: The GymScene instance (self)
    :rtype: GymScene
    """
    if device_exclusion is not NotProvided:
        assert device_exclusion in [None, "mobile", "desktop"], \
            "device_exclusion must be None, 'mobile', or 'desktop'"
        self.device_exclusion = device_exclusion

    if browser_requirements is not NotProvided:
        assert browser_requirements is None or isinstance(browser_requirements, list), \
            "browser_requirements must be None or a list of browser names"
        self.browser_requirements = browser_requirements

    if browser_blocklist is not NotProvided:
        assert browser_blocklist is None or isinstance(browser_blocklist, list), \
            "browser_blocklist must be None or a list of browser names"
        self.browser_blocklist = browser_blocklist

    if max_ping is not NotProvided:
        assert max_ping is None or (isinstance(max_ping, int) and max_ping > 0), \
            "max_ping must be None or a positive integer"
        self.max_ping = max_ping

    if min_ping_measurements is not NotProvided:
        assert isinstance(min_ping_measurements, int) and min_ping_measurements >= 1, \
            "min_ping_measurements must be a positive integer"
        self.min_ping_measurements = min_ping_measurements

    if exclusion_messages is not NotProvided:
        assert isinstance(exclusion_messages, dict), \
            "exclusion_messages must be a dictionary"
        # Merge with defaults (user messages override defaults)
        self.exclusion_messages = {**self.exclusion_messages, **exclusion_messages}

    return self
```

3. In RemoteConfig (for backwards compatibility), ensure the existing `max_ping` and `min_ping_measurements` attributes remain. No new attributes needed there since GymScene is the primary configuration surface for v1.2+.
  </action>
  <verify>
Run Python to verify the GymScene class imports and the new method is accessible:
```bash
cd /Users/chasemcd/Repositories/interactive-gym && python -c "
from interactive_gym.scenes.gym_scene import GymScene
scene = GymScene()
scene.entry_screening(
    device_exclusion='mobile',
    browser_requirements=['Chrome', 'Firefox'],
    browser_blocklist=['Safari'],
    max_ping=200,
    exclusion_messages={'browser': 'Custom browser message'}
)
print('device_exclusion:', scene.device_exclusion)
print('browser_requirements:', scene.browser_requirements)
print('browser_blocklist:', scene.browser_blocklist)
print('max_ping:', scene.max_ping)
print('exclusion_messages:', scene.exclusion_messages)
print('SUCCESS')
"
```
  </verify>
  <done>
GymScene has entry_screening() method with device_exclusion, browser_requirements, browser_blocklist, max_ping, min_ping_measurements, and exclusion_messages configuration. Method validates inputs and returns self for chaining.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ua-parser-js and implement client-side entry screening</name>
  <files>
    - interactive_gym/server/static/templates/index.html
    - interactive_gym/server/static/js/index.js
  </files>
  <action>
Add ua-parser-js library and implement client-side entry screening logic.

1. In `index.html`, add ua-parser-js CDN script BEFORE the index.js import (around line 247):
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/2.0.0/ua-parser.min.js"></script>
```

2. In `index.js`, add the entry screening functions after the `calculateMedian` function (around line 78):

```javascript
// ============================================
// Entry Screening (Phase 15)
// ============================================

/**
 * Run entry screening checks based on scene metadata.
 * Returns an object with { passed: boolean, failedRule: string | null, message: string | null }
 */
function runEntryScreening(sceneMetadata) {
    // If no screening rules configured, pass immediately
    if (!sceneMetadata.device_exclusion &&
        !sceneMetadata.browser_requirements &&
        !sceneMetadata.browser_blocklist) {
        return { passed: true, failedRule: null, message: null };
    }

    const parser = new UAParser();
    const result = parser.getResult();
    const deviceType = result.device.type; // "mobile", "tablet", or undefined (desktop)
    const browserName = result.browser.name; // "Chrome", "Safari", "Firefox", etc.

    console.debug("[EntryScreening] Device type:", deviceType || "desktop");
    console.debug("[EntryScreening] Browser:", browserName);

    // Check device exclusion
    if (sceneMetadata.device_exclusion === "mobile") {
        // Exclude mobile and tablet devices
        if (deviceType === "mobile" || deviceType === "tablet") {
            const message = sceneMetadata.exclusion_messages?.mobile ||
                "This study requires a desktop or laptop computer.";
            return { passed: false, failedRule: "mobile", message: message };
        }
    } else if (sceneMetadata.device_exclusion === "desktop") {
        // Exclude desktop devices (undefined device type = desktop)
        if (!deviceType) {
            const message = sceneMetadata.exclusion_messages?.desktop ||
                "This study requires a mobile device.";
            return { passed: false, failedRule: "desktop", message: message };
        }
    }

    // Check browser blocklist first (takes precedence)
    if (sceneMetadata.browser_blocklist && sceneMetadata.browser_blocklist.length > 0) {
        const blockedLower = sceneMetadata.browser_blocklist.map(b => b.toLowerCase());
        if (browserName && blockedLower.includes(browserName.toLowerCase())) {
            const message = sceneMetadata.exclusion_messages?.browser ||
                "Your browser is not supported for this study.";
            return { passed: false, failedRule: "browser", message: message };
        }
    }

    // Check browser requirements (allowlist)
    if (sceneMetadata.browser_requirements && sceneMetadata.browser_requirements.length > 0) {
        const allowedLower = sceneMetadata.browser_requirements.map(b => b.toLowerCase());
        if (!browserName || !allowedLower.includes(browserName.toLowerCase())) {
            const message = sceneMetadata.exclusion_messages?.browser ||
                "Your browser is not supported for this study.";
            return { passed: false, failedRule: "browser", message: message };
        }
    }

    // All checks passed
    return { passed: true, failedRule: null, message: null };
}

/**
 * Display exclusion message and hide start button.
 */
function showExclusionMessage(message) {
    $("#instructions").hide();
    $("#startButton").hide();
    $("#startButton").attr("disabled", true);
    $('#errorText').text(message);
    $('#errorText').show();
}

// Track entry screening result for the current scene
var entryScreeningPassed = true;
var entryScreeningMessage = null;
```

3. Modify the `startGymScene` function to run entry screening. Find the function (around line 656) and add screening check at the beginning:

In `startGymScene(data)`, after `enableStartRefreshInterval();` and before the gym scene counter logic, add:
```javascript
    // Run entry screening checks (Phase 15)
    const screeningResult = runEntryScreening(data);
    entryScreeningPassed = screeningResult.passed;
    entryScreeningMessage = screeningResult.message;

    if (!screeningResult.passed) {
        console.log("[EntryScreening] Failed:", screeningResult.failedRule, screeningResult.message);
        showExclusionMessage(screeningResult.message);
        // Clear the refresh interval since we're not enabling the start button
        clearInterval(refreshStartButton);
        return; // Don't proceed with scene setup
    }
```

4. Modify the `enableStartRefreshInterval` function to also check ping exclusion. Update the existing ping check (around line 849) to use the configured exclusion message:

Replace the existing ping check block:
```javascript
} else if (maxLatency != null && latencyMeasurements.length > 5 && curLatency > maxLatency) {
    $("#instructions").hide();
    $("#startButton").hide();
    $("#startButton").attr("disabled", true);
    $('#errorText').show()
    $('#errorText').text("Sorry, your connection is too slow for this application. Please make sure you have a strong internet connection to ensure a good experience for all players in the game.");
    clearInterval(refreshStartButton);
}
```

With:
```javascript
} else if (maxLatency != null && latencyMeasurements.length > 5 && curLatency > maxLatency) {
    // Use configured ping exclusion message if available, otherwise use default
    const pingMessage = currentSceneMetadata.exclusion_messages?.ping ||
        "Sorry, your connection is too slow for this application. Please make sure you have a strong internet connection to ensure a good experience for all players in the game.";
    showExclusionMessage(pingMessage);
    clearInterval(refreshStartButton);
}
```

5. Also update the min_ping_measurements check to use the scene metadata value. Find the check `latencyMeasurements.length > 5` and update it to use `currentSceneMetadata.min_ping_measurements || 5`:

```javascript
} else if (maxLatency != null && latencyMeasurements.length <= (currentSceneMetadata.min_ping_measurements || 5)) {
    $("#startButton").show();
    $("#startButton").attr("disabled", true);
}
```

And:
```javascript
} else if (maxLatency != null && latencyMeasurements.length > (currentSceneMetadata.min_ping_measurements || 5) && curLatency > maxLatency) {
```
  </action>
  <verify>
1. Check that ua-parser-js CDN is added to index.html:
```bash
grep -n "UAParser" /Users/chasemcd/Repositories/interactive-gym/interactive_gym/server/static/templates/index.html
```

2. Check that entry screening functions exist in index.js:
```bash
grep -n "runEntryScreening\|showExclusionMessage\|entryScreeningPassed" /Users/chasemcd/Repositories/interactive-gym/interactive_gym/server/static/js/index.js
```

3. Check that startGymScene calls runEntryScreening:
```bash
grep -A5 "function startGymScene" /Users/chasemcd/Repositories/interactive-gym/interactive_gym/server/static/js/index.js | head -20
```
  </verify>
  <done>
ua-parser-js loaded via CDN. runEntryScreening() detects device type and browser, returns pass/fail with message. showExclusionMessage() displays exclusion and hides start button. startGymScene() runs screening before setup. Ping exclusion uses configurable message.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test end-to-end entry screening flow</name>
  <files>
    - (no new files, verification only)
  </files>
  <action>
Create a test script that verifies the complete entry screening configuration flow works from Python to JavaScript.

1. Create a simple test that configures entry screening and verifies the scene metadata contains all the expected fields:

```python
# Test script to verify entry screening metadata propagation
from interactive_gym.scenes.gym_scene import GymScene

# Test 1: All screening options
scene1 = GymScene()
scene1.entry_screening(
    device_exclusion="mobile",
    browser_requirements=["Chrome", "Firefox"],
    browser_blocklist=["Safari"],
    max_ping=200,
    min_ping_measurements=10,
    exclusion_messages={
        "mobile": "Custom mobile message",
        "browser": "Custom browser message",
        "ping": "Custom ping message"
    }
)

metadata = scene1.get_complete_scene_metadata()
assert metadata["device_exclusion"] == "mobile", "device_exclusion not in metadata"
assert metadata["browser_requirements"] == ["Chrome", "Firefox"], "browser_requirements not in metadata"
assert metadata["browser_blocklist"] == ["Safari"], "browser_blocklist not in metadata"
assert metadata["max_ping"] == 200, "max_ping not in metadata"
assert metadata["min_ping_measurements"] == 10, "min_ping_measurements not in metadata"
assert "mobile" in metadata["exclusion_messages"], "exclusion_messages missing mobile"
assert metadata["exclusion_messages"]["mobile"] == "Custom mobile message", "custom mobile message not set"
print("Test 1 PASSED: All screening options in metadata")

# Test 2: Default exclusion messages
scene2 = GymScene()
scene2.entry_screening(device_exclusion="desktop")
metadata2 = scene2.get_complete_scene_metadata()
assert metadata2["device_exclusion"] == "desktop", "device_exclusion not set"
assert "desktop" in metadata2["exclusion_messages"], "default desktop message missing"
assert "ping" in metadata2["exclusion_messages"], "default ping message missing"
print("Test 2 PASSED: Default exclusion messages present")

# Test 3: No screening (defaults)
scene3 = GymScene()
metadata3 = scene3.get_complete_scene_metadata()
assert metadata3.get("device_exclusion") is None, "device_exclusion should be None by default"
assert metadata3.get("browser_requirements") is None, "browser_requirements should be None by default"
print("Test 3 PASSED: Defaults work correctly")

# Test 4: Validation errors
try:
    scene4 = GymScene()
    scene4.entry_screening(device_exclusion="invalid")
    print("Test 4 FAILED: Should have raised assertion error")
except AssertionError:
    print("Test 4 PASSED: Invalid device_exclusion rejected")

# Test 5: Method chaining
scene5 = (
    GymScene()
    .entry_screening(device_exclusion="mobile", max_ping=150)
    .gameplay(num_episodes=3)
)
assert scene5.device_exclusion == "mobile", "chaining failed"
assert scene5.max_ping == 150, "chaining failed"
assert scene5.num_episodes == 3, "chaining failed"
print("Test 5 PASSED: Method chaining works")

print("\nAll tests PASSED!")
```

2. Run the test:
```bash
cd /Users/chasemcd/Repositories/interactive-gym && python -c "
from interactive_gym.scenes.gym_scene import GymScene

# Test 1: All screening options
scene1 = GymScene()
scene1.entry_screening(
    device_exclusion='mobile',
    browser_requirements=['Chrome', 'Firefox'],
    browser_blocklist=['Safari'],
    max_ping=200,
    min_ping_measurements=10,
    exclusion_messages={
        'mobile': 'Custom mobile message',
        'browser': 'Custom browser message',
        'ping': 'Custom ping message'
    }
)

metadata = scene1.get_complete_scene_metadata()
assert metadata['device_exclusion'] == 'mobile', 'device_exclusion not in metadata'
assert metadata['browser_requirements'] == ['Chrome', 'Firefox'], 'browser_requirements not in metadata'
assert metadata['browser_blocklist'] == ['Safari'], 'browser_blocklist not in metadata'
assert metadata['max_ping'] == 200, 'max_ping not in metadata'
assert metadata['min_ping_measurements'] == 10, 'min_ping_measurements not in metadata'
assert 'mobile' in metadata['exclusion_messages'], 'exclusion_messages missing mobile'
assert metadata['exclusion_messages']['mobile'] == 'Custom mobile message', 'custom mobile message not set'
print('Test 1 PASSED: All screening options in metadata')

# Test 2: Default exclusion messages
scene2 = GymScene()
scene2.entry_screening(device_exclusion='desktop')
metadata2 = scene2.get_complete_scene_metadata()
assert metadata2['device_exclusion'] == 'desktop', 'device_exclusion not set'
assert 'desktop' in metadata2['exclusion_messages'], 'default desktop message missing'
assert 'ping' in metadata2['exclusion_messages'], 'default ping message missing'
print('Test 2 PASSED: Default exclusion messages present')

# Test 3: No screening (defaults)
scene3 = GymScene()
metadata3 = scene3.get_complete_scene_metadata()
assert metadata3.get('device_exclusion') is None, 'device_exclusion should be None by default'
assert metadata3.get('browser_requirements') is None, 'browser_requirements should be None by default'
print('Test 3 PASSED: Defaults work correctly')

# Test 4: Validation errors
try:
    scene4 = GymScene()
    scene4.entry_screening(device_exclusion='invalid')
    print('Test 4 FAILED: Should have raised assertion error')
except AssertionError:
    print('Test 4 PASSED: Invalid device_exclusion rejected')

# Test 5: Method chaining
scene5 = (
    GymScene()
    .entry_screening(device_exclusion='mobile', max_ping=150)
    .gameplay(num_episodes=3)
)
assert scene5.device_exclusion == 'mobile', 'chaining failed'
assert scene5.max_ping == 150, 'chaining failed'
assert scene5.num_episodes == 3, 'chaining failed'
print('Test 5 PASSED: Method chaining works')

print()
print('All tests PASSED!')
"
```
  </action>
  <verify>
All 5 tests pass:
- Test 1: All screening options propagate to metadata
- Test 2: Default exclusion messages are present
- Test 3: Defaults work (None values)
- Test 4: Invalid inputs are rejected
- Test 5: Method chaining works
  </verify>
  <done>
Entry screening configuration flows correctly from Python GymScene through get_complete_scene_metadata() to the activate_scene event. All configuration options are accessible in JavaScript via sceneMetadata object.
  </done>
</task>

</tasks>

<verification>
Run these commands to verify Phase 15 implementation:

1. Python configuration API works:
```bash
cd /Users/chasemcd/Repositories/interactive-gym && python -c "
from interactive_gym.scenes.gym_scene import GymScene
scene = GymScene().entry_screening(device_exclusion='mobile', browser_requirements=['Chrome'])
print('Config OK:', scene.device_exclusion, scene.browser_requirements)
"
```

2. ua-parser-js is loaded:
```bash
grep "UAParser" /Users/chasemcd/Repositories/interactive-gym/interactive_gym/server/static/templates/index.html
```

3. Entry screening functions exist in JavaScript:
```bash
grep -c "runEntryScreening\|showExclusionMessage" /Users/chasemcd/Repositories/interactive-gym/interactive_gym/server/static/js/index.js
```

4. startGymScene calls runEntryScreening:
```bash
grep -B2 -A10 "function startGymScene" /Users/chasemcd/Repositories/interactive-gym/interactive_gym/server/static/js/index.js | grep -c "runEntryScreening"
```
</verification>

<success_criteria>
**ENTRY-01 (Device exclusion):**
- GymScene.entry_screening(device_exclusion="mobile") blocks mobile/tablet devices
- GymScene.entry_screening(device_exclusion="desktop") blocks desktop devices
- device_exclusion=None (default) allows all devices

**ENTRY-02 (Browser requirements):**
- browser_requirements=["Chrome", "Firefox"] only allows those browsers
- browser_blocklist=["Safari"] blocks Safari even if in requirements
- Browser checks are case-insensitive

**ENTRY-03 (Ping threshold):**
- max_ping=200 blocks participants with latency > 200ms
- Uses existing ping measurement infrastructure
- Respects min_ping_measurements before checking

**ENTRY-04 (Exclusion messages):**
- Each exclusion type shows its configured message
- Default messages provided for all exclusion types
- Messages displayed via showExclusionMessage() in errorText element
</success_criteria>

<output>
After completion, create `.planning/phases/15-entry-screening-rules/15-01-SUMMARY.md`
</output>
