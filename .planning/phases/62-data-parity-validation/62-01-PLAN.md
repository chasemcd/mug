---
phase: 62-data-parity-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "test_active_input_with_latency[chromium-100] passes with exact data parity"
    - "test_active_input_with_latency[chromium-200] passes with exact data parity"
    - "test_active_input_with_packet_loss passes with exact data parity"
    - "Both players' exports contain identical actions.0 and actions.1 for every row"
    - "Both players' exports contain identical rewards.0 and rewards.1 for every row"
    - "Both players' exports contain identical infos columns for every row"
  artifacts:
    - path: "tests/e2e/test_latency_injection.py"
      provides: "Active input latency tests with parity validation"
      contains: "test_active_input_with_latency"
    - path: "tests/e2e/test_network_disruption.py"
      provides: "Packet loss test with parity validation"
      contains: "test_active_input_with_packet_loss"
    - path: "scripts/validate_action_sequences.py"
      provides: "Parity comparison script"
      exports: ["compare_files"]
  key_links:
    - from: "tests/e2e/test_latency_injection.py"
      to: "scripts/validate_action_sequences.py"
      via: "run_comparison() helper"
      pattern: "run_comparison.*file1.*file2"
    - from: "tests/fixtures/export_helpers.py"
      to: "scripts/validate_action_sequences.py"
      via: "subprocess call with --compare flag"
      pattern: "validate_action_sequences.py.*--compare"
---

<objective>
Validate that the Input Confirmation Protocol (Phase 61) ensures both players export identical data for actions, rewards, and infos under network stress conditions.

Purpose: Phase 61 implemented a wait mechanism before episode export to ensure both players have confirmed inputs for all frames. Phase 62 validates this fix by running the existing E2E parity tests that previously failed intermittently due to data divergence at episode boundaries under packet loss.

Output: All 3 critical parity tests pass with exact data parity (no tolerance needed), proving PARITY-03, PARITY-04, and PARITY-05 requirements are satisfied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-input-confirmation-protocol/61-01-SUMMARY.md

# Existing test infrastructure
@tests/e2e/test_latency_injection.py
@tests/e2e/test_network_disruption.py
@tests/fixtures/export_helpers.py
@scripts/validate_action_sequences.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run parity tests under latency conditions</name>
  <files>tests/e2e/test_latency_injection.py</files>
  <action>
Run the active input latency tests to verify data parity under network stress:

```bash
cd /Users/chasemcd/Repositories/interactive-gym
pytest tests/e2e/test_latency_injection.py::test_active_input_with_latency -v --tb=short
```

This runs both parametrized variants:
- `test_active_input_with_latency[chromium-100]` (100ms latency)
- `test_active_input_with_latency[chromium-200]` (200ms latency)

Both tests inject random actions on both players while one player experiences network latency. After episode completion, they compare export files using `run_comparison()` which invokes `validate_action_sequences.py --compare`.

Expected behavior after Phase 61 fix:
- Both tests should PASS with exit code 0
- Comparison output should show "FILES ARE IDENTICAL"
- No action, reward, or info divergences

If tests fail:
- Capture full pytest output including comparison divergence details
- Check if timeout occurred (500ms may be insufficient for 200ms latency + packet retransmission)
- Log the specific columns and rows with divergences
  </action>
  <verify>
Both `test_active_input_with_latency[chromium-100]` and `test_active_input_with_latency[chromium-200]` pass (pytest exit code 0).
  </verify>
  <done>
Both latency variants pass with exact data parity. Comparison output shows "FILES ARE IDENTICAL" for both tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run parity test under packet loss conditions</name>
  <files>tests/e2e/test_network_disruption.py</files>
  <action>
Run the active input packet loss test to verify data parity under the most stressful network condition:

```bash
cd /Users/chasemcd/Repositories/interactive-gym
pytest tests/e2e/test_network_disruption.py::test_active_input_with_packet_loss -v --tb=short
```

This test applies 15% packet loss + 50ms latency to player 2 while both players inject random actions. This is the most challenging scenario because:
- Packet loss causes rollbacks which re-predict actions
- Active inputs (not just Noop) stress the dual-buffer recording
- Both players inject different actions at different intervals

Expected behavior after Phase 61 fix:
- Test should PASS with exit code 0
- The input confirmation wait (500ms) ensures both players have confirmed inputs before export
- Comparison output should show "FILES ARE IDENTICAL"

If test fails:
- Capture comparison output with divergence details
- Check if 500ms timeout was insufficient (may need increase for severe packet loss)
- Note: Some rollbacks are expected during gameplay - the fix ensures export data matches, not that no rollbacks occur
  </action>
  <verify>
`test_active_input_with_packet_loss` passes (pytest exit code 0).
  </verify>
  <done>
Packet loss test passes with exact data parity. Comparison output shows "FILES ARE IDENTICAL".
  </done>
</task>

<task type="auto">
  <name>Task 3: Document verification results and update requirements</name>
  <files></files>
  <action>
After both Task 1 and Task 2 pass, document the verification results:

1. Summarize test results:
   - Number of tests run
   - Pass/fail status for each
   - Any warnings or notes from test output

2. Confirm requirements satisfaction:
   - PARITY-03: Both players export identical action sequences (actions.0, actions.1 match)
   - PARITY-04: Both players export identical rewards (rewards.0, rewards.1 match)
   - PARITY-05: Both players export identical infos (infos.* columns match)

3. If all tests pass, no code changes are needed - the Phase 61 fix is validated.

4. If any test fails:
   - Document the specific divergence pattern
   - Identify if the issue is timeout-related (increase input_confirmation_timeout_ms) or a different bug
   - Create a follow-up task in STATE.md if needed

Note: Do NOT modify test code to add tolerances or xfail markers. Data parity must be EXACT for research validity. If tests fail, the fix needs adjustment, not the tests.
  </action>
  <verify>
Summary includes pass/fail status for all 3 tests. Requirements PARITY-03, PARITY-04, PARITY-05 explicitly addressed.
  </verify>
  <done>
Verification results documented. All 3 requirements (PARITY-03, PARITY-04, PARITY-05) confirmed satisfied by test results.
  </done>
</task>

</tasks>

<verification>
Phase verification:

1. **Test execution:**
   - `pytest tests/e2e/test_latency_injection.py::test_active_input_with_latency -v` returns exit code 0
   - `pytest tests/e2e/test_network_disruption.py::test_active_input_with_packet_loss -v` returns exit code 0

2. **Data parity confirmation:**
   - All comparison outputs show "FILES ARE IDENTICAL"
   - No divergences in actions.0, actions.1 columns
   - No divergences in rewards.0, rewards.1 columns
   - No divergences in infos.* columns

3. **Requirements satisfied:**
   - PARITY-03: Action sequences identical (validated by test_active_input_with_latency and test_active_input_with_packet_loss)
   - PARITY-04: Rewards identical (same tests validate rewards columns)
   - PARITY-05: Infos identical (same tests validate infos columns via validate_action_sequences.py)
</verification>

<success_criteria>
- [ ] test_active_input_with_latency[chromium-100] passes
- [ ] test_active_input_with_latency[chromium-200] passes
- [ ] test_active_input_with_packet_loss passes
- [ ] All comparison outputs show "FILES ARE IDENTICAL"
- [ ] No xfail markers or tolerance adjustments needed
- [ ] PARITY-03, PARITY-04, PARITY-05 requirements documented as satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/62-data-parity-validation/62-01-SUMMARY.md`
</output>
