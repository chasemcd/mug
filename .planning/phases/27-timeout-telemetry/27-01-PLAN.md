---
phase: 27-timeout-telemetry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/scenes/gym_scene.py
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Researcher can configure focus loss timeout via Python API"
    - "Game ends for both players when timeout exceeded"
    - "Custom message displayed when game ends due to focus loss"
    - "Focus loss events included in exported session data"
    - "Duration of each focus loss period in exported data"
  artifacts:
    - path: "interactive_gym/scenes/gym_scene.py"
      provides: "focus_loss_config() method"
      contains: "def focus_loss_config"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Timeout check in FocusManager, game end trigger, telemetry export"
      contains: "focusLossTelemetry"
  key_links:
    - from: "interactive_gym/scenes/gym_scene.py"
      to: "pyodide_multiplayer_game.js"
      via: "config serialization in get_complete_scene_metadata"
      pattern: "focus_loss_timeout_ms|focus_loss_message"
    - from: "FocusManager.getCurrentBackgroundDuration()"
      to: "_handleFocusLossTimeout()"
      via: "timeout check in _handleWorkerTick"
      pattern: "getCurrentBackgroundDuration.*focus_loss_timeout"
    - from: "FocusManager.getTelemetry()"
      to: "exportMultiplayerMetrics()"
      via: "telemetry inclusion in metrics export"
      pattern: "focusLossTelemetry.*getTelemetry"
---

<objective>
Add configurable focus loss timeout with graceful game ending and research telemetry export.

Purpose: Complete v1.5 Focus Loss Handling by enabling researchers to configure timeout behavior and capture focus loss data for analysis.

Output:
- `focus_loss_config()` method on GymScene for timeout/message configuration
- Timeout enforcement in FocusManager that ends game when exceeded
- Focus loss telemetry included in `exportMultiplayerMetrics()` output
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-focus-detection/25-01-SUMMARY.md
@.planning/phases/26-resync-partner-ux/26-01-SUMMARY.md
@.planning/phases/23-partner-disconnect-handling/23-01-SUMMARY.md
@interactive_gym/scenes/gym_scene.py
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add focus_loss_config() to GymScene</name>
  <files>interactive_gym/scenes/gym_scene.py</files>
  <action>
Add new attributes and config method following the established pattern from partner_disconnect_message_config() and reconnection_config().

1. Add attributes in __init__ after partner_disconnect_message (line ~188):
```python
# Focus loss handling (Phase 27)
self.focus_loss_timeout_ms: int = 30000  # Default 30 seconds
self.focus_loss_message: str | None = None  # Custom message, None uses default
```

2. Add focus_loss_config() method after partner_disconnect_message_config() (around line 808):
```python
def focus_loss_config(
    self,
    timeout_ms: int = NotProvided,
    message: str = NotProvided,
) -> "GymScene":
    """Configure focus loss handling for multiplayer games.

    When a participant tabs away for longer than timeout_ms, the game
    ends for both players and a message is displayed.

    Args:
        timeout_ms: Time in milliseconds before focus loss ends the game.
                   Default is 30000 (30 seconds). Set to 0 to disable.
        message: Custom message to display when game ends due to focus loss.
                If not set, a default message is shown.

    Returns:
        self for chaining.

    Example:
        scene.focus_loss_config(
            timeout_ms=20000,  # 20 seconds
            message="Please stay focused on the experiment."
        )
    """
    if timeout_ms is not NotProvided:
        if not isinstance(timeout_ms, int) or timeout_ms < 0:
            raise ValueError("timeout_ms must be a non-negative integer")
        self.focus_loss_timeout_ms = timeout_ms

    if message is not NotProvided:
        self.focus_loss_message = message

    return self
```

The attributes will be automatically serialized to the client via get_complete_scene_metadata() since they are simple types (int, str).
  </action>
  <verify>
Run: python -c "from interactive_gym.scenes.gym_scene import GymScene; s = GymScene(); s.focus_loss_config(timeout_ms=20000, message='Test'); print(f'timeout={s.focus_loss_timeout_ms}, msg={s.focus_loss_message}')"
Expected output: timeout=20000, msg=Test
  </verify>
  <done>GymScene has focus_loss_config() method that sets timeout_ms and message attributes</done>
</task>

<task type="auto">
  <name>Task 2: Add timeout enforcement and game end trigger</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Add timeout checking in FocusManager and game end handling. Follow the pattern from _handleReconnectionGameEnd() and _showPartnerDisconnectedOverlay().

1. Add to FocusManager class (after _onForegrounded method, around line 211):
```javascript
/**
 * Set timeout configuration from scene config.
 * @param {number} timeoutMs - Timeout in milliseconds (0 to disable)
 */
setTimeoutConfig(timeoutMs) {
    this.timeoutMs = timeoutMs;
}

/**
 * Check if timeout has been exceeded.
 * @returns {boolean} True if backgrounded longer than timeout
 */
isTimeoutExceeded() {
    if (!this.timeoutMs || this.timeoutMs === 0) return false;
    return this.getCurrentBackgroundDuration() > this.timeoutMs;
}
```

2. Add to FocusManager constructor (after line 176):
```javascript
this.timeoutMs = 30000;  // Default 30s, overridden by config
```

3. In PyodideMultiplayerGame constructor (in the section after setting up focusManager), add config initialization:
```javascript
// Configure focus loss timeout from scene config (Phase 27)
if (this.config?.focus_loss_timeout_ms !== undefined) {
    this.focusManager.setTimeoutConfig(this.config.focus_loss_timeout_ms);
}
```

4. In _handleWorkerTick(), add timeout check near the start (after the existing background check at line ~5440):
```javascript
// Phase 27: Check focus loss timeout
if (this.focusManager?.isBackgrounded && this.focusManager.isTimeoutExceeded()) {
    this._handleFocusLossTimeout();
    return;  // Don't process tick - game is ending
}
```

5. Add new method _handleFocusLossTimeout() after _handleReconnectionGameEnd():
```javascript
/**
 * Handle focus loss timeout (Phase 27 - TIMEOUT-02).
 * Ends game for both players when focus loss exceeds configured timeout.
 */
_handleFocusLossTimeout() {
    const timeoutMs = this.focusManager.timeoutMs;
    const actualMs = this.focusManager.getCurrentBackgroundDuration();
    p2pLog.warn(`Focus loss timeout exceeded: ${actualMs.toFixed(0)}ms > ${timeoutMs}ms`);

    // Stop game state - similar to _handleReconnectionGameEnd
    this.state = "done";
    this.episodeComplete = true;
    this.focusLossTimeoutTerminal = true;  // Prevent scene advance

    // Pause continuous monitoring if active
    if (this.continuousMonitor) {
        this.continuousMonitor.pause();
    }

    // Clean up Web Worker timer
    this._destroyTimerWorker();

    // Mark session as partial with focus loss metadata
    this.sessionPartialInfo = {
        isPartial: true,
        terminationReason: 'focus_loss_timeout',
        terminationFrame: this.frameNumber,
        focusLossDurationMs: actualMs,
        focusLossTimeoutMs: timeoutMs,
        focusLossTelemetry: this.focusManager.getTelemetry()
    };

    // Export metrics before showing overlay
    if (this.gameId && this.sceneId) {
        this.emitMultiplayerMetrics(this.sceneId);
    }

    // Get custom message from config or use default
    const customMessage = this.config?.focus_loss_message;
    const message = customMessage || "You were away from the experiment for too long. The game has ended.";

    // Show in-page overlay (reuse partner disconnect overlay pattern)
    this._showFocusLossTimeoutOverlay(message);

    // Close P2P connection
    if (this.webrtcManager) {
        this.webrtcManager.close();
    }

    // Notify server that game ended due to focus loss
    socket.emit('p2p_game_ended', {
        game_id: this.gameId,
        reason: 'focus_loss_timeout',
        player_id: this.myPlayerId,
        focus_loss_duration_ms: actualMs
    });
}

/**
 * Show focus loss timeout message (Phase 27 - TIMEOUT-03).
 * Reuses partner disconnected overlay pattern.
 * @param {string} message - Message to display
 */
_showFocusLossTimeoutOverlay(message) {
    // Remove any existing overlays
    this._hideReconnectingOverlay();

    // Hide ALL direct children of body
    Array.from(document.body.children).forEach(child => {
        if (child.id !== 'focusLossContainer') {
            child.style.display = 'none';
        }
    });

    // Create container
    let container = document.getElementById('focusLossContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'focusLossContainer';
        container.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        document.body.appendChild(container);
    }

    container.innerHTML = `
        <div style="
            padding: 40px;
            max-width: 500px;
            text-align: center;
        ">
            <h2 style="color: #333; margin-bottom: 20px;">Session Ended</h2>
            <p style="font-size: 16px; color: #333;">${message}</p>
        </div>
    `;
    container.style.display = 'flex';
}
```

6. Update isDone() method to check focusLossTimeoutTerminal (search for partnerDisconnectedTerminal):
```javascript
// Add alongside existing partnerDisconnectedTerminal check
if (this.focusLossTimeoutTerminal) {
    return false;  // Prevent scene advance - terminal state
}
```
  </action>
  <verify>
Grep for new methods: grep -n "isTimeoutExceeded\|_handleFocusLossTimeout\|focusLossTimeoutTerminal" interactive_gym/server/static/js/pyodide_multiplayer_game.js
Should find all three patterns.
  </verify>
  <done>FocusManager checks timeout, game ends when exceeded, overlay displayed with custom message</done>
</task>

<task type="auto">
  <name>Task 3: Add focus loss telemetry to metrics export</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Include FocusManager telemetry in exportMultiplayerMetrics() output.

1. In exportMultiplayerMetrics() (around line 6184), add focus telemetry section after the existing metrics. Find the return statement and add a new section:

After the existing `sessionPartial` section (around line 6275), add:
```javascript
// Focus loss telemetry (Phase 27 - TELEM-01, TELEM-02)
focusLoss: this.focusManager ? {
    backgroundPeriods: this.focusManager.getBackgroundPeriods(),
    totalBackgroundMs: this.focusManager.getTelemetry().totalBackgroundMs,
    periodCount: this.focusManager.getTelemetry().periodCount,
    timeoutMs: this.focusManager.timeoutMs,
    wasTimeoutTriggered: this.focusLossTimeoutTerminal || false
} : null,
```

2. Add focusLossTimeoutTerminal property initialization in constructor (after partnerDisconnectedTerminal if it exists, or in the state initialization section):
```javascript
this.focusLossTimeoutTerminal = false;
```
  </action>
  <verify>
Grep for telemetry: grep -n "focusLoss:" interactive_gym/server/static/js/pyodide_multiplayer_game.js
Should find the focusLoss section in exportMultiplayerMetrics.
  </verify>
  <done>exportMultiplayerMetrics includes focusLoss telemetry with backgroundPeriods and durations</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Python config test:
```bash
python -c "
from interactive_gym.scenes.gym_scene import GymScene
s = GymScene()
s.focus_loss_config(timeout_ms=20000, message='Custom timeout message')
meta = s.get_complete_scene_metadata()
assert meta['focus_loss_timeout_ms'] == 20000
assert meta['focus_loss_message'] == 'Custom timeout message'
print('Config test passed')
"
```

2. JavaScript pattern verification:
```bash
grep -c "isTimeoutExceeded\|_handleFocusLossTimeout\|focusLoss:" interactive_gym/server/static/js/pyodide_multiplayer_game.js
```
Should return 3+ matches (one for each pattern).

3. Default value test:
```bash
python -c "
from interactive_gym.scenes.gym_scene import GymScene
s = GymScene()
assert s.focus_loss_timeout_ms == 30000
assert s.focus_loss_message is None
print('Defaults test passed')
"
```
</verification>

<success_criteria>
- [x] TIMEOUT-01: focus_loss_timeout_ms configurable (default 30s)
- [x] TIMEOUT-02: Game ends for both players when timeout exceeded
- [x] TIMEOUT-03: Custom message displayed via focus_loss_message config
- [x] TELEM-01: Focus loss events recorded in session metadata
- [x] TELEM-02: Duration of each focus loss period in exported data
</success_criteria>

<output>
After completion, create `.planning/phases/27-timeout-telemetry/27-01-SUMMARY.md`
</output>
