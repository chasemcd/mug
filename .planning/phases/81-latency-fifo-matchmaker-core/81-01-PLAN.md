---
phase: 81-latency-fifo-matchmaker-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/matchmaker.py
  - tests/unit/__init__.py
  - tests/unit/test_latency_fifo_matchmaker.py
autonomous: true

must_haves:
  truths:
    - "LatencyFIFOMatchmaker(max_server_rtt_ms=200) can be instantiated with a configurable threshold"
    - "find_match() skips waiting candidates where sum of server RTTs exceeds max_server_rtt_ms"
    - "When no candidate passes the RTT filter, arriving participant waits (returns None)"
    - "When a candidate's RTT data is unavailable (None), they are NOT excluded (graceful fallback)"
  artifacts:
    - path: "interactive_gym/server/matchmaker.py"
      provides: "LatencyFIFOMatchmaker class"
      contains: "class LatencyFIFOMatchmaker"
    - path: "tests/unit/test_latency_fifo_matchmaker.py"
      provides: "Unit tests for LatencyFIFOMatchmaker"
      contains: "test_"
  key_links:
    - from: "interactive_gym/server/matchmaker.py"
      to: "Matchmaker base class"
      via: "class LatencyFIFOMatchmaker(Matchmaker)"
      pattern: "class LatencyFIFOMatchmaker\\(Matchmaker\\)"
    - from: "tests/unit/test_latency_fifo_matchmaker.py"
      to: "interactive_gym/server/matchmaker.py"
      via: "import"
      pattern: "from interactive_gym.server.matchmaker import LatencyFIFOMatchmaker"
---

<objective>
Implement LatencyFIFOMatchmaker -- a Matchmaker subclass that pre-filters candidates by estimated P2P RTT (sum of server RTTs) before proposing FIFO matches.

Purpose: Researchers running latency-sensitive experiments need to ensure matched pairs have low enough network latency for valid data collection. This matchmaker skips high-latency candidates at match time, before any P2P probe happens.

Output: Working LatencyFIFOMatchmaker class with comprehensive unit tests proving all four success criteria.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@interactive_gym/server/matchmaker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement LatencyFIFOMatchmaker class</name>
  <files>interactive_gym/server/matchmaker.py</files>
  <action>
Add a new `LatencyFIFOMatchmaker` class after the existing `FIFOMatchmaker` class (and before `GroupReunionMatchmaker`) in `interactive_gym/server/matchmaker.py`.

The class must:

1. **Extend `Matchmaker`** (not FIFOMatchmaker -- keep it a clean, independent subclass to avoid coupling).

2. **Accept `max_server_rtt_ms` parameter** in `__init__`:
   - Type: `int`
   - Required (no default -- the researcher must explicitly choose a threshold)
   - Also accept optional `max_p2p_rtt_ms: int | None = None` (passed to super().__init__() for post-match P2P probe filtering)
   - Store as `self.max_server_rtt_ms`

3. **Implement `find_match()`** with this logic:
   - If `len(waiting) + 1 < group_size`: return None (not enough candidates)
   - Estimate P2P RTT for each waiting candidate: `estimated_rtt = arriving.rtt_ms + candidate.rtt_ms` (sum of server RTTs as a heuristic for P2P RTT)
   - **Graceful fallback**: If `arriving.rtt_ms is None` OR `candidate.rtt_ms is None`, do NOT exclude the candidate (treat missing RTT as compatible -- err on the side of matching, not waiting forever)
   - Filter waiting candidates: keep those where `estimated_rtt <= self.max_server_rtt_ms` OR where RTT data is missing for either participant
   - From the filtered list, apply FIFO order: take the first `group_size - 1` candidates + arriving
   - If filtered list has fewer than `group_size - 1` candidates, return None (no valid match)
   - Log decisions at INFO level using the module logger, following the pattern of FIFOMatchmaker's logging (prefix with `[LatencyFIFOMatchmaker]`)

4. **Add docstring** following the existing class docstring style (see FIFOMatchmaker, GroupReunionMatchmaker). Include:
   - Description of the RTT heuristic (sum of server RTTs approximates P2P RTT)
   - Note that missing RTT data does NOT exclude candidates
   - Example usage showing `LatencyFIFOMatchmaker(max_server_rtt_ms=200)`
   - Args section for `max_server_rtt_ms` and `max_p2p_rtt_ms`

5. **Update the module's exports**: The class must be importable as `from interactive_gym.server.matchmaker import LatencyFIFOMatchmaker`.

Do NOT modify FIFOMatchmaker, GroupReunionMatchmaker, or Matchmaker base class. Only ADD the new class.
  </action>
  <verify>
Run: `python -c "from interactive_gym.server.matchmaker import LatencyFIFOMatchmaker, MatchCandidate; m = LatencyFIFOMatchmaker(max_server_rtt_ms=200); print(f'threshold={m.max_server_rtt_ms}'); a = MatchCandidate(subject_id='a', rtt_ms=50); b = MatchCandidate(subject_id='b', rtt_ms=80); result = m.find_match(a, [b], 2); print(f'match={[c.subject_id for c in result] if result else None}'); c = MatchCandidate(subject_id='c', rtt_ms=180); result2 = m.find_match(a, [c], 2); print(f'high_rtt_match={result2}'); d = MatchCandidate(subject_id='d', rtt_ms=None); result3 = m.find_match(a, [d], 2); print(f'none_rtt_match={[x.subject_id for x in result3] if result3 else None}')"` should output:
- threshold=200
- match=['b', 'a'] (50+80=130 <= 200, passes)
- high_rtt_match=None (50+180=230 > 200, filtered out, no remaining candidates)
- none_rtt_match=['d', 'a'] (None RTT = not excluded)
  </verify>
  <done>
LatencyFIFOMatchmaker class exists in matchmaker.py with configurable max_server_rtt_ms, RTT-based filtering in find_match(), and graceful None-RTT fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for LatencyFIFOMatchmaker</name>
  <files>tests/unit/__init__.py, tests/unit/test_latency_fifo_matchmaker.py</files>
  <action>
Create `tests/unit/__init__.py` (empty file) and `tests/unit/test_latency_fifo_matchmaker.py`.

The test file must cover ALL four success criteria from the roadmap. Use pytest with no fixtures needed (pure unit tests -- MatchCandidate and LatencyFIFOMatchmaker have no I/O dependencies).

**Test cases (each is a separate test function):**

1. `test_instantiation_with_threshold` -- MATCH-01/MATCH-02:
   - `LatencyFIFOMatchmaker(max_server_rtt_ms=200)` stores threshold correctly
   - `LatencyFIFOMatchmaker(max_server_rtt_ms=200, max_p2p_rtt_ms=150)` stores both thresholds

2. `test_basic_match_within_threshold` -- Success Criteria 1+2:
   - arriving(rtt=50) + waiting=[candidate(rtt=80)], group_size=2, threshold=200
   - 50+80=130 <= 200 => match returned with both candidates

3. `test_skip_candidate_exceeding_threshold` -- Success Criteria 2:
   - arriving(rtt=120) + waiting=[candidate(rtt=150)], group_size=2, threshold=200
   - 120+150=270 > 200 => returns None

4. `test_skip_high_rtt_pick_lower` -- Success Criteria 2 (multiple candidates):
   - arriving(rtt=50) + waiting=[cand_a(rtt=180), cand_b(rtt=60)], group_size=2, threshold=200
   - cand_a filtered (50+180=230), cand_b passes (50+60=110)
   - Result includes cand_b and arriving (FIFO from filtered list)

5. `test_no_candidate_passes_filter_returns_none` -- Success Criteria 3:
   - arriving(rtt=150) + waiting=[cand(rtt=200)], group_size=2, threshold=200
   - 150+200=350 > 200 => returns None

6. `test_not_enough_participants` -- basic FIFO behavior:
   - arriving(rtt=50) + waiting=[], group_size=2, threshold=200
   - returns None (not enough for group)

7. `test_none_rtt_arriving_not_excluded` -- Success Criteria 4:
   - arriving(rtt=None) + waiting=[candidate(rtt=100)], group_size=2, threshold=200
   - arriving has no RTT data => candidate NOT excluded => match returned

8. `test_none_rtt_candidate_not_excluded` -- Success Criteria 4:
   - arriving(rtt=100) + waiting=[candidate(rtt=None)], group_size=2, threshold=200
   - candidate has no RTT data => NOT excluded => match returned

9. `test_both_rtt_none_not_excluded` -- Success Criteria 4:
   - arriving(rtt=None) + waiting=[candidate(rtt=None)], group_size=2, threshold=200
   - Both have no RTT data => NOT excluded => match returned

10. `test_match_returns_group_size_candidates` -- structural correctness:
    - arriving(rtt=30) + waiting=[cand_a(rtt=40), cand_b(rtt=50)], group_size=2, threshold=200
    - Result has exactly 2 candidates (group_size), not 3

11. `test_fifo_order_preserved` -- FIFO semantics within filtered candidates:
    - arriving(rtt=50) + waiting=[cand_a(rtt=60), cand_b(rtt=70), cand_c(rtt=40)], group_size=2, threshold=200
    - All pass filter, FIFO picks cand_a (first in waiting list)
    - Result = [cand_a, arriving]

12. `test_threshold_boundary_exact_match` -- edge case:
    - arriving(rtt=100) + waiting=[candidate(rtt=100)], group_size=2, threshold=200
    - 100+100=200 <= 200 (exactly at boundary) => match returned

13. `test_group_size_three` -- supports larger groups:
    - arriving(rtt=30) + waiting=[cand_a(rtt=40), cand_b(rtt=50)], group_size=3, threshold=200
    - All pass filter, all three matched

Import pattern:
```python
from interactive_gym.server.matchmaker import LatencyFIFOMatchmaker, MatchCandidate
```

Do NOT use mocks or monkeypatch -- these are pure data-in, data-out tests.
  </action>
  <verify>
Run: `python -m pytest tests/unit/test_latency_fifo_matchmaker.py -v` -- all 13 tests pass.
  </verify>
  <done>
13 unit tests covering all 4 success criteria pass: instantiation, RTT filtering, no-match-returns-None, None-RTT graceful fallback.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from interactive_gym.server.matchmaker import LatencyFIFOMatchmaker; print('import OK')"` -- class is importable
2. `python -m pytest tests/unit/test_latency_fifo_matchmaker.py -v` -- all 13 tests pass
3. `python -c "from interactive_gym.server.matchmaker import FIFOMatchmaker, GroupReunionMatchmaker, MatchCandidate; print('backward compat OK')"` -- existing classes still importable (no regressions)
</verification>

<success_criteria>
- LatencyFIFOMatchmaker(max_server_rtt_ms=200) instantiates with configurable threshold
- find_match() skips candidates where sum of server RTTs > max_server_rtt_ms
- find_match() returns None when no candidate passes RTT filter
- find_match() does NOT exclude candidates with rtt_ms=None (graceful fallback)
- 13 unit tests pass covering all four success criteria
- Existing matchmaker classes (FIFOMatchmaker, GroupReunionMatchmaker) unmodified and importable
</success_criteria>

<output>
After completion, create `.planning/phases/81-latency-fifo-matchmaker-core/81-01-SUMMARY.md`
</output>
