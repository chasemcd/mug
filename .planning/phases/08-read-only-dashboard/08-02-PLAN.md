---
phase: 08-read-only-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - interactive_gym/server/admin/templates/dashboard.html
  - interactive_gym/server/admin/static/admin.js
  - interactive_gym/server/admin/static/admin.css
autonomous: true

must_haves:
  truths:
    - "Admin can see a table of all participants with subject ID, current scene, and progress"
    - "Admin can see connection status (green/yellow/red) for each participant"
    - "Admin can see how many participants are in each waiting room and how long they've waited"
    - "Admin can see a chronological timeline of experiment events"
  artifacts:
    - path: "interactive_gym/server/admin/templates/dashboard.html"
      provides: "Dashboard UI with participant table, waiting room view, timeline"
      min_lines: 150
      contains: "participants-table"
    - path: "interactive_gym/server/admin/static/admin.js"
      provides: "Real-time SocketIO handlers for dashboard updates"
      min_lines: 100
      contains: "state_update"
    - path: "interactive_gym/server/admin/static/admin.css"
      provides: "Custom styles for status badges"
      contains: ".status-"
  key_links:
    - from: "interactive_gym/server/admin/templates/dashboard.html"
      to: "/admin namespace"
      via: "SocketIO connection"
      pattern: "io\\('/admin'"
    - from: "interactive_gym/server/admin/static/admin.js"
      to: "state_update event"
      via: "adminSocket.on"
      pattern: "on\\('state_update'"
    - from: "interactive_gym/server/admin/static/admin.js"
      to: "participants table DOM"
      via: "updateParticipantsTable"
      pattern: "getElementById.*participants"
---

<objective>
Create the frontend dashboard UI for real-time experiment monitoring.

Purpose: Display participant state, connection status, waiting room population, and activity timeline in a responsive admin dashboard that updates in real-time via SocketIO.

Output: Fully functional dashboard with participant table, status badges, waiting room cards, and scrolling activity timeline.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/v1.1/STACK.md
@.planning/phases/07-admin-foundation/07-01-SUMMARY.md
@interactive_gym/server/admin/templates/dashboard.html
@interactive_gym/server/admin/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin.js for real-time updates</name>
  <files>interactive_gym/server/admin/static/admin.js</files>
  <action>
Create `interactive_gym/server/admin/static/admin.js` with SocketIO handlers and DOM update functions.

```javascript
/**
 * Admin Dashboard JavaScript
 * Handles SocketIO connection and real-time state updates
 */

// Connect to admin SocketIO namespace
const adminSocket = io('/admin', {
    transports: ['websocket', 'polling']
});

// State tracking
let currentState = {
    participants: [],
    waiting_rooms: [],
    activity_log: [],
    summary: {}
};

// ============================================
// Connection status handlers
// ============================================

adminSocket.on('connect', () => {
    console.log('Admin connected to /admin namespace');
    updateConnectionBadge('connected');
    // Request initial state
    adminSocket.emit('request_state');
});

adminSocket.on('disconnect', () => {
    console.log('Admin disconnected');
    updateConnectionBadge('disconnected');
});

adminSocket.on('connect_error', (error) => {
    console.error('Connection error:', error);
    updateConnectionBadge('error');
});

function updateConnectionBadge(status) {
    const badge = document.getElementById('connection-status');
    if (!badge) return;

    badge.classList.remove('badge-success', 'badge-warning', 'badge-error');

    switch(status) {
        case 'connected':
            badge.textContent = 'Connected';
            badge.classList.add('badge-success');
            break;
        case 'disconnected':
            badge.textContent = 'Disconnected';
            badge.classList.add('badge-error');
            break;
        case 'error':
            badge.textContent = 'Error';
            badge.classList.add('badge-error');
            break;
    }
}

// ============================================
// State update handlers
// ============================================

adminSocket.on('state_update', (data) => {
    console.log('State update received:', data);
    currentState = data;
    updateDashboard(data);
});

adminSocket.on('activity_event', (event) => {
    console.log('Activity event:', event);
    addActivityEvent(event);
});

function updateDashboard(state) {
    updateSummaryStats(state.summary);
    updateParticipantsTable(state.participants);
    updateWaitingRooms(state.waiting_rooms);
    updateActivityTimeline(state.activity_log);
}

// ============================================
// Summary stats
// ============================================

function updateSummaryStats(summary) {
    const elParticipants = document.getElementById('stat-participants');
    const elGames = document.getElementById('stat-games');
    const elWaiting = document.getElementById('stat-waiting');

    if (elParticipants) {
        elParticipants.textContent = summary.total_participants || 0;
    }
    if (elGames) {
        elGames.textContent = summary.active_games || 0;
    }
    if (elWaiting) {
        elWaiting.textContent = summary.waiting_count || 0;
    }
}

// ============================================
// Participants table
// ============================================

function updateParticipantsTable(participants) {
    const tbody = document.getElementById('participants-tbody');
    if (!tbody) return;

    if (!participants || participants.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-base-content/50">
                    No participants connected
                </td>
            </tr>
        `;
        return;
    }

    // Sort by created_at (newest first)
    const sorted = [...participants].sort((a, b) =>
        (b.created_at || 0) - (a.created_at || 0)
    );

    tbody.innerHTML = sorted.map(p => `
        <tr class="hover">
            <td class="font-mono text-sm">${escapeHtml(truncateId(p.subject_id))}</td>
            <td>${getStatusBadge(p.connection_status)}</td>
            <td>${escapeHtml(p.current_scene_id || '-')}</td>
            <td>${getProgressBadge(p.scene_progress)}</td>
            <td class="text-xs text-base-content/60">
                ${formatTimestamp(p.last_updated_at)}
            </td>
        </tr>
    `).join('');
}

function getStatusBadge(status) {
    const badges = {
        'connected': '<span class="badge badge-success badge-sm">Connected</span>',
        'reconnecting': '<span class="badge badge-warning badge-sm">Reconnecting</span>',
        'disconnected': '<span class="badge badge-error badge-sm">Disconnected</span>',
        'completed': '<span class="badge badge-ghost badge-sm">Completed</span>'
    };
    return badges[status] || '<span class="badge badge-ghost badge-sm">Unknown</span>';
}

function getProgressBadge(progress) {
    if (!progress) return '-';
    const pct = Math.round((progress.current_index / progress.total_scenes) * 100);
    return `<progress class="progress progress-primary w-16" value="${progress.current_index}" max="${progress.total_scenes}"></progress>
            <span class="text-xs ml-2">${progress.current_index}/${progress.total_scenes}</span>`;
}

// ============================================
// Waiting rooms
// ============================================

function updateWaitingRooms(waitingRooms) {
    const container = document.getElementById('waiting-rooms-container');
    if (!container) return;

    if (!waitingRooms || waitingRooms.length === 0) {
        container.innerHTML = `
            <div class="text-center text-base-content/50 py-4">
                No active waiting rooms
            </div>
        `;
        return;
    }

    container.innerHTML = waitingRooms.map(room => `
        <div class="card bg-base-100 shadow-sm border border-base-300 mb-2">
            <div class="card-body p-3">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-sm">${escapeHtml(room.scene_id)}</span>
                    <span class="badge badge-outline badge-sm">
                        ${room.waiting_count}/${room.target_size} waiting
                    </span>
                </div>
                ${room.groups && room.groups.length > 0 ? `
                    <div class="mt-2 text-xs text-base-content/60">
                        ${room.groups.map(g => `
                            <div class="flex justify-between">
                                <span>Group ${truncateId(g.group_id)}</span>
                                <span>${g.waiting_count} waiting, ${formatDuration(g.wait_duration_ms)}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${room.avg_wait_duration_ms > 0 ? `
                    <div class="text-xs text-base-content/60 mt-1">
                        Avg wait: ${formatDuration(room.avg_wait_duration_ms)}
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// ============================================
// Activity timeline
// ============================================

function updateActivityTimeline(events) {
    const container = document.getElementById('activity-timeline');
    if (!container) return;

    if (!events || events.length === 0) {
        container.innerHTML = `
            <div class="text-center text-base-content/50 py-4">
                No activity yet
            </div>
        `;
        return;
    }

    // Show most recent first (reverse chronological)
    const sorted = [...events].sort((a, b) => b.timestamp - a.timestamp);

    container.innerHTML = sorted.slice(0, 50).map(event => `
        <div class="flex items-start gap-2 py-1 border-b border-base-200 last:border-0">
            <span class="text-xs text-base-content/50 min-w-[60px]">
                ${formatTime(event.timestamp)}
            </span>
            ${getEventIcon(event.event_type)}
            <span class="text-sm flex-1">
                <span class="font-mono text-xs">${escapeHtml(truncateId(event.subject_id))}</span>
                ${getEventDescription(event)}
            </span>
        </div>
    `).join('');
}

function addActivityEvent(event) {
    // Add to current state (for persistence across reconnects)
    if (!currentState.activity_log) {
        currentState.activity_log = [];
    }
    currentState.activity_log.unshift(event);

    // Keep only last 100
    if (currentState.activity_log.length > 100) {
        currentState.activity_log = currentState.activity_log.slice(0, 100);
    }

    // Re-render timeline
    updateActivityTimeline(currentState.activity_log);
}

function getEventIcon(eventType) {
    const icons = {
        'join': '<span class="text-success">+</span>',
        'disconnect': '<span class="text-error">-</span>',
        'scene_advance': '<span class="text-info">></span>',
        'game_start': '<span class="text-primary">*</span>',
        'game_end': '<span class="text-warning">*</span>'
    };
    return `<span class="w-4 text-center">${icons[eventType] || '.'}</span>`;
}

function getEventDescription(event) {
    const descriptions = {
        'join': 'joined',
        'disconnect': 'disconnected',
        'scene_advance': `advanced to <span class="font-mono text-xs">${escapeHtml(event.details?.scene_id || '?')}</span>`,
        'game_start': 'started game',
        'game_end': 'ended game'
    };
    return descriptions[event.event_type] || event.event_type;
}

// ============================================
// Utility functions
// ============================================

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function truncateId(id) {
    if (!id) return '-';
    if (id.length <= 12) return id;
    return id.substring(0, 8) + '...';
}

function formatTimestamp(ts) {
    if (!ts) return '-';
    const date = new Date(ts * 1000);
    return date.toLocaleTimeString();
}

function formatTime(ts) {
    if (!ts) return '-';
    const date = new Date(ts * 1000);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function formatDuration(ms) {
    if (!ms || ms < 0) return '0s';
    const seconds = Math.floor(ms / 1000);
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}m ${remainingSeconds}s`;
}

// Request fresh state periodically (fallback if push fails)
setInterval(() => {
    if (adminSocket.connected) {
        adminSocket.emit('request_state');
    }
}, 5000);
```
  </action>
  <verify>
File exists with:
- SocketIO connection to /admin namespace
- state_update handler that calls updateDashboard
- updateParticipantsTable function
- updateWaitingRooms function
- updateActivityTimeline function
- getStatusBadge function returning badge HTML for 4 states
  </verify>
  <done>
admin.js created with all real-time update handlers and DOM manipulation functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin.css for custom styles</name>
  <files>interactive_gym/server/admin/static/admin.css</files>
  <action>
Create `interactive_gym/server/admin/static/admin.css` with custom styles:

```css
/**
 * Admin Dashboard Custom Styles
 * Extends DaisyUI with dashboard-specific styles
 */

/* Activity timeline scrolling */
#activity-timeline {
    max-height: 300px;
    overflow-y: auto;
}

/* Participants table responsive */
#participants-table {
    font-size: 0.875rem;
}

#participants-table th,
#participants-table td {
    padding: 0.5rem 0.75rem;
}

/* Subject ID column - monospace and truncated */
.subject-id {
    font-family: ui-monospace, monospace;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Status badge colors (semantic aliases for DaisyUI) */
.status-connected { @apply badge-success; }
.status-reconnecting { @apply badge-warning; }
.status-disconnected { @apply badge-error; }
.status-completed { @apply badge-ghost; }

/* Waiting room cards */
.waiting-room-card {
    transition: box-shadow 0.2s ease;
}

.waiting-room-card:hover {
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

/* Timeline event icons */
.event-join { color: oklch(var(--su)); }
.event-disconnect { color: oklch(var(--er)); }
.event-advance { color: oklch(var(--in)); }
.event-game { color: oklch(var(--p)); }

/* Auto-refresh indicator */
@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.live-indicator::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: oklch(var(--su));
    margin-right: 0.5rem;
    animation: pulse-dot 2s infinite;
}

/* Progress bar in table */
.progress {
    height: 0.5rem;
}

/* Compact cards for waiting rooms */
.card-body.compact {
    padding: 0.75rem;
}

/* Empty state styling */
.empty-state {
    color: oklch(var(--bc) / 0.5);
    text-align: center;
    padding: 2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #participants-table {
        font-size: 0.75rem;
    }

    #participants-table th,
    #participants-table td {
        padding: 0.25rem 0.5rem;
    }

    .subject-id {
        max-width: 80px;
    }
}
```
  </action>
  <verify>
File exists with:
- #activity-timeline styles with max-height and overflow
- .status-* classes
- Responsive adjustments
  </verify>
  <done>
admin.css created with custom dashboard styles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard.html with complete UI</name>
  <files>interactive_gym/server/admin/templates/dashboard.html</files>
  <action>
Replace `interactive_gym/server/admin/templates/dashboard.html` with complete dashboard UI:

```html
{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('admin.static', filename='admin.css') }}">
{% endblock %}

{% block body %}
<div class="navbar bg-base-100 shadow-lg">
    <div class="flex-1">
        <span class="text-xl font-bold px-4">Interactive Gym Admin</span>
    </div>
    <div class="flex-none">
        <div class="badge badge-success badge-outline mr-4 live-indicator" id="connection-status">
            Connecting...
        </div>
        <a href="{{ url_for('admin.logout') }}" class="btn btn-ghost btn-sm">
            Logout
        </a>
    </div>
</div>

<div class="container mx-auto p-6">
    <!-- Stats overview -->
    <div class="stats shadow w-full mb-6 bg-base-100">
        <div class="stat">
            <div class="stat-title">Active Participants</div>
            <div class="stat-value" id="stat-participants">-</div>
            <div class="stat-desc">Currently connected</div>
        </div>
        <div class="stat">
            <div class="stat-title">Active Games</div>
            <div class="stat-value" id="stat-games">-</div>
            <div class="stat-desc">In progress</div>
        </div>
        <div class="stat">
            <div class="stat-title">Waiting Room</div>
            <div class="stat-value" id="stat-waiting">-</div>
            <div class="stat-desc">Participants waiting</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Participants Table (2/3 width on large screens) -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">Participants</h2>

                    <div class="overflow-x-auto">
                        <table class="table table-zebra" id="participants-table">
                            <thead>
                                <tr>
                                    <th>Subject ID</th>
                                    <th>Status</th>
                                    <th>Current Scene</th>
                                    <th>Progress</th>
                                    <th>Last Update</th>
                                </tr>
                            </thead>
                            <tbody id="participants-tbody">
                                <tr>
                                    <td colspan="5" class="text-center text-base-content/50">
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar (1/3 width on large screens) -->
        <div class="space-y-6">
            <!-- Waiting Rooms -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-base">Waiting Rooms</h2>
                    <div id="waiting-rooms-container">
                        <div class="text-center text-base-content/50 py-4">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-base">Activity Timeline</h2>
                    <div id="activity-timeline">
                        <div class="text-center text-base-content/50 py-4">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('admin.static', filename='admin.js') }}"></script>
{% endblock %}
```

Key changes from Phase 7 placeholder:
1. Added `<link>` for admin.css in head block
2. Added `live-indicator` class to connection badge
3. Changed table to have 5 columns (added Progress, Last Update)
4. Added grid layout with participants table (2/3) and sidebar (1/3)
5. Added waiting rooms container in sidebar
6. Added activity timeline container in sidebar
7. Moved SocketIO script to external admin.js file
  </action>
  <verify>
1. File includes `url_for('admin.static', filename='admin.css')` link
2. File includes `url_for('admin.static', filename='admin.js')` script
3. Has `participants-tbody` id for table body
4. Has `waiting-rooms-container` id for waiting rooms
5. Has `activity-timeline` id for timeline
6. Has 5 column table headers: Subject ID, Status, Current Scene, Progress, Last Update
  </verify>
  <done>
dashboard.html updated with complete UI layout for participants table, waiting rooms, and activity timeline.
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify visually (if server running):
1. Navigate to http://localhost:PORT/admin and login
2. Verify connection badge shows "Connected" with green styling
3. Verify participant table renders (even if empty shows "No participants")
4. Verify waiting rooms section renders
5. Verify activity timeline section renders
6. Check browser console for SocketIO connection messages
</verification>

<success_criteria>
- Dashboard loads without JavaScript errors
- SocketIO connects to /admin namespace
- Participant table displays with correct columns
- Connection status badges show correct colors (green/yellow/red/gray)
- Waiting rooms section shows room status
- Activity timeline shows chronological events
- UI updates in real-time when state_update events received
</success_criteria>

<output>
After completion, create `.planning/phases/08-read-only-dashboard/08-02-SUMMARY.md`
</output>
