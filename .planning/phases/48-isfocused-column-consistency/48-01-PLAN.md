---
phase: 48-isfocused-column-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
  - tests/e2e/test_data_comparison.py
autonomous: true

must_haves:
  truths:
    - "Both players export isFocused.0 and isFocused.1 columns regardless of focus events"
    - "isFocused values reflect actual focus state (true when focused, false when backgrounded)"
    - "Column names match between both players' exports"
  artifacts:
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "Per-player focus state in storeFrameData calls"
      contains: "getFocusStatePerPlayer()"
  key_links:
    - from: "storeFrameData() calls"
      to: "getFocusStatePerPlayer()"
      via: "isFocused parameter"
      pattern: "isFocused:\\s*this\\.getFocusStatePerPlayer\\(\\)"
---

<objective>
Fix isFocused column export consistency so both players always export isFocused.0 and isFocused.1 columns with accurate focus state values.

Purpose: Currently, when focus loss occurs, one player exports per-player columns (isFocused.0, isFocused.1) while the other exports a single isFocused column. This causes data parity failures in the comparison script. The fix ensures consistent column format for research data validity.

Output: Updated storeFrameData calls using getFocusStatePerPlayer(), passing test_focus_loss_mid_episode_parity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-isfocused-column-consistency/48-RESEARCH.md

Key files to modify:
@interactive_gym/server/static/js/pyodide_multiplayer_game.js
@tests/e2e/test_data_comparison.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update storeFrameData calls to use getFocusStatePerPlayer()</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Update all storeFrameData() calls that use single-boolean isFocused to use getFocusStatePerPlayer() instead.

There are 4 call sites to update (search for `isFocused: this.focusManager`):

1. **Line ~2365** (step() - early storeFrameData for action recording):
   - Current: `isFocused: this.focusManager ? !this.focusManager.isBackgrounded : true`
   - Change to: `isFocused: this.getFocusStatePerPlayer()`

2. **Line ~2459** (step() - main storeFrameData after env.step):
   - Current: `isFocused: this.focusManager ? !this.focusManager.isBackgrounded : true`
   - Change to: `isFocused: this.getFocusStatePerPlayer()`

3. **Line ~4719** (_performRollbackCorrection - replay storeFrameData):
   - Current: `isFocused: this.focusManager ? !this.focusManager.isBackgrounded : true`
   - Change to: `isFocused: this.getFocusStatePerPlayer()`

4. **Line ~4858** (_performRollbackCorrection - final results storeFrameData):
   - Current: `isFocused: this.focusManager ? !this.focusManager.isBackgrounded : true`
   - Change to: `isFocused: this.getFocusStatePerPlayer()`

**DO NOT modify line ~5075** (_performFastForward) - it already correctly uses per-player format via `focusStateForFF` with the correct semantics (local=false since backgrounded, partner=true since they sent inputs).

Why this works:
- getFocusStatePerPlayer() already exists (line 7539) and returns `{playerId: boolean}` format
- exportEpisodeDataFromBuffer() addAgentData() automatically expands objects to per-agent columns
- This matches the pattern already used in phaser_gym_graphics.js
  </action>
  <verify>
Verify changes with grep:
```bash
grep -n "isFocused:.*focusManager" interactive_gym/server/static/js/pyodide_multiplayer_game.js
# Should return 0 results (all replaced)

grep -n "isFocused:.*getFocusStatePerPlayer" interactive_gym/server/static/js/pyodide_multiplayer_game.js
# Should return 4 results (the 4 updated call sites)
```
  </verify>
  <done>
All 4 storeFrameData calls use getFocusStatePerPlayer() instead of single boolean. No grep matches for the old pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update xfail test and verify fix</name>
  <files>tests/e2e/test_data_comparison.py</files>
  <action>
Update the xfail marker on test_focus_loss_mid_episode_parity to be conditional, allowing us to verify the fix works.

1. **Locate test_focus_loss_mid_episode_parity** (~line 382)

2. **Update the xfail marker** to remove it (the column mismatch issue should now be fixed):
   - Remove: `@pytest.mark.xfail(reason="Known issue: isFocused columns only present when focus loss occurs, causing column mismatch")`
   - The test should now pass since both players will export isFocused.0 and isFocused.1

3. **Keep test_focus_loss_episode_boundary_parity xfail** - this test has a DIFFERENT issue (row count mismatch at episode boundaries), which is Phase 49's concern. Update its reason to clarify:
   - Current: `reason="Known issue: dual-buffer edge cases at episode boundary during focus loss cause row count and column mismatches"`
   - Update to: `reason="Known issue: row count mismatch at episode boundary when player backgrounded - Phase 49 fix"`
   - This clarifies that the column issue is fixed but row count issue remains

4. **Run the fixed test** to validate:
```bash
cd /Users/chasemcd/Repositories/interactive-gym
pytest tests/e2e/test_data_comparison.py::test_focus_loss_mid_episode_parity -v --headed --timeout=300
```

Note: This test requires headed mode (WebRTC needs headed browser). The test will:
- Run two players through matchmaking
- Trigger focus loss on player 1 mid-episode
- Verify data parity after fast-forward

If the test passes, the column consistency fix is verified.
  </action>
  <verify>
```bash
# Check xfail markers are updated correctly
grep -A1 "def test_focus_loss_mid_episode_parity" tests/e2e/test_data_comparison.py
# Should NOT have xfail marker

grep -B2 "def test_focus_loss_episode_boundary_parity" tests/e2e/test_data_comparison.py
# Should have xfail with updated reason mentioning "Phase 49"
```
  </verify>
  <done>
test_focus_loss_mid_episode_parity has xfail marker removed. test_focus_loss_episode_boundary_parity keeps xfail with updated reason clarifying row count issue is Phase 49.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run verification test and confirm parity</name>
  <files></files>
  <action>
Run the test to verify the fix works end-to-end.

```bash
cd /Users/chasemcd/Repositories/interactive-gym
pytest tests/e2e/test_data_comparison.py::test_focus_loss_mid_episode_parity -v --headed --timeout=300
```

Expected outcome:
- Test completes without timeout
- Comparison script reports identical columns
- Test passes (exit code 0)

If test fails:
1. Check comparison output for column mismatch details
2. Verify all 4 storeFrameData calls were updated
3. Check if there are additional call sites missed

Additionally, run the basic parity test to ensure no regression:
```bash
pytest tests/e2e/test_data_comparison.py::test_export_parity_basic -v --headed --timeout=300
```

This validates that the change doesn't break normal (no focus loss) scenarios.
  </action>
  <verify>
Test output shows:
- `test_focus_loss_mid_episode_parity PASSED`
- `test_export_parity_basic PASSED`
- Comparison output shows matching columns including isFocused.0 and isFocused.1
  </verify>
  <done>
test_focus_loss_mid_episode_parity passes without xfail marker. test_export_parity_basic passes (no regression). Both players export identical isFocused.0 and isFocused.1 columns.
  </done>
</task>

</tasks>

<verification>
Phase 48 is complete when:

1. **Code changes verified:**
   ```bash
   grep -c "isFocused:.*focusManager" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   # Returns: 0

   grep -c "isFocused:.*getFocusStatePerPlayer" interactive_gym/server/static/js/pyodide_multiplayer_game.js
   # Returns: 4
   ```

2. **Tests pass:**
   ```bash
   pytest tests/e2e/test_data_comparison.py::test_focus_loss_mid_episode_parity -v --headed
   pytest tests/e2e/test_data_comparison.py::test_export_parity_basic -v --headed
   # Both PASSED
   ```

3. **Requirements satisfied:**
   - FOCUS-COL-01: Both players export isFocused.0 and isFocused.1 columns regardless of focus events
   - FOCUS-COL-02: isFocused columns contain accurate values (true when focused, false when backgrounded)
</verification>

<success_criteria>
- [ ] All 4 storeFrameData calls updated to use getFocusStatePerPlayer()
- [ ] test_focus_loss_mid_episode_parity passes without xfail marker
- [ ] test_export_parity_basic passes (no regression)
- [ ] Both players export isFocused.0 and isFocused.1 columns in all scenarios
- [ ] Column values reflect actual focus state
</success_criteria>

<output>
After completion, create `.planning/phases/48-isfocused-column-consistency/48-01-SUMMARY.md`
</output>
