---
phase: 61-input-confirmation-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/scenes/gym_scene.py
  - interactive_gym/server/static/js/pyodide_multiplayer_game.js
autonomous: true

must_haves:
  truths:
    - "Episode export does not begin until partner inputs are confirmed for final frame (or timeout)"
    - "Confirmation timeout is configurable via GymScene.input_confirmation_timeout_ms"
    - "Timeout triggers graceful handling (warning log, proceed with export) not crash or data loss"
  artifacts:
    - path: "interactive_gym/scenes/gym_scene.py"
      provides: "input_confirmation_timeout_ms attribute and pyodide() parameter"
      contains: "input_confirmation_timeout_ms"
    - path: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      provides: "_waitForInputConfirmation() method, async _checkEpisodeSyncAndReset()"
      contains: "_waitForInputConfirmation"
  key_links:
    - from: "interactive_gym/scenes/gym_scene.py"
      to: "get_complete_scene_metadata()"
      via: "attribute included in metadata dict"
      pattern: "input_confirmation_timeout_ms"
    - from: "interactive_gym/server/static/js/pyodide_multiplayer_game.js"
      to: "scene_metadata.input_confirmation_timeout_ms"
      via: "read in pyodide_game_ready handler"
      pattern: "scene_metadata.*input_confirmation_timeout_ms"
    - from: "_checkEpisodeSyncAndReset()"
      to: "_waitForInputConfirmation()"
      via: "await call before signalEpisodeComplete()"
      pattern: "await.*_waitForInputConfirmation"
---

<objective>
Implement input confirmation protocol to wait for partner inputs before episode export.

Purpose: Fix data parity bug where `_promoteRemainingAtBoundary()` force-promotes speculative (predicted) frame data at episode end. Under packet loss with active inputs, this causes both players to export different actions for the same frame because they each used their own predictions for the partner's action.

Output: Modified episode end flow that waits for input confirmation (or timeout) before calling `signalEpisodeComplete()`, ensuring both players export identical data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-input-confirmation-protocol/61-RESEARCH.md

Key research findings:
- Root cause: `_promoteRemainingAtBoundary()` at line 3002 force-promotes speculative data
- Fix location: `_checkEpisodeSyncAndReset()` at line 7257 - add wait before `signalEpisodeComplete()`
- Existing infrastructure: `confirmedFrame`, `_hasAllInputsForFrame()`, `_updateConfirmedFrame()`, `inputBuffer`
- Config pattern: scene_metadata flows from GymScene to JS via `get_complete_scene_metadata()`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confirmation timeout config to GymScene</name>
  <files>interactive_gym/scenes/gym_scene.py</files>
  <action>
Add `input_confirmation_timeout_ms` attribute to GymScene:

1. In `__init__()`, add attribute after existing multiplayer settings (around line 157, near input_delay):
   ```python
   # Input confirmation timeout for episode boundaries (Phase 61: PARITY-01, PARITY-02)
   # Waits for partner input confirmation before episode export
   # Default 500ms handles 200ms+ RTT with margin for packet retransmission
   self.input_confirmation_timeout_ms: int = 500
   ```

2. In `pyodide()` method (around line 590), add parameter:
   - Add `input_confirmation_timeout_ms: int = NotProvided` to method signature
   - Add handling block after `input_delay` handling (around line 697):
   ```python
   if input_confirmation_timeout_ms is not NotProvided:
       if not isinstance(input_confirmation_timeout_ms, int) or input_confirmation_timeout_ms < 0:
           raise ValueError("input_confirmation_timeout_ms must be a non-negative integer")
       self.input_confirmation_timeout_ms = input_confirmation_timeout_ms
   ```

3. Add docstring entry for the parameter in `pyodide()` method docstring:
   ```
   :param input_confirmation_timeout_ms: Time in milliseconds to wait for partner input confirmation
       at episode boundaries before proceeding with export. Default is 500ms which handles 200ms+ RTT.
       Set to 0 to disable waiting (not recommended). defaults to NotProvided
   :type input_confirmation_timeout_ms: int, optional
   ```

Note: The attribute will automatically be included in `get_complete_scene_metadata()` since it's a simple int type and the method iterates over `self.__dict__`.
  </action>
  <verify>
Run Python syntax check:
```bash
python -c "from interactive_gym.scenes.gym_scene import GymScene; s = GymScene(); print(s.input_confirmation_timeout_ms)"
```
Should print `500`.

Test configuration:
```bash
python -c "from interactive_gym.scenes.gym_scene import GymScene; s = GymScene().pyodide(input_confirmation_timeout_ms=1000); print(s.input_confirmation_timeout_ms)"
```
Should print `1000`.
  </verify>
  <done>GymScene has input_confirmation_timeout_ms attribute with 500ms default, configurable via pyodide() method</done>
</task>

<task type="auto">
  <name>Task 2: Implement input confirmation wait in JavaScript</name>
  <files>interactive_gym/server/static/js/pyodide_multiplayer_game.js</files>
  <action>
Implement the input confirmation protocol with these changes:

1. **Initialize config from scene_metadata** (around line 1309, after focus_loss_message handling):
   ```javascript
   // Configure input confirmation timeout from scene config (Phase 61: PARITY-01, PARITY-02)
   // Waits for partner input confirmation at episode boundaries before export
   if (data.scene_metadata?.input_confirmation_timeout_ms !== undefined) {
       this.inputConfirmationTimeoutMs = data.scene_metadata.input_confirmation_timeout_ms;
       p2pLog.info(`Input confirmation timeout: ${this.inputConfirmationTimeoutMs}ms`);
   } else {
       this.inputConfirmationTimeoutMs = 500;  // Default 500ms
   }
   ```

2. **Add `_waitForInputConfirmation()` method** (add after `_promoteConfirmedFrames()` around line 2990, before `_promoteRemainingAtBoundary()`):
   ```javascript
   /**
    * Wait for input confirmation before episode export (Phase 61: PARITY-01).
    * Called at episode end to ensure all partner inputs are confirmed before exporting.
    * This prevents data divergence under packet loss - both players wait for confirmation
    * or timeout before promoting speculative data.
    *
    * @param {number} timeoutMs - Maximum time to wait for confirmation
    * @returns {Promise<boolean>} True if all inputs confirmed, false if timeout
    */
   async _waitForInputConfirmation(timeoutMs) {
       // Skip if not P2P mode or no timeout configured
       if (this.serverAuthoritative || timeoutMs <= 0) {
           return true;
       }

       const targetFrame = (this.p2pEpisodeSync.syncedTerminationFrame ?? this.frameNumber) - 1;
       const humanPlayerIds = this._getHumanPlayerIds();

       if (humanPlayerIds.length === 0) {
           return true;  // No human players to wait for
       }

       // Check if already confirmed
       if (this._hasAllInputsForFrame(targetFrame, humanPlayerIds)) {
           await this._updateConfirmedFrame();
           p2pLog.debug(`[Input Confirmation] Already confirmed up to frame ${targetFrame}`);
           return true;
       }

       p2pLog.info(`[Input Confirmation] Waiting for inputs on frame ${targetFrame} ` +
           `(confirmedFrame=${this.confirmedFrame}, timeout=${timeoutMs}ms)`);

       const startTime = performance.now();

       while (performance.now() - startTime < timeoutMs) {
           // Process any pending inputs that may have arrived
           this._processQueuedInputs();

           // Check if target frame is now confirmed
           if (this._hasAllInputsForFrame(targetFrame, humanPlayerIds)) {
               await this._updateConfirmedFrame();
               const elapsed = Math.round(performance.now() - startTime);
               p2pLog.info(`[Input Confirmation] Confirmed after ${elapsed}ms`);
               return true;
           }

           // Small delay to allow event loop to process incoming packets
           await new Promise(resolve => setTimeout(resolve, 10));
       }

       // Timeout - log warning but proceed
       console.warn(`[Input Confirmation] Timeout after ${timeoutMs}ms. ` +
           `confirmedFrame=${this.confirmedFrame}, target=${targetFrame}. ` +
           `Proceeding with episode export (data may diverge).`);
       return false;
   }
   ```

3. **Make `_checkEpisodeSyncAndReset()` async and add wait** (around line 7257):
   Change the method signature and add the wait call:
   ```javascript
   async _checkEpisodeSyncAndReset() {
       /**
        * Check if both peers have detected episode end and trigger synchronized reset.
        * This is called:
        * 1. When we detect episode end locally (after broadcasting)
        * 2. When we receive episode end from peer
        *
        * Phase 61 (PARITY-01): Waits for input confirmation before signaling episode complete.
        */
       const sync = this.p2pEpisodeSync;

       // Both peers must agree before we can reset
       if (!sync.localEpisodeEndDetected || !sync.remoteEpisodeEndReceived) {
           return;  // Still waiting for sync
       }

       // Both peers agree - frames may differ slightly due to network timing, that's OK
       const frameDiff = Math.abs((sync.localEpisodeEndFrame || 0) - (sync.remoteEpisodeEndFrame || 0));
       if (frameDiff > 5) {
           p2pLog.warn(`Large frame difference at episode end: ${frameDiff} frames`);
       }

       // Phase 61 (PARITY-01): Wait for input confirmation before completing episode
       // This ensures both players have confirmed inputs before promoting speculative data
       const confirmed = await this._waitForInputConfirmation(this.inputConfirmationTimeoutMs);
       if (!confirmed) {
           // Timeout occurred - _waitForInputConfirmation already logged warning
           // Proceed with export anyway (graceful degradation, same as current behavior)
       }

       // Clear sync state for next episode
       this._clearEpisodeSyncState();

       // Now safe to signal episode complete (which triggers shouldReset)
       this.episodeComplete = true;
       this.signalEpisodeComplete();
   }
   ```

4. **Update `_handleEpisodeEnd()` to handle async** (around line 7213):
   The call to `_checkEpisodeSyncAndReset()` doesn't need to be awaited since the method
   handles its own completion. But for consistency, add the async handling:
   ```javascript
   // Check if we can now trigger the synchronized reset
   // Note: _checkEpisodeSyncAndReset is async but we don't await - it completes on its own
   this._checkEpisodeSyncAndReset();
   ```
   (This line already exists and works because the promise resolves independently)

5. **Update `_broadcastEpisodeEnd()` timeout callback** (around line 7244):
   The timeout callback calls `signalEpisodeComplete()` directly. This is intentional -
   if peer message is lost and we timeout, we proceed without waiting for confirmation.
   No change needed here since timeout already bypasses sync.
  </action>
  <verify>
Run JavaScript syntax check:
```bash
cd /Users/chasemcd/Repositories/interactive-gym && node --check interactive_gym/server/static/js/pyodide_multiplayer_game.js
```
Should complete without errors.

Search for the new method:
```bash
grep -n "_waitForInputConfirmation" interactive_gym/server/static/js/pyodide_multiplayer_game.js
```
Should show the method definition and call site.

Search for async on _checkEpisodeSyncAndReset:
```bash
grep -n "async _checkEpisodeSyncAndReset" interactive_gym/server/static/js/pyodide_multiplayer_game.js
```
Should show one match.
  </verify>
  <done>
JavaScript implementation complete:
- inputConfirmationTimeoutMs initialized from scene_metadata (default 500ms)
- _waitForInputConfirmation() polls for input confirmation with timeout
- _checkEpisodeSyncAndReset() is async and waits before signalEpisodeComplete()
- Timeout triggers graceful degradation (warning log, proceed with export)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and test</name>
  <files>None (verification only)</files>
  <action>
Verify the complete flow works by:

1. **Run existing E2E tests** to ensure no regressions:
   ```bash
   cd /Users/chasemcd/Repositories/interactive-gym
   python -m pytest tests/e2e/test_data_parity.py -v --headed -k "test_active_input_with_latency" --timeout=120
   ```
   This test should still pass (may still xfail due to existing parity issues that Phase 62 will address).

2. **Run a quick syntax/import check** on the Python module:
   ```bash
   python -c "
   from interactive_gym.scenes.gym_scene import GymScene
   s = GymScene()

   # Verify default
   assert s.input_confirmation_timeout_ms == 500, f'Expected 500, got {s.input_confirmation_timeout_ms}'

   # Verify configuration
   s.pyodide(input_confirmation_timeout_ms=1000)
   assert s.input_confirmation_timeout_ms == 1000, f'Expected 1000, got {s.input_confirmation_timeout_ms}'

   # Verify it's in metadata
   metadata = s.get_complete_scene_metadata()
   assert 'input_confirmation_timeout_ms' in metadata, 'Missing from metadata'
   assert metadata['input_confirmation_timeout_ms'] == 1000, f'Metadata wrong: {metadata[\"input_confirmation_timeout_ms\"]}'

   print('All Python checks passed!')
   "
   ```

3. **Verify JavaScript loads without error**:
   ```bash
   node --check interactive_gym/server/static/js/pyodide_multiplayer_game.js
   ```

Note: Full data parity verification will be done in Phase 62. This phase establishes the confirmation waiting mechanism.
  </action>
  <verify>
All verification commands above should complete successfully.
  </verify>
  <done>
Integration verified:
- Python config flows through scene_metadata
- JavaScript reads config and implements wait logic
- Existing tests do not regress
  </done>
</task>

</tasks>

<verification>
Phase 61 verification checklist:

1. **Config exposed (PARITY-02):**
   - [ ] `GymScene.input_confirmation_timeout_ms` attribute exists with 500ms default
   - [ ] `GymScene.pyodide(input_confirmation_timeout_ms=X)` configures the value
   - [ ] Value appears in `get_complete_scene_metadata()` output

2. **Wait implemented (PARITY-01):**
   - [ ] `_waitForInputConfirmation(timeoutMs)` method exists in JS
   - [ ] Method polls `_hasAllInputsForFrame()` for target frame
   - [ ] Method calls `_updateConfirmedFrame()` on success
   - [ ] Method returns after timeout with warning log

3. **Integration (PARITY-01):**
   - [ ] `_checkEpisodeSyncAndReset()` is async
   - [ ] `_checkEpisodeSyncAndReset()` calls `_waitForInputConfirmation()` before `signalEpisodeComplete()`
   - [ ] Timeout proceeds with export (graceful degradation)

4. **No regressions:**
   - [ ] Python module imports without error
   - [ ] JavaScript syntax is valid
   - [ ] Existing E2E tests still pass (or fail in expected ways)
</verification>

<success_criteria>
- Episode export waits for partner input confirmation before `_promoteRemainingAtBoundary()` runs
- Confirmation timeout is configurable (default 500ms handles 200ms+ RTT)
- Timeout triggers graceful handling: warning log, proceed with export (no crash/data loss)
- All existing tests pass or fail in previously expected ways
</success_criteria>

<output>
After completion, create `.planning/phases/61-input-confirmation-protocol/61-01-SUMMARY.md`
</output>
