---
phase: 75-merged-loading-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/configurations/experiment_config.py
  - interactive_gym/configurations/remote_config.py
  - interactive_gym/server/app.py
  - interactive_gym/server/static/templates/index.html
autonomous: true

must_haves:
  truths:
    - "ExperimentConfig.get_pyodide_config() includes pyodide_load_timeout_s in its return dict"
    - "RemoteConfig.get_pyodide_config() includes pyodide_load_timeout_s in its return dict"
    - "Server-side LOADING_TIMEOUT_S is read from experiment config instead of hardcoded"
    - "index.html has a single #loadingScreen element instead of separate #screeningLoader and #pyodideLoader"
  artifacts:
    - path: "interactive_gym/configurations/experiment_config.py"
      provides: "pyodide_load_timeout_s attribute and inclusion in get_pyodide_config()"
      contains: "pyodide_load_timeout_s"
    - path: "interactive_gym/configurations/remote_config.py"
      provides: "pyodide_load_timeout_s attribute and inclusion in get_pyodide_config()"
      contains: "pyodide_load_timeout_s"
    - path: "interactive_gym/server/app.py"
      provides: "Dynamic LOADING_TIMEOUT_S from config"
      contains: "pyodide_load_timeout_s"
    - path: "interactive_gym/server/static/templates/index.html"
      provides: "Single unified loading screen element"
      contains: "loadingScreen"
  key_links:
    - from: "interactive_gym/configurations/experiment_config.py"
      to: "interactive_gym/server/app.py"
      via: "get_pyodide_config() dict consumed by experiment_config emission"
      pattern: "get_pyodide_config.*pyodide_load_timeout_s"
    - from: "interactive_gym/server/app.py"
      to: "client JS"
      via: "experiment_config socket event carries pyodide_config with timeout field"
      pattern: "pyodide_config.*experiment_config"
---

<objective>
Add configurable Pyodide loading timeout to server-side config and unify the HTML loading elements into a single screen.

Purpose: This creates the server-side foundation (LOAD-03) and HTML structure (LOAD-01) that Plan 02 will wire up with client-side JavaScript logic.

Output: Modified Python config classes with `pyodide_load_timeout_s`, dynamic server-side loading timeout, and a single `#loadingScreen` HTML element replacing the two separate loader divs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/75-merged-loading-screen/75-RESEARCH.md

@interactive_gym/configurations/experiment_config.py
@interactive_gym/configurations/remote_config.py
@interactive_gym/server/app.py
@interactive_gym/server/static/templates/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pyodide_load_timeout_s to config classes and server</name>
  <files>
    interactive_gym/configurations/experiment_config.py
    interactive_gym/configurations/remote_config.py
    interactive_gym/server/app.py
  </files>
  <action>
    1. In `experiment_config.py` ExperimentConfig.__init__():
       - Add `self.pyodide_load_timeout_s: int = 60` in the init (after the entry screening attributes block, before `experiment()` method)

    2. In `experiment_config.py` ExperimentConfig.get_pyodide_config():
       - Add `"pyodide_load_timeout_s": self.pyodide_load_timeout_s` to the return dict (after "packages_to_install")

    3. In `remote_config.py` RemoteConfig.__init__():
       - Add `self.pyodide_load_timeout_s: int = 60` in the pyodide section (after `self.packages_to_install`)

    4. In `remote_config.py` RemoteConfig.get_pyodide_config():
       - Add `"pyodide_load_timeout_s": self.pyodide_load_timeout_s` to the return dict (after "packages_to_install")

    5. In `app.py`:
       - The current hardcoded `LOADING_TIMEOUT_S = 60` (line 143) needs to become dynamic.
       - Change the `is_client_in_loading_grace()` function to read the timeout from CONFIG instead of the module-level constant.
       - Specifically, replace the reference to `LOADING_TIMEOUT_S` with `getattr(CONFIG, 'pyodide_load_timeout_s', 60)` inside `is_client_in_loading_grace()`.
       - Also update the warning log message to use the same dynamic value.
       - Keep the module-level `LOADING_TIMEOUT_S = 60` as a fallback default, but the actual check should prefer config.
       - This ensures the server-side grace period matches whatever timeout the researcher configures.
  </action>
  <verify>
    - `python -c "from interactive_gym.configurations.experiment_config import ExperimentConfig; c = ExperimentConfig(); assert 'pyodide_load_timeout_s' in c.get_pyodide_config(); assert c.get_pyodide_config()['pyodide_load_timeout_s'] == 60; print('ExperimentConfig OK')"` succeeds
    - `python -c "from interactive_gym.configurations.remote_config import RemoteConfig; c = RemoteConfig(); assert 'pyodide_load_timeout_s' in c.get_pyodide_config(); assert c.get_pyodide_config()['pyodide_load_timeout_s'] == 60; print('RemoteConfig OK')"` succeeds
    - `grep -n 'pyodide_load_timeout_s' interactive_gym/server/app.py` shows the dynamic timeout usage
  </verify>
  <done>
    Both ExperimentConfig and RemoteConfig include pyodide_load_timeout_s (default 60) in their get_pyodide_config() output. Server-side grace period timeout reads from config. All existing tests still pass (no behavioral change, just adding a field).
  </done>
</task>

<task type="auto">
  <name>Task 2: Unify HTML loading elements into single #loadingScreen</name>
  <files>
    interactive_gym/server/static/templates/index.html
  </files>
  <action>
    In `index.html`, find the two loading indicator divs (around lines 286-295):

    ```html
    <!-- Entry screening loading indicator -->
    <div id="screeningLoader" style="display: none;">
        <div class="screening-spinner"></div>
        <div id="screeningStatus">Loading...</div>
    </div>
    <!-- Pyodide preloading indicator (Phase 67) -->
    <div id="pyodideLoader" style="display: none;">
        <div class="screening-spinner"></div>
        <div id="pyodideStatus">Loading Python runtime...</div>
    </div>
    ```

    Replace BOTH divs with a single unified loading screen:

    ```html
    <!-- Unified loading screen (Phase 75) - gates on both screening + Pyodide -->
    <div id="loadingScreen" style="display: none;">
        <div class="screening-spinner"></div>
        <div id="loadingStatus">Preparing experiment...</div>
    </div>
    ```

    Keep the same position in the DOM (before `#hudText`). The existing `.screening-spinner` CSS class already handles the spinner styling -- no CSS changes needed.
  </action>
  <verify>
    - `grep -c 'screeningLoader' interactive_gym/server/static/templates/index.html` returns 0
    - `grep -c 'pyodideLoader' interactive_gym/server/static/templates/index.html` returns 0
    - `grep -c 'loadingScreen' interactive_gym/server/static/templates/index.html` returns 1
    - `grep -c 'loadingStatus' interactive_gym/server/static/templates/index.html` returns 1
  </verify>
  <done>
    index.html has exactly one loading element (`#loadingScreen` with `#loadingStatus`) instead of the previous two separate loaders. The `.screening-spinner` class is reused for the spinner animation.
  </done>
</task>

</tasks>

<verification>
1. Python config verification: Both config classes return pyodide_load_timeout_s in their pyodide config dicts
2. Server-side timeout: app.py reads timeout from CONFIG dynamically
3. HTML structure: Single #loadingScreen element exists, old #screeningLoader and #pyodideLoader removed
4. No regressions: Existing imports and usage patterns unbroken (the JS side is updated in Plan 02)
</verification>

<success_criteria>
- ExperimentConfig.get_pyodide_config() returns dict with pyodide_load_timeout_s key (default 60)
- RemoteConfig.get_pyodide_config() returns dict with pyodide_load_timeout_s key (default 60)
- Server-side is_client_in_loading_grace() uses config-based timeout
- index.html contains exactly one #loadingScreen div (zero #screeningLoader, zero #pyodideLoader)
</success_criteria>

<output>
After completion, create `.planning/phases/75-merged-loading-screen/75-01-SUMMARY.md`
</output>
