---
phase: 32-dashboard-summary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/admin/aggregator.py
  - interactive_gym/server/admin/templates/dashboard.html
  - interactive_gym/server/admin/static/admin.js
  - interactive_gym/server/admin/static/admin.css
autonomous: true

must_haves:
  truths:
    - "Dashboard shows completion rate as 'X of Y participants completed'"
    - "Dashboard shows average session duration in human-readable format"
    - "Summary stats appear prominently at top of admin page"
    - "Stats update in real-time as participants complete"
  artifacts:
    - path: "interactive_gym/server/admin/aggregator.py"
      provides: "Completion rate and average duration computation"
      contains: "total_started|completion_rate|avg_session_duration"
    - path: "interactive_gym/server/admin/templates/dashboard.html"
      provides: "Completion rate and duration stat cards"
      contains: "stat-completion|stat-duration"
    - path: "interactive_gym/server/admin/static/admin.js"
      provides: "Real-time update for new summary stats"
      contains: "completion_rate|avg_session_duration"
  key_links:
    - from: "aggregator.py"
      to: "admin.js"
      via: "state_update SocketIO event"
      pattern: "summary.*completion_rate|avg_session_duration"
    - from: "admin.js"
      to: "dashboard.html"
      via: "DOM element ID updates"
      pattern: "stat-completion|stat-duration"
---

<objective>
Add completion rate and average session duration metrics to the admin dashboard.

Purpose: Researchers need to see at a glance how their experiment is progressing (completion rate) and how long sessions typically take (average duration). These are the two most important "health check" metrics for an experiment.

Output: Dashboard displays "X of Y completed (Z%)" and average session duration prominently at the top.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Existing admin infrastructure
@interactive_gym/server/admin/aggregator.py
@interactive_gym/server/admin/templates/dashboard.html
@interactive_gym/server/admin/static/admin.js
@interactive_gym/server/admin/static/admin.css

# Session tracking (ParticipantSession.created_at, PROCESSED_SUBJECT_NAMES)
@interactive_gym/server/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add completion rate and duration aggregation to AdminEventAggregator</name>
  <files>interactive_gym/server/admin/aggregator.py</files>
  <action>
Extend `AdminEventAggregator` to track and compute summary statistics:

1. Add instance variables to track session completion times:
   - `_completed_sessions: dict[str, dict]` mapping subject_id to {started_at, completed_at}
   - Track when subjects are added to processed_subjects list

2. Add method `record_session_completion(subject_id: str, started_at: float, completed_at: float)`:
   - Store completion data for duration calculation
   - Called when a participant finishes (enters PROCESSED_SUBJECT_NAMES)

3. Extend `get_experiment_snapshot()` summary dict to include:
   - `total_started`: Count of all participants who ever connected (len of participant_sessions + len of completed_sessions not in participant_sessions)
   - `completion_rate`: completed_count / total_started as percentage (0 if no participants)
   - `avg_session_duration_ms`: Average of (completed_at - started_at) for all completed sessions, or null if none completed

4. Track session start time from `ParticipantSession.created_at` when logging completion.

Note: The `processed_subjects` list is passed by reference in __init__, so we can compute completed_count from len(self.processed_subjects). For total_started, we need to track unique subject_ids that have ever connected (union of current sessions + completed).
  </action>
  <verify>
Run Python to import the module without errors:
```
cd /Users/chasemcd/Repositories/interactive-gym && python -c "from interactive_gym.server.admin.aggregator import AdminEventAggregator; print('OK')"
```
  </verify>
  <done>
AdminEventAggregator.get_experiment_snapshot() returns summary with:
- total_started (integer)
- completion_rate (float 0-100, or 0 if no participants)
- avg_session_duration_ms (integer milliseconds, or null if no completions)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add completion rate and duration display to dashboard UI</name>
  <files>
    interactive_gym/server/admin/templates/dashboard.html
    interactive_gym/server/admin/static/admin.js
    interactive_gym/server/admin/static/admin.css
  </files>
  <action>
Update the dashboard to display the new summary metrics:

**In dashboard.html:**
1. Replace the current 4-card stat grid with a 5-card grid (or 2-row layout):
   - Keep: Active, Waiting, In Game, Completed
   - Add: "Completion Rate" card showing "X of Y (Z%)"
   - Add: "Avg Duration" card showing formatted duration

2. Add new stat cards after the existing ones:
   ```html
   <!-- Completion Rate -->
   <div class="stat-card">
     <div class="stat-card-icon bg-accent/10 text-accent">
       <!-- checkmark icon -->
     </div>
     <div class="stat-card-content">
       <div class="stat-card-value" id="stat-completion">0 of 0</div>
       <div class="stat-card-label">Completed</div>
     </div>
   </div>

   <!-- Avg Duration -->
   <div class="stat-card">
     <div class="stat-card-icon bg-secondary/10 text-secondary">
       <!-- clock icon -->
     </div>
     <div class="stat-card-content">
       <div class="stat-card-value" id="stat-avg-duration">--</div>
       <div class="stat-card-label">Avg Duration</div>
     </div>
   </div>
   ```

3. Update grid to accommodate 6 cards: `grid-cols-2 md:grid-cols-3 lg:grid-cols-6`

**In admin.js:**
1. Update `updateSummaryStats(summary)` function to:
   - Update `stat-completion` with format: "X of Y (Z%)" where X=completed_count, Y=total_started, Z=completion_rate
   - Update `stat-avg-duration` with human-readable duration (use existing formatDuration helper, or create formatDurationLong for mm:ss or hh:mm:ss)
   - Handle null avg_session_duration_ms by showing "--"

2. Add `formatDurationLong(ms)` helper that formats as:
   - Under 1 minute: "Xs" (e.g., "45s")
   - 1-60 minutes: "Xm Ys" (e.g., "5m 30s")
   - Over 60 minutes: "Xh Ym" (e.g., "1h 15m")

**In admin.css:**
1. Ensure stat-card styling works with 6-column grid on large screens
2. Add any needed responsive adjustments for the additional cards
  </action>
  <verify>
1. Start the dev server and navigate to /admin/
2. Verify new stat cards appear in the grid
3. Check responsive layout at different viewport widths
  </verify>
  <done>
- Dashboard shows "X of Y (Z%)" completion rate at top
- Dashboard shows formatted average session duration at top
- Layout remains clean and readable on desktop and mobile
- Stats update in real-time via SocketIO state_update events
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire completion tracking in app.py</name>
  <files>interactive_gym/server/app.py</files>
  <action>
Connect the session completion tracking to the aggregator:

1. In the code that adds subjects to `PROCESSED_SUBJECT_NAMES` (around line 546 in `advance_scene` when reaching end scene), call:
   ```python
   if ADMIN_AGGREGATOR:
       session = PARTICIPANT_SESSIONS.get(subject_id)
       if session:
           ADMIN_AGGREGATOR.record_session_completion(
               subject_id=subject_id,
               started_at=session.created_at,
               completed_at=time.time()
           )
   ```

2. Also track in the aggregator's __init__ any subjects already in processed_subjects on startup (edge case for server restart with existing data).

Note: The existing `completed_count` in aggregator already reads from `self.processed_subjects` which is the same reference as `PROCESSED_SUBJECT_NAMES`, so the count will auto-update. We just need to capture the timing data for duration calculation.
  </action>
  <verify>
1. Run a test participant through the experiment to completion
2. Check admin dashboard shows updated completion stats
3. Verify avg duration is calculated correctly
  </verify>
  <done>
- Session completion times are recorded when participants finish
- Completion rate updates in real-time as participants complete
- Average duration is calculated from actual session data
  </done>
</task>

</tasks>

<verification>
1. **Completion Rate Display (DASH-01):**
   - Start fresh experiment with no participants
   - Dashboard shows "0 of 0 (0%)"
   - Connect a participant, advance through scenes
   - Dashboard shows "0 of 1 (0%)" while in progress
   - Complete experiment
   - Dashboard shows "1 of 1 (100%)"

2. **Average Duration (DASH-02):**
   - With no completed sessions, shows "--"
   - After first completion, shows actual duration
   - After multiple completions, shows average

3. **Prominent Placement (DASH-03):**
   - Stats appear in top stat card grid
   - Visible without scrolling on standard viewport
   - Readable on mobile with appropriate responsive layout

4. **Real-time Updates:**
   - Open admin dashboard in one browser
   - Complete a session in another
   - Dashboard updates without manual refresh
</verification>

<success_criteria>
- [ ] DASH-01: Dashboard displays "X of Y participants completed (Z%)"
- [ ] DASH-02: Dashboard displays average session duration (formatted nicely)
- [ ] DASH-03: Summary stats appear prominently at top of admin page
- [ ] Stats update in real-time via SocketIO without page refresh
- [ ] Clean UI that matches existing dashboard aesthetic
</success_criteria>

<output>
After completion, create `.planning/phases/32-dashboard-summary/32-01-SUMMARY.md`
</output>
