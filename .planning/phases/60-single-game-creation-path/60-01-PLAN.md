---
phase: 60-single-game-creation-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/server/game_manager.py
  - interactive_gym/server/app.py
  - interactive_gym/scenes/gym_scene.py
  - interactive_gym/server/admin/aggregator.py
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "All games are created through matchmaker.find_match() -> match -> create game path"
    - "No games created through group reunion path"
    - "Group reunion documented as future matchmaker variant (REUN-01/REUN-02)"
    - "wait_for_known_group=True logs warning but does not break existing configs"
  artifacts:
    - path: "interactive_gym/server/game_manager.py"
      provides: "Single game creation path through matchmaker"
      removed:
        - "_join_or_wait_for_group method"
        - "_create_game_for_group method"
        - "_broadcast_group_waiting_status method"
        - "remove_from_group_waitroom method"
        - "check_group_wait_timeouts method"
        - "handle_group_wait_timeout method"
        - "group_waitrooms dict"
        - "group_wait_start_times dict"
      preserved:
        - "_add_subject_to_specific_game method (used by matchmaker path)"
    - path: "interactive_gym/server/app.py"
      provides: "Clean disconnect handler without group_waitroom reference"
    - path: ".planning/REQUIREMENTS.md"
      provides: "GAME-01 through GAME-04 marked complete"
  key_links:
    - from: "GameManager.add_subject_to_game"
      to: "GameManager._add_to_fifo_queue"
      via: "Direct call, no conditional branch"
      pattern: "return self._add_to_fifo_queue"
---

<objective>
Consolidate game creation into a single code path through the matchmaker.

Purpose: Currently there are two paths to create games: (1) FIFO matchmaker path and (2) group reunion path. This creates complexity and potential for inconsistent behavior. By removing the group reunion path, all games flow through `matchmaker.find_match()`, making the system easier to maintain and extend.

Output: GameManager with single game creation path, group reunion documented as future matchmaker variant.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-single-game-creation-path/60-RESEARCH.md
@interactive_gym/server/game_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove group reunion code from GameManager</name>
  <files>interactive_gym/server/game_manager.py</files>
  <action>
Remove the group reunion code path and related data structures:

1. **Remove data structures** (lines 108-112):
   - Delete `self.group_waitrooms` dict
   - Delete `self.group_wait_start_times` dict

2. **Simplify add_subject_to_game()** (lines 287-308):
   - Remove the `if self.scene.wait_for_known_group and self.pairing_manager:` branch
   - Update docstring to reflect single path
   - Add deprecation note about group reunion
   - Method should just call `return self._add_to_fifo_queue(subject_id)`
   - Add warning log when `wait_for_known_group=True` to alert users the feature is deferred

3. **Delete group reunion methods** (ONLY these - _add_subject_to_specific_game is shared infrastructure):
   - `_join_or_wait_for_group` (lines 310-364)
   - `_broadcast_group_waiting_status` (lines 366-388)
   - `_create_game_for_group` (lines 390-469)

   **IMPORTANT: DO NOT DELETE `_add_subject_to_specific_game`** - this method is used by the matchmaker path in `_create_game_for_match_internal()` (line 930). It is shared infrastructure, not group-reunion-specific.

4. **Delete group waitroom management methods**:
   - `remove_from_group_waitroom` (lines 1665-1694)
   - `check_group_wait_timeouts` (lines 1696-1709)
   - `handle_group_wait_timeout` (lines 1711-1732)

WHY: The group reunion-specific methods are only reachable through the group reunion path which is being removed. However, `_add_subject_to_specific_game` is shared between group reunion and matchmaker paths, so it must be preserved.
  </action>
  <verify>
    - `grep -n "group_waitrooms\|group_wait_start_times" interactive_gym/server/game_manager.py` returns no results
    - `grep -n "_join_or_wait_for_group\|_create_game_for_group" interactive_gym/server/game_manager.py` returns no results
    - `grep -n "remove_from_group_waitroom\|check_group_wait_timeouts\|handle_group_wait_timeout" interactive_gym/server/game_manager.py` returns no results
    - `grep -n "_add_subject_to_specific_game" interactive_gym/server/game_manager.py` returns results (method preserved for matchmaker)
  </verify>
  <done>GameManager has single game creation path through _add_to_fifo_queue; group reunion-specific code removed; _add_subject_to_specific_game preserved for matchmaker; warning logged when wait_for_known_group=True</done>
</task>

<task type="auto">
  <name>Task 2: Update dependent files</name>
  <files>interactive_gym/server/app.py, interactive_gym/server/admin/aggregator.py, interactive_gym/scenes/gym_scene.py</files>
  <action>
Update files that reference the removed group reunion code:

1. **app.py** (line ~2663):
   - Remove the call to `game_manager.remove_from_group_waitroom(subject_id)` in the disconnect handler
   - The check `if game_manager:` remains, but the group_waitroom line is removed
   - Add a comment noting group reunion is deferred: `# Note: Group reunion deferred to future matchmaker variant (REUN-01/REUN-02)`

2. **admin/aggregator.py** (lines ~906-908 and ~1032-1036):
   - Remove references to `game_manager.group_waitrooms`
   - These are in `_format_game_manager_state()` and `_snapshot_game_manager()` methods
   - Use `hasattr` check to gracefully handle the removed attribute (for backward compatibility during transition)
   - Or simply remove the group_waitrooms sections entirely since they no longer exist

3. **gym_scene.py** - No code changes needed, but:
   - The `wait_for_known_group` property remains (for API compatibility)
   - The `group_wait_timeout` property remains (for API compatibility)
   - Document in the docstrings that these are deferred to future matchmaker variant

WHY: These files reference methods/data structures being removed. They must be updated to prevent runtime errors.
  </action>
  <verify>
    - `grep -n "remove_from_group_waitroom" interactive_gym/server/app.py` returns no results
    - `python -c "from interactive_gym.server import app"` succeeds without import errors
    - `python -c "from interactive_gym.server.admin import aggregator"` succeeds without import errors
  </verify>
  <done>All references to removed group reunion code cleaned up; app.py and aggregator.py import without errors</done>
</task>

<task type="auto">
  <name>Task 3: Update requirements and commit</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
1. **Update REQUIREMENTS.md**:
   - Mark GAME-01 through GAME-04 as complete (change `- [ ]` to `- [x]`)
   - Update the traceability table Status from "Pending" to "Complete" for GAME-01/02/03/04
   - Update the coverage count

2. **Verify all tests pass**:
   - Run `python -m pytest tests/ -x -v --ignore=tests/e2e` to run unit tests
   - Verify no failures related to removed code

3. **Run type check** (if available):
   - `python -m mypy interactive_gym/server/game_manager.py --ignore-missing-imports` or skip if not configured

WHY: Requirements tracking and verification ensure the phase is complete.
  </action>
  <verify>
    - `grep "GAME-01" .planning/REQUIREMENTS.md` shows `- [x]`
    - `grep "GAME-02" .planning/REQUIREMENTS.md` shows `- [x]`
    - `grep "GAME-03" .planning/REQUIREMENTS.md` shows `- [x]`
    - `grep "GAME-04" .planning/REQUIREMENTS.md` shows `- [x]`
  </verify>
  <done>Requirements marked complete; tests pass; phase ready for verification</done>
</task>

</tasks>

<verification>
1. **Single path check**: `add_subject_to_game` only calls `_add_to_fifo_queue`
2. **No dead code**: No group reunion-specific methods exist (but shared infrastructure like `_add_subject_to_specific_game` preserved)
3. **Import check**: All modified files import without errors
4. **Requirements**: GAME-01 through GAME-04 marked complete
</verification>

<success_criteria>
1. GameManager.add_subject_to_game() directly calls _add_to_fifo_queue() without conditional
2. All group reunion-specific methods and data structures removed from GameManager
3. _add_subject_to_specific_game preserved (used by matchmaker path)
4. app.py and aggregator.py have no references to removed code
5. wait_for_known_group=True logs warning but doesn't crash
6. GAME-01, GAME-02, GAME-03, GAME-04 marked complete in REQUIREMENTS.md
7. All imports succeed without errors
</success_criteria>

<output>
After completion, create `.planning/phases/60-single-game-creation-path/60-01-SUMMARY.md`
</output>
