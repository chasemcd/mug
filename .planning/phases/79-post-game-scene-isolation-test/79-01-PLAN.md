---
phase: 79-post-game-scene-isolation-test
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_scene_isolation_test.py
  - tests/conftest.py
  - tests/e2e/test_scene_isolation.py
autonomous: true

must_haves:
  truths:
    - "Two Playwright-controlled players complete an Overcooked game and both advance to the survey scene"
    - "When one player closes their browser on the survey scene, the remaining player does NOT see a partner-disconnected overlay"
    - "The remaining player's survey scene remains functional and interactive"
  artifacts:
    - path: "interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_scene_isolation_test.py"
      provides: "Multi-scene test server config with GymScene -> survey -> end"
      contains: "multiplayer_feedback_scene"
    - path: "tests/e2e/test_scene_isolation.py"
      provides: "E2E test validating post-game scene isolation"
      contains: "test_partner_exit_on_survey_no_overlay"
    - path: "tests/conftest.py"
      provides: "Server fixture for scene isolation test"
      contains: "flask_server_scene_isolation"
  key_links:
    - from: "tests/e2e/test_scene_isolation.py"
      to: "tests/conftest.py"
      via: "flask_server_scene_isolation fixture"
      pattern: "flask_server_scene_isolation"
    - from: "tests/conftest.py"
      to: "interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_scene_isolation_test.py"
      via: "subprocess Popen module path"
      pattern: "overcooked_human_human_multiplayer_scene_isolation_test"
    - from: "tests/e2e/test_scene_isolation.py"
      to: "tests/fixtures/game_helpers.py"
      via: "import game helpers"
      pattern: "from tests.fixtures.game_helpers import"
---

<objective>
Create an E2E test that validates Phase 77's P2P connection scoping works end-to-end: two players complete an Overcooked game, both advance to the survey scene, one player exits, and the remaining player does NOT see a partner-disconnected overlay.

Purpose: This is the capstone validation for v1.19 P2P Lifecycle Cleanup. Phase 77 added `cleanupForSceneExit()` and `sceneExited` guards to scope P2P to GymScene lifetime. This test proves those guards work correctly in a real multi-scene experiment flow.

Output: A passing E2E test (`test_scene_isolation.py`), a multi-scene test server config, and a server fixture.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-p2p-connection-scoping/77-01-SUMMARY.md

Key files to reference:
@interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_test.py (pattern for test server configs)
@tests/conftest.py (pattern for server fixtures)
@tests/e2e/test_multiplayer_basic.py (pattern for E2E test structure)
@tests/fixtures/game_helpers.py (helpers: run_full_episode_flow, click_advance_button, etc.)
@tests/fixtures/network_helpers.py (set_tab_visibility helper)
@interactive_gym/examples/cogrid/scenes/scenes.py (multiplayer_feedback_scene, end_scene definitions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-scene test server config and server fixture</name>
  <files>
    interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_scene_isolation_test.py
    tests/conftest.py
  </files>
  <action>
Create a new test server config file at `interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_scene_isolation_test.py`. Follow the exact pattern of `overcooked_human_human_multiplayer_test.py` but ensure the stager includes multiple scenes that the test will traverse:

```python
stager = stager.Stager(
    scenes=[
        hh_start_scene,       # Instructions (advanceButton)
        (
            oc_scenes.cramped_room_human_human
            .gameplay(num_episodes=1, max_steps=450)  # ~15 seconds per episode
            .matchmaking(max_rtt=None)
            .focus_loss_config(timeout_ms=0, pause_on_partner_background=False)
            .pyodide(input_confirmation_timeout_ms=2000)
        ),
        oc_scenes.multiplayer_feedback_scene,  # Survey scene (this is where isolation is tested)
        oc_scenes.end_scene,
    ]
)
```

This is the SAME scene list as the existing test config (`overcooked_human_human_multiplayer_test.py`). The key point is that `multiplayer_feedback_scene` is a StaticScene (ScalesAndTextBox) that shows after the GymScene completes -- this is the "survey scene" where the test validates isolation.

Use experiment_id `"overcooked_multiplayer_hh_scene_isolation_test"` and the same relaxed entry_screening and webrtc settings as the existing test config.

Then add a new fixture `flask_server_scene_isolation` to `tests/conftest.py`. Use the **function scope** (not module scope) since we want a fresh server for this test. Follow the exact pattern of `flask_server_fresh` but:
- Use port `5707` (next available after 5706)
- Module path: `interactive_gym.examples.cogrid.overcooked_human_human_multiplayer_scene_isolation_test`
- Yield dict with keys: `url`, `process`
  </action>
  <verify>
Run `python -c "import interactive_gym.examples.cogrid.overcooked_human_human_multiplayer_scene_isolation_test"` to verify the config imports without error. Verify the fixture is syntactically valid by running `python -m pytest tests/conftest.py --co -q 2>&1 | head -5` (should not error).
  </verify>
  <done>
New test server config file exists and imports cleanly. Server fixture `flask_server_scene_isolation` exists in conftest.py using port 5707 with function scope.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create E2E scene isolation test</name>
  <files>
    tests/e2e/test_scene_isolation.py
  </files>
  <action>
Create `tests/e2e/test_scene_isolation.py` with a single test: `test_partner_exit_on_survey_no_overlay`.

The test validates all three success criteria for Phase 79. Follow the pattern of `test_multiplayer_basic.py` for structure, imports, and marker usage.

**Test flow:**

1. **Setup**: Use `flask_server_scene_isolation` and `player_contexts` fixtures.

2. **Navigate both players**: `page1.goto(base_url)`, `page2.goto(base_url)`, then `wait_for_socket_connected` for both.

3. **Pass instructions scene**: `click_advance_button(page1)`, `click_advance_button(page2)`.

4. **Start multiplayer GymScene**: `click_start_button(page1)`, `click_start_button(page2)`.

5. **Wait for game start**: `wait_for_game_canvas` and `wait_for_game_object` for both, then `set_tab_visibility(page1, visible=True)` and `set_tab_visibility(page2, visible=True)`.

6. **Wait for episode completion**: `wait_for_episode_complete(page1, episode_num=1, timeout=180000)`, same for page2.

7. **Wait for both players to advance to survey scene**: After the episode completes, the game auto-advances. The survey scene is `multiplayer_feedback_scene` (a ScalesAndTextBox static scene). Both players should see the survey. Wait for the survey scene to load by checking for the scene header text "Multiplayer Feedback" using `wait_for_scene_header_contains(page1, "Feedback", timeout=60000)` and same for page2. This wait confirms both players have exited the GymScene (which triggers `cleanupForSceneExit()`) and are now on the static survey scene.

8. **Verify both players are on survey scene**: Assert that the `#sceneHeader` contains "Feedback" for both pages. Also assert that no partner-disconnected overlay exists on either page yet:
   ```python
   overlay1 = page1.evaluate("() => document.getElementById('partner-disconnected-overlay')?.offsetParent !== null")
   assert not overlay1, "No overlay should exist on page1 before disconnect"
   ```

9. **Close player 2's browser context**: Get the browser context for page2 and close it. This simulates one player exiting. Use `page2.context.close()`. This will sever the socket connection for player 2.

10. **Wait and verify no overlay appears on player 1**: Wait 5 seconds (enough time for any disconnect event to propagate and be processed) using `page1.wait_for_timeout(5000)`. Then assert:
    - No partner-disconnected overlay visible: `page1.evaluate("() => document.getElementById('partner-disconnected-overlay')?.offsetParent !== null")` should be False/None
    - Survey scene is still showing (not replaced by overlay): The `#sceneHeader` should still contain "Feedback"
    - Survey form elements should still be interactive: Check that a scale input or the submit button is still visible/present. Use `page1.locator('.scale-container, .scene-content, #advanceButton').first.is_visible()` or similar to verify the form is still there.

11. **Log success**: Print confirmation that isolation test passed.

**Important details:**
- Use `@pytest.mark.timeout(300)` decorator (5 min max, same as basic multiplayer test)
- Import from `tests.fixtures.game_helpers` and `tests.fixtures.network_helpers` following existing patterns
- The `partner-disconnected-overlay` is an element that `_showPartnerDisconnectedOverlay()` creates dynamically. If it does not exist in the DOM, `document.getElementById` returns null, and we check that. If Phase 77's guards work correctly, `_handleReconnectionGameEnd` will return early due to `sceneExited === true`, so the overlay is never created.
- Also check via console logs: Before closing page2, inject a console listener on page1 to capture any console output containing "partner" or "disconnected" or "p2p_game_ended":
  ```python
  console_messages = []
  page1.on("console", lambda msg: console_messages.append(msg.text) if any(kw in msg.text.lower() for kw in ["partner", "disconnected", "p2p_game_ended", "scene already exited"]) else None)
  ```
  After the 5-second wait, log the captured messages for debugging. If `sceneExited` guard is working, you should see a log like "Ignoring p2p_game_ended - scene already exited" (from `_handleReconnectionGameEnd`).
  </action>
  <verify>
Run the test with:
```bash
python -m pytest tests/e2e/test_scene_isolation.py -v --headed -x --timeout=300
```
The test should pass. The key assertion is that no partner-disconnected overlay appears on page1 after page2's context is closed.
  </verify>
  <done>
Test `test_partner_exit_on_survey_no_overlay` passes: two players complete Overcooked, advance to survey, one exits, remaining player sees no overlay and survey remains functional.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/e2e/test_scene_isolation.py -v --headed -x --timeout=300` passes
2. No partner-disconnected overlay appears on remaining player after partner exits on survey scene
3. Survey scene remains functional (form elements visible, page not replaced by overlay)
4. Console logs confirm `sceneExited` guard is active (should see "Ignoring p2p_game_ended - scene already exited" message)
</verification>

<success_criteria>
- Test file exists at `tests/e2e/test_scene_isolation.py` with `test_partner_exit_on_survey_no_overlay`
- Test server config exists at `interactive_gym/examples/cogrid/overcooked_human_human_multiplayer_scene_isolation_test.py`
- Server fixture `flask_server_scene_isolation` exists in `tests/conftest.py`
- Running `pytest tests/e2e/test_scene_isolation.py --headed -v` passes with the test completing in under 5 minutes
- The test validates all three Phase 79 success criteria: game completion + no overlay on survey + survey remains functional
</success_criteria>

<output>
After completion, create `.planning/phases/79-post-game-scene-isolation-test/79-01-SUMMARY.md`
</output>
