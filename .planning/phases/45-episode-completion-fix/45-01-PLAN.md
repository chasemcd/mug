---
phase: 45-episode-completion-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/fixtures/game_helpers.py
  - tests/e2e/test_multiplayer_basic.py
  - tests/e2e/test_latency_injection.py
  - tests/e2e/test_data_comparison.py
  - tests/e2e/test_network_disruption.py
autonomous: false

must_haves:
  truths:
    - "Games progress through frames (frame counter increments from 0)"
    - "Episodes complete within test timeout (180s)"
    - "At least one E2E test runs to completion without timeout"
  artifacts:
    - path: "tests/fixtures/game_helpers.py"
      provides: "Shared visibility override in run_full_episode_flow_until_gameplay()"
      contains: "set_tab_visibility"
    - path: "tests/e2e/test_multiplayer_basic.py"
      provides: "Fixed test flow without obsolete tutorial calls"
      min_lines: 100
  key_links:
    - from: "tests/fixtures/game_helpers.py"
      to: "tests/fixtures/network_helpers.py"
      via: "import set_tab_visibility"
      pattern: "from tests\\.fixtures\\.network_helpers import.*set_tab_visibility"
---

<objective>
Fix E2E tests so games progress through frames to episode completion.

Purpose: Without this fix, all E2E tests timeout because `document.hidden` is `true` in Playwright, causing FocusManager to skip all frame processing.

Output: Working E2E test infrastructure where games advance frames and complete episodes within the 180s timeout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-episode-completion-fix/45-RESEARCH.md

# Key source files
@tests/fixtures/game_helpers.py
@tests/fixtures/network_helpers.py
@tests/e2e/test_multiplayer_basic.py
@tests/e2e/test_latency_injection.py
@tests/e2e/test_data_comparison.py
@tests/e2e/test_network_disruption.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility override to shared helper and fix test flows</name>
  <files>
    tests/fixtures/game_helpers.py
    tests/e2e/test_multiplayer_basic.py
    tests/e2e/test_latency_injection.py
    tests/e2e/test_data_comparison.py
    tests/e2e/test_network_disruption.py
  </files>
  <action>
**Root cause:** In Playwright, `document.hidden` is `true` by default. The game's FocusManager checks this and skips all frame processing when backgrounded.

**Fix approach:** Call `set_tab_visibility(page, True)` after game object initializes.

**1. tests/fixtures/game_helpers.py:**
- Add import: `from tests.fixtures.network_helpers import set_tab_visibility`
- In `run_full_episode_flow_until_gameplay()`, add visibility override AFTER both `wait_for_game_object()` calls:
  ```python
  # CRITICAL: Override document.hidden for Playwright
  # Without this, FocusManager thinks tab is backgrounded and skips frame processing
  set_tab_visibility(page1, visible=True)
  set_tab_visibility(page2, visible=True)
  ```

**2. tests/e2e/test_multiplayer_basic.py:**
- Remove `complete_tutorial_and_advance` from imports (tutorial scene removed in commit 607b60a)
- In `test_two_players_connect_and_complete_episode()`:
  - Remove the two `complete_tutorial_and_advance()` calls (lines 59-60)
  - After `wait_for_game_object()` calls, add visibility override:
    ```python
    # Override visibility for Playwright automation
    from tests.fixtures.network_helpers import set_tab_visibility
    set_tab_visibility(page1, visible=True)
    set_tab_visibility(page2, visible=True)
    ```
- In `test_matchmaking_pairs_two_players()`:
  - Remove the two `complete_tutorial_and_advance()` calls (lines 124-125)
  - After `wait_for_game_object()` calls, add same visibility override

**3. tests/e2e/test_latency_injection.py:**
- Remove `complete_tutorial_and_advance` from imports
- In `run_full_episode_flow()`:
  - Remove the two `complete_tutorial_and_advance()` calls (lines 84-85)
  - After `wait_for_game_object()` calls (lines 97-98), add:
    ```python
    # Override visibility for Playwright automation
    from tests.fixtures.network_helpers import set_tab_visibility
    set_tab_visibility(page1, visible=True)
    set_tab_visibility(page2, visible=True)
    ```

**4. tests/e2e/test_data_comparison.py:**
- Remove `complete_tutorial_and_advance` from imports
- In `run_full_episode_flow()`:
  - Remove the two `complete_tutorial_and_advance()` calls (lines 86-87)
  - After `wait_for_game_object()` calls (lines 98-99), add visibility override

**5. tests/e2e/test_network_disruption.py:**
- Remove `complete_tutorial_and_advance` from imports
- In `test_tab_visibility_triggers_fast_forward()`:
  - Remove the two `complete_tutorial_and_advance()` calls (lines 152-153)
  - After `wait_for_game_object()` calls, add visibility override:
    ```python
    # Override visibility for Playwright automation (essential for frames to advance)
    set_tab_visibility(page1, visible=True)
    set_tab_visibility(page2, visible=True)
    ```
  - NOTE: This test later calls `set_tab_visibility(page1, visible=False)` to test fast-forward. That is intentional and should remain.

**Important:** The visibility override must come AFTER `wait_for_game_object()` because FocusManager doesn't exist until the game initializes.
  </action>
  <verify>
Run one test to verify frames advance:
```bash
cd /Users/chasemcd/Repositories/interactive-gym && python -m pytest tests/e2e/test_multiplayer_basic.py::test_matchmaking_pairs_two_players -v --headed --timeout=120
```
Test should complete within timeout. Check output for `frameNumber > 0` in assertions or logs.
  </verify>
  <done>
- All 5 files modified with visibility override
- No more `complete_tutorial_and_advance` calls in test files
- Test completes without timeout (frames advance)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed E2E test visibility override so games progress through frames</what-built>
  <how-to-verify>
1. Run the full multiplayer episode test:
   ```bash
   cd /Users/chasemcd/Repositories/interactive-gym
   python -m pytest tests/e2e/test_multiplayer_basic.py::test_two_players_connect_and_complete_episode -v --headed --timeout=300
   ```

2. Expected behavior:
   - Two browser windows open (headed mode)
   - Both players navigate through instructions and matchmaking
   - Game canvas appears with Overcooked game
   - Frame numbers increment (visible in console output at test end)
   - Episode completes (numEpisodes >= 1 in final assertions)
   - Test passes within 5 minute timeout

3. Watch for in console output:
   - "Game completed: gameId=..." (success message)
   - "Player 1: episodes=1, frames=XXX" where XXX > 0
   - "Player 2: episodes=1, frames=XXX" where XXX > 0

4. If test fails with timeout, check browser windows - if frames stay at 0 and game appears frozen, the visibility fix is not working.
  </how-to-verify>
  <resume-signal>Type "approved" if test passes, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `test_matchmaking_pairs_two_players` passes (frames advance, game initializes)
2. `test_two_players_connect_and_complete_episode` passes (full episode completion)
3. No `complete_tutorial_and_advance` calls remain in test files
4. All test files import and use `set_tab_visibility` correctly
</verification>

<success_criteria>
- EPFIX-01: Root cause documented (FocusManager + document.hidden in Playwright)
- EPFIX-02: Fix applied (set_tab_visibility override after game init)
- EPFIX-03: At least one test completes full episode within 180s timeout
</success_criteria>

<output>
After completion, create `.planning/phases/45-episode-completion-fix/45-01-SUMMARY.md`
</output>
